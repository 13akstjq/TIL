<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>GraphQL API에서 인증 및 권한 관리하는 방법 | TIL</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://13akstjq.github.io/TIL//post/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="GraphQL API에서 인증 및 권한 관리하는 방법 | TIL" data-gatsby-head="true"/><meta property="og:title" content="GraphQL API에서 인증 및 권한 관리하는 방법 | TIL" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://TIL.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://13akstjq.github.io/TIL//post/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI" data-gatsby-head="true"/><meta name="twitter:title" content="GraphQL API에서 인증 및 권한 관리하는 방법 | TIL" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | TIL" data-gatsby-head="true"/><meta name="article:published_time" content="2024-07-09 20:30" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/TIL/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/TIL/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/TIL/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/TIL/favicons/favicon-96x96.png"/><link rel="icon" href="/TIL/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/TIL/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/TIL/favicons/browserconfig.xml"/><link rel="preload" href="/TIL/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/TIL/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/TIL/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/TIL/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/TIL/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/TIL/_next/static/chunks/webpack-21ffe88bdca56cba.js" defer=""></script><script src="/TIL/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/TIL/_next/static/chunks/main-a5eeabb286676ce6.js" defer=""></script><script src="/TIL/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/TIL/_next/static/chunks/75fc9c18-4a646156c659a948.js" defer=""></script><script src="/TIL/_next/static/chunks/348-02483b66b493dd81.js" defer=""></script><script src="/TIL/_next/static/chunks/pages/post/%5Bslug%5D-8ded8b979ba73586.js" defer=""></script><script src="/TIL/_next/static/N1mNhRlQaHCliEGDvPEpG/_buildManifest.js" defer=""></script><script src="/TIL/_next/static/N1mNhRlQaHCliEGDvPEpG/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/TIL">TIL</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/TIL/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">GraphQL API에서 인증 및 권한 관리하는 방법</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="GraphQL API에서 인증 및 권한 관리하는 방법" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/TIL/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">TIL</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On Jul 9, 2024</span><span class="posts_reading_time__f7YPP">15<!-- --> min read</span></span></div></div></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<p>아래는 작성한 표의 내용이에요.</p>













<table><thead><tr><th>제목</th><th>링크</th></tr></thead><tbody><tr><td>Authentication and authorization</td><td><a href="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png">여기</a></td></tr></tbody></table>
<p>인증(Authentication)과 권한 부여(authorization)는 종종 혼동되지만, 이러한 개념들은 서로 다른 프로세스를 담당하고 있어요. '인증'은 사용자 식별을 결정하며(사용자가 시스템에 로그인되어 있는지 여부), '권한 부여'는 인증된 사용자가 특정 리소스에 액세스할 수 있는지 여부를 나타냅니다. 그래서 보통 인증 단계가 권한 부여 단계를 선행해요. GraphQL에서 인증과 권한 부여는 도전적일 수 있는데 이는 하나의 노출된 HTTP 엔드포인트 (예: /graphql)만 있기 때문이에요. 이 엔드포인트 진입점에서 사용자를 인증할 수는 있지만, 그 구현에서 일부 리소스에 대한 공개 접근 옵션을 포기해야 할 수 있어요. 이 유일한 엔드포인트 진입에서 권한을 부여하는 것은 불가능해요. 왜냐하면 어떤 리소스가 쿼리될 지 모르기 때문이에요.</p>
<p>이 게시물의 영감은 해당 주제에 대한 답변을 찾는 스택오버플로우 질문에서 얻은 거예요. # 애플리케이션 설정</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>저의 텍스트는 Python에서 GraphQL와 REST의 예제 구현을 비교한 내용에 대한 후속 게시물입니다. 따라서 애플리케이션을 설정하는 데 필요한 요구 사항을 찾을 수 있습니다.</p>
<h1>회원 가입 / 로그인</h1>
<p>우선 이메일 및 해싱된 패스워드 속성을 가진 간단한 사용자 모델(User)부터 시작합니다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">Integer</span>, <span class="hljs-title class_">String</span>
<span class="hljs-keyword">from</span> sqlalchemy.<span class="hljs-property">orm</span> <span class="hljs-keyword">import</span> relationship
<span class="hljs-keyword">from</span> db <span class="hljs-keyword">import</span> <span class="hljs-title class_">Base</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_">Base</span>):
    __tablename__ = <span class="hljs-string">"user"</span>

    id = <span class="hljs-title class_">Column</span>(<span class="hljs-title class_">Integer</span>, primary_key=<span class="hljs-title class_">True</span>, autoincrement=<span class="hljs-title class_">True</span>)
    email = <span class="hljs-title class_">Column</span>(<span class="hljs-title class_">String</span>, unique=<span class="hljs-title class_">True</span>)
    password = <span class="hljs-title class_">Column</span>(<span class="hljs-title class_">String</span>)
    table_bookings = <span class="hljs-title function_">relationship</span>(<span class="hljs-string">"TableBooking"</span>)
</code></pre>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>사용자 등록은 이메일과 비밀번호 매개변수를 받아들이고 데이터베이스에 사용자 레코드를 생성하는 SignUp 뮤테이션을 통해 제공됩니다.</p>
<pre><code class="hljs language-js"># api/graphql.<span class="hljs-property">py</span>
<span class="hljs-keyword">import</span> graphene
<span class="hljs-keyword">from</span> service <span class="hljs-keyword">import</span> sign_up

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SignUp</span>(graphene.<span class="hljs-property">Mutation</span>):
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Arguments</span>:
        email = graphene.<span class="hljs-title class_">String</span>(required=<span class="hljs-title class_">True</span>)
        password = graphene.<span class="hljs-title class_">String</span>(required=<span class="hljs-title class_">True</span>)

   user = graphene.<span class="hljs-title class_">Field</span>(<span class="hljs-title class_">UserNode</span>)

   def <span class="hljs-title function_">mutate</span>(self, info, <span class="hljs-attr">email</span>: str, <span class="hljs-attr">password</span>: str):
        session = info.<span class="hljs-property">context</span>[<span class="hljs-string">"session"</span>]
        user = <span class="hljs-title function_">sign_up</span>(session, email, password)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">SignUp</span>(user=user)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mutation</span>(graphene.<span class="hljs-property">ObjectType</span>):
    sign_up = <span class="hljs-title class_">SignUp</span>.<span class="hljs-title class_">Field</span>()

# service.<span class="hljs-property">py</span>
<span class="hljs-keyword">from</span> auth <span class="hljs-keyword">import</span> generate_password_hash

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAlreadyExist</span>(<span class="hljs-title class_">Exception</span>):
    pass

def <span class="hljs-title function_">sign_up</span>(<span class="hljs-attr">session</span>: <span class="hljs-title class_">Session</span>, <span class="hljs-attr">email</span>: str, password) -> <span class="hljs-title class_">User</span>:
    <span class="hljs-keyword">if</span> session.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">User</span>).<span class="hljs-title function_">filter_by</span>(email=email).<span class="hljs-title function_">first</span>():
        raise <span class="hljs-title class_">UserAlreadyExist</span>()
    user = <span class="hljs-title class_">User</span>(email=email, password=<span class="hljs-title function_">generate_password_hash</span>(password))
    session.<span class="hljs-title function_">add</span>(user)
    session.<span class="hljs-title function_">commit</span>()
    <span class="hljs-keyword">return</span> user

# auth.<span class="hljs-property">py</span>
<span class="hljs-keyword">import</span> hashlib

<span class="hljs-variable constant_">SALT</span> = <span class="hljs-string">"STRONg@Salt"</span>

def <span class="hljs-title function_">generate_password_hash</span>(<span class="hljs-attr">password</span>: str) -> <span class="hljs-attr">str</span>:
    h = hashlib.<span class="hljs-title function_">md5</span>(f<span class="hljs-string">"{password}{SALT}"</span>.<span class="hljs-title function_">encode</span>())
    <span class="hljs-keyword">return</span> h.<span class="hljs-title function_">hexdigest</span>()
</code></pre>
<p>뮤테이션은 /graphql 엔드포인트에서 POST 요청을 통해 실행됩니다. GraphQL에 대한 이전 게시물과 같이 insomnia를 사용하여 HTTP 요청을 수행합니다.</p>
<p><img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_1.png" alt="이미지"></p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>사용자 인스턴스가 생성되면 올바른 자격 증명이 전달되면 사용자 인증 JWT 토큰을 생성하는 SignIn 뮤테이션이 필요합니다.</p>
<pre><code class="hljs language-js"># api/graphql.<span class="hljs-property">py</span>
<span class="hljs-keyword">import</span> graphene
<span class="hljs-keyword">from</span> service <span class="hljs-keyword">import</span> sign_in

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SignIn</span>(graphene.<span class="hljs-property">Mutation</span>):
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Arguments</span>:
        email = graphene.<span class="hljs-title class_">String</span>(required=<span class="hljs-title class_">True</span>)
        password = graphene.<span class="hljs-title class_">String</span>(required=<span class="hljs-title class_">True</span>)

   token = graphene.<span class="hljs-title class_">String</span>()

   def <span class="hljs-title function_">mutate</span>(self, info, <span class="hljs-attr">email</span>: str, <span class="hljs-attr">password</span>: str):
        session = info.<span class="hljs-property">context</span>[<span class="hljs-string">"session"</span>]
        token = <span class="hljs-title function_">sign_in</span>(session, email, password)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">SignIn</span>(token=token)

   <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mutation</span>(graphene.<span class="hljs-property">ObjectType</span>):
        sign_in = <span class="hljs-title class_">SignIn</span>.<span class="hljs-title class_">Field</span>()

# service.<span class="hljs-property">py</span>
<span class="hljs-keyword">from</span> sqlalchemy.<span class="hljs-property">orm</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Session</span>
<span class="hljs-keyword">from</span> auth <span class="hljs-keyword">import</span> generate_token, verify_password
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> <span class="hljs-title class_">User</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAuthenticationError</span>(<span class="hljs-title class_">Exception</span>):
    pass

def <span class="hljs-title function_">sign_in</span>(<span class="hljs-attr">session</span>: <span class="hljs-title class_">Session</span>, <span class="hljs-attr">email</span>: str, password) -> <span class="hljs-attr">str</span>:
    user = session.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">User</span>).<span class="hljs-title function_">filter_by</span>(email=email).<span class="hljs-title function_">first</span>()
    <span class="hljs-keyword">if</span> not <span class="hljs-attr">user</span>:
        raise <span class="hljs-title class_">UserAuthenticationError</span>()
    <span class="hljs-keyword">if</span> not <span class="hljs-title function_">verify_password</span>(user, password):
        raise <span class="hljs-title class_">UserAuthenticationError</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">generate_token</span>(user)

# auth.<span class="hljs-property">py</span>
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> <span class="hljs-title class_">TimedJSONWebSignatureSerializer</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Serializer</span>
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> <span class="hljs-title class_">User</span>

<span class="hljs-variable constant_">SALT</span> = <span class="hljs-string">"STRONg@Salt"</span>
<span class="hljs-variable constant_">SECRET_KEY</span> = <span class="hljs-string">"!SECRET!"</span>
<span class="hljs-variable constant_">TOKEN_EXPIRES_IN</span> = <span class="hljs-number">3600</span> * <span class="hljs-number">24</span> * <span class="hljs-number">30</span>

def <span class="hljs-title function_">generate_password_hash</span>(<span class="hljs-attr">password</span>: str) -> <span class="hljs-attr">str</span>:
    h = hashlib.<span class="hljs-title function_">md5</span>(f<span class="hljs-string">"{password}{SALT}"</span>.<span class="hljs-title function_">encode</span>())
    <span class="hljs-keyword">return</span> h.<span class="hljs-title function_">hexdigest</span>()

def <span class="hljs-title function_">verify_password</span>(<span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span>, <span class="hljs-attr">password</span>: str) -> <span class="hljs-attr">bool</span>:
    <span class="hljs-keyword">return</span> user.<span class="hljs-property">password</span> == <span class="hljs-title function_">generate_password_hash</span>(password)

def <span class="hljs-title function_">generate_token</span>(<span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span>) -> <span class="hljs-attr">str</span>:
    serializer = <span class="hljs-title class_">Serializer</span>(<span class="hljs-variable constant_">SECRET_KEY</span>, expires_in=<span class="hljs-variable constant_">TOKEN_EXPIRES_IN</span>)
    <span class="hljs-keyword">return</span> serializer.<span class="hljs-title function_">dumps</span>({<span class="hljs-string">"user_id"</span>: user.<span class="hljs-property">id</span>}).<span class="hljs-title function_">decode</span>(<span class="hljs-string">"utf-8"</span>)
</code></pre>
<p>SignIn 뮤테이션을 위해 이메일과 비밀번호를 전달하고 인증이 필요한 요청에서 사용할 수 있는 토큰을 페이로드로 받습니다.</p>
<p><img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_2.png" alt="이미지"></p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>인증</h1>
<p>SignIn 단계에서 생성된 토큰이 있으므로 "Bearer Authentication" 프로세스에서 사용할 수 있습니다. 이러한 유형의 인증에서는 유효한 토큰(베어러)을 가진 모든 사용자가 해당 토큰에 해당하는 사용자로 인식될 수 있습니다. 각 GraphQL 필드 리졸버에 사용할 수 있는 sign_in_required 데코레이터를 정의합니다. 이 데코레이터는 "Authorization" 요청 헤더에서 토큰을 가져와 해독하여 user_id를 얻은 다음, user_id에 해당하는 User가 있는지 확인합니다. 성공적으로 완료되면 인증된 User가 됩니다.</p>
<pre><code class="hljs language-js"># api/graphql.<span class="hljs-property">py</span>

<span class="hljs-keyword">import</span> graphene
<span class="hljs-keyword">from</span> api.<span class="hljs-property">auth</span> <span class="hljs-keyword">import</span> sign_in_required

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Query</span>(graphene.<span class="hljs-property">ObjectType</span>):
    up = graphene.<span class="hljs-title class_">Boolean</span>()
    restaurants = graphene.<span class="hljs-property">relay</span>.<span class="hljs-title class_">ConnectionField</span>(
        <span class="hljs-title class_">RestaurantConnection</span>, q=graphene.<span class="hljs-title class_">String</span>()
    )
    me = graphene.<span class="hljs-title class_">Field</span>(<span class="hljs-title class_">UserNode</span>)

    def <span class="hljs-title function_">resolve_up</span>(root, info, **kwargs):
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">True</span>

    @<span class="hljs-title function_">sign_in_required</span>()
    def <span class="hljs-title function_">resolve_restaurants</span>(root, info, **kwargs):
        query = <span class="hljs-title function_">get_restaurants</span>(
            info.<span class="hljs-property">context</span>[<span class="hljs-string">"session"</span>], search=kwargs.<span class="hljs-title function_">get</span>(<span class="hljs-string">"q"</span>), limit=kwargs.<span class="hljs-title function_">get</span>(<span class="hljs-string">"first"</span>)
        )
        <span class="hljs-keyword">return</span> [<span class="hljs-title class_">RestaurantNode</span>(id=r.<span class="hljs-property">id</span>, name=r.<span class="hljs-property">name</span>) <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> query]

    @<span class="hljs-title function_">sign_in_required</span>()
    def <span class="hljs-title function_">resolve_me</span>(root, info, **kwargs):
        <span class="hljs-keyword">return</span> kwargs[<span class="hljs-string">"current_user"</span>]

# api/auth.<span class="hljs-property">py</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> auth <span class="hljs-keyword">import</span> get_user_by_token
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> <span class="hljs-title class_">User</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnauthenticatedUser</span>(<span class="hljs-title class_">Exception</span>):
    pass

def <span class="hljs-title function_">sign_in_required</span>():
    def <span class="hljs-title function_">decorator</span>(func):
        @<span class="hljs-title function_">wraps</span>(func)
        def <span class="hljs-title function_">wrapper</span>(root, info, *args, **kwargs):
            kwargs[<span class="hljs-string">"current_user"</span>] = <span class="hljs-title function_">get_current_user</span>(info.<span class="hljs-property">context</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">func</span>(root, info, *args, **kwargs)
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

def <span class="hljs-title function_">get_current_user</span>(context) -> <span class="hljs-title class_">User</span>:
    <span class="hljs-attr">try</span>:
        token = <span class="hljs-title function_">get_token_from_request</span>(context[<span class="hljs-string">"request"</span>])
        user = <span class="hljs-title function_">get_user_by_token</span>(context[<span class="hljs-string">"session"</span>], token)
        <span class="hljs-keyword">if</span> not <span class="hljs-attr">user</span>:
            raise <span class="hljs-title class_">UnauthenticatedUser</span>(<span class="hljs-string">"UnauthenticatedUser"</span>)
        <span class="hljs-keyword">return</span> user
    except <span class="hljs-title class_">KeyError</span>:
        raise <span class="hljs-title class_">UnauthenticatedUser</span>(<span class="hljs-string">"UnauthenticatedUser"</span>)

def <span class="hljs-title function_">get_token_from_request</span>(request) -> <span class="hljs-attr">str</span>:
    header = request.<span class="hljs-property">headers</span>[<span class="hljs-string">"Authorization"</span>]
    token = header.<span class="hljs-title function_">replace</span>(<span class="hljs-string">"Bearer "</span>, <span class="hljs-string">""</span>, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> token

# auth.<span class="hljs-property">py</span>
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-title class_">Optional</span>
<span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> <span class="hljs-title class_">TimedJSONWebSignatureSerializer</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Serializer</span>
<span class="hljs-keyword">from</span> sqlalchemy.<span class="hljs-property">orm</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Session</span>
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> <span class="hljs-title class_">User</span>

<span class="hljs-variable constant_">SECRET_KEY</span> = <span class="hljs-string">"!SECRET!"</span>
<span class="hljs-variable constant_">TOKEN_EXPIRES_IN</span> = <span class="hljs-number">3600</span> * <span class="hljs-number">24</span> * <span class="hljs-number">30</span>

def <span class="hljs-title function_">get_user_by_token</span>(<span class="hljs-attr">session</span>: <span class="hljs-title class_">Session</span>, <span class="hljs-attr">token</span>: str) -> <span class="hljs-title class_">Optional</span>[<span class="hljs-title class_">User</span>]:
    serializer = <span class="hljs-title class_">Serializer</span>(<span class="hljs-variable constant_">SECRET_KEY</span>, expires_in=<span class="hljs-variable constant_">TOKEN_EXPIRES_IN</span>)
    data = serializer.<span class="hljs-title function_">loads</span>(token)
    <span class="hljs-keyword">return</span> session.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">User</span>).<span class="hljs-title function_">get</span>(data[<span class="hljs-string">"user_id"</span>])
</code></pre>
<p>up 필드는 공개 액세스이므로 쿼리를 위해 자격 증명을 전달할 필요가 없습니다. 한편, me 필드는 sign_in_required로 데코레이트되었으므로 적절한 토큰을 전달해야 해결할 수 있습니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p><img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_3.png" alt="이미지"></p>
<p><img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_4.png" alt="이미지"></p>
<p>"Authorization" 헤더에 토큰을 전달하지 않고 sign_in_required로 표시된 필드에 접근하면 UnauthenticatedUser 예외가 발생합니다.</p>
<p><img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_5.png" alt="이미지"></p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>인가</h1>
<p>쿼리를 인증하여 로그인한 사용자만 액세스할 수 있도록 제한하는 방법을 살펴보았습니다. 그러나 사용자가 로그인했지만 수행하는 작업이 허용되지 않는 경우는 어떻게 할까요? 예를 들어, 예약한 레스토랑 테이블이 있으며 사용자가 인증되었을 때 허용되어야 하는 경우와 테이블 예약을 취소해야 하는 경우와 같이 사용자가 이전에 생성한 예약만 취소할 수 있는 경우가 있습니다.</p>
<p>우리는 두 가지 작업을 구현했습니다:</p>
<ul>
<li>사용자가 인증되었을 때 허용되어야 하는 BookRestaurantTable 뮤테이션,</li>
<li>취소되어야 하는 TableBooking을 취소하는 CancelTableBooking 뮤테이션.</li>
</ul>
<p>이를 위해 BookRestaurantTable은 sign_in_required로 데코레이트된 mutate 메서드를 사용하고, CancelTableBooking은 authorize_required로 데코레이트된 새로운 메서드를 사용합니다. 이 데코레이터는 사용자가 인증되었는지 확인하고, table_booking_gid(인스턴스의 전역 ID를 나타내는 값)가 인증된 사용자에 의해 생성된 TableBooking 인스턴스와 일치하는지 확인합니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BookRestaurantTable</span>(graphene.<span class="hljs-property">Mutation</span>):
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Arguments</span>:
        restaurant_gid = graphene.<span class="hljs-title function_">ID</span>(required=<span class="hljs-title class_">True</span>)
        persons = graphene.<span class="hljs-title class_">Int</span>(required=<span class="hljs-title class_">True</span>)

    table_booking = graphene.<span class="hljs-title class_">Field</span>(<span class="hljs-title class_">TableBookingNode</span>)

    @<span class="hljs-title function_">sign_in_required</span>()
    def <span class="hljs-title function_">mutate</span>(self, info, <span class="hljs-attr">restaurant_gid</span>: str, <span class="hljs-attr">persons</span>: int, **kwargs):
        session = info.<span class="hljs-property">context</span>[<span class="hljs-string">"session"</span>]
        current_user = kwargs[<span class="hljs-string">"current_user"</span>]
        _, restaurant_id = <span class="hljs-title function_">from_global_id</span>(restaurant_gid)
        table_booking = <span class="hljs-title function_">book_restaurant_table</span>(
            session, restaurant_id, current_user.<span class="hljs-property">email</span>, persons
        )
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">BookRestaurantTable</span>(
            table_booking=<span class="hljs-title class_">TableBookingNode</span>(
                id=table_booking.<span class="hljs-property">id</span>,
                is_active=table_booking.<span class="hljs-property">is_active</span>,
            )
        )

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CancelTableBooking</span>(graphene.<span class="hljs-property">Mutation</span>):
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Arguments</span>:
        table_booking_gid = graphene.<span class="hljs-title function_">ID</span>(required=<span class="hljs-title class_">True</span>)

    table_booking = graphene.<span class="hljs-title class_">Field</span>(<span class="hljs-title class_">TableBookingNode</span>)

    @<span class="hljs-title function_">authorize_required</span>(<span class="hljs-title class_">TableBooking</span>)
    def <span class="hljs-title function_">mutate</span>(self, info, <span class="hljs-attr">table_booking_gid</span>: str, **kwargs):
        session = info.<span class="hljs-property">context</span>[<span class="hljs-string">"session"</span>]
        table_booking = kwargs[<span class="hljs-string">"instance"</span>]
        <span class="hljs-title function_">cancel_table_booking</span>(session, table_booking)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">CancelTableBooking</span>(
            table_booking=<span class="hljs-title class_">TableBookingNode</span>(
                id=table_booking.<span class="hljs-property">id</span>,
                is_active=table_booking.<span class="hljs-property">is_active</span>,
            )
        )

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mutation</span>(graphene.<span class="hljs-property">ObjectType</span>):
    book_restaurant_table = <span class="hljs-title class_">BookRestaurantTable</span>.<span class="hljs-title class_">Field</span>()
    cancel_table_booking = <span class="hljs-title class_">CancelTableBooking</span>.<span class="hljs-title class_">Field</span>()

# api/auth.<span class="hljs-property">py</span>
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> graphene.<span class="hljs-property">relay</span>.<span class="hljs-property">node</span> <span class="hljs-keyword">import</span> from_global_id
<span class="hljs-keyword">from</span> auth <span class="hljs-keyword">import</span> authorize
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> <span class="hljs-title class_">User</span>

def <span class="hljs-title function_">camel_to_snake</span>(<span class="hljs-attr">name</span>: str) -> <span class="hljs-attr">str</span>:
    <span class="hljs-string">""</span><span class="hljs-string">"CamelCase -> camel_case"</span><span class="hljs-string">""</span>
    <span class="hljs-keyword">return</span> re.<span class="hljs-title function_">sub</span>(r<span class="hljs-string">"(?&#x3C;!^)(?=[A-Z])"</span>, <span class="hljs-string">"_"</span>, name).<span class="hljs-title function_">lower</span>()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnauthorizedAccess</span>(<span class="hljs-title class_">Exception</span>):
    pass

<span class="hljs-keyword">class</span> <span class="hljs-title class_">InstanceNotExist</span>(<span class="hljs-title class_">Exception</span>):
    pass

def <span class="hljs-title function_">authorize_required</span>(model):
    <span class="hljs-string">""</span><span class="hljs-string">"
    We assume that the global id field name of a resource
    follow convention like:
    model_name: `TableBooking`
    global id field name: `table_booking_gid`
    "</span><span class="hljs-string">""</span>
    def <span class="hljs-title function_">decorator</span>(func):
        @<span class="hljs-title function_">wraps</span>(func)
        def <span class="hljs-title function_">wrapper</span>(root, info, *args, **kwargs):
            kwargs[<span class="hljs-string">"current_user"</span>] = <span class="hljs-title function_">get_current_user</span>(info.<span class="hljs-property">context</span>)
            model_name = model.<span class="hljs-property">__name__</span>
            gid_field_name = f<span class="hljs-string">"{camel_to_snake(model_name)}_gid"</span>
            instance_gid = kwargs[gid_field_name]
            instance_model_name, instance_id = <span class="hljs-title function_">from_global_id</span>(instance_gid)
            <span class="hljs-keyword">if</span> instance_model_name != f<span class="hljs-string">"{model_name}Node"</span>:
                raise <span class="hljs-title class_">UnauthorizedAccess</span>(<span class="hljs-string">"UnauthorizedAccess"</span>)
            instance = info.<span class="hljs-property">context</span>[<span class="hljs-string">"session"</span>].<span class="hljs-title function_">query</span>(model).<span class="hljs-title function_">get</span>(instance_id)
            <span class="hljs-keyword">if</span> not <span class="hljs-attr">instance</span>:
                <span class="hljs-title class_">InstanceNotExist</span>()
            kwargs[<span class="hljs-string">"instance"</span>] = instance
            <span class="hljs-keyword">if</span> not <span class="hljs-title function_">authorize</span>(instance, kwargs[<span class="hljs-string">"current_user"</span>]):
                raise <span class="hljs-title class_">UnauthorizedAccess</span>(<span class="hljs-string">"UnauthorizedAccess"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">func</span>(root, info, *args, **kwargs)
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

# auth.<span class="hljs-property">py</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> singledispatch
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> <span class="hljs-title class_">TableBooking</span>, <span class="hljs-title class_">User</span>

@singledispatch
def <span class="hljs-title function_">authorize</span>(instance, <span class="hljs-attr">current_user</span>: <span class="hljs-title class_">User</span>) -> <span class="hljs-attr">bool</span>:
    raise <span class="hljs-title class_">NotImplementedError</span>

@authorize.<span class="hljs-title function_">register</span>(<span class="hljs-title class_">TableBooking</span>)
def <span class="hljs-title function_">_authorize</span>(<span class="hljs-attr">instance</span>: <span class="hljs-title class_">TableBooking</span>, <span class="hljs-attr">current_user</span>: <span class="hljs-title class_">User</span>) -> <span class="hljs-attr">bool</span>:
    <span class="hljs-keyword">return</span> instance.<span class="hljs-property">user_id</span> == current_user.<span class="hljs-property">id</span>
</code></pre>
<p>BookRestaurantTable을 실행하기 위해 restaurant_gid 및 persons라는 두 가지 필수 인수를 전달해야 합니다. "Authorization" 헤더에 토큰을 추가해야 합니다. Mutation 응답에서는 TableBooking.id를 얻습니다.</p>
<p>이미지가 포함된 파일경로: <code>/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_6.png</code></p>
<p>CancelTableBooking은 BookRestaurantTable 페이로드(TableBooking.id)에서 가져올 수 있는 table_booking_gid만 필요합니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_7.png">
<p>만약 토큰이 주어진 테이블 예약의 소유자와 일치하지 않는 경우, 동작을 수행할 수 없으며, 권한이 없음 예외가 발생합니다.</p>
<img src="/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_8.png">
<h1>결론</h1>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>인증 및 권한 부여 단계를 쿼리와 뮤테이션 모두 위한 방법을 소개했어요. 이 구현은 매우 범용적이며 어떤 Python GraphQL 프로젝트에도 쉽게 통합할 수 있어요. 전체 소스 코드는 여기에서 확인할 수 있어요: <a href="https://github.com/jorzel/service-layer/tree/auth" rel="nofollow" target="_blank">https://github.com/jorzel/service-layer/tree/auth</a>.</p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"GraphQL API에서 인증 및 권한 관리하는 방법","description":"","date":"2024-07-09 20:30","slug":"2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI","content":"\n아래는 작성한 표의 내용이에요.\n\n| 제목                             | 링크                                                                                           |\n| -------------------------------- | ---------------------------------------------------------------------------------------------- |\n| Authentication and authorization | [여기](/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png) |\n\n인증(Authentication)과 권한 부여(authorization)는 종종 혼동되지만, 이러한 개념들은 서로 다른 프로세스를 담당하고 있어요. '인증'은 사용자 식별을 결정하며(사용자가 시스템에 로그인되어 있는지 여부), '권한 부여'는 인증된 사용자가 특정 리소스에 액세스할 수 있는지 여부를 나타냅니다. 그래서 보통 인증 단계가 권한 부여 단계를 선행해요. GraphQL에서 인증과 권한 부여는 도전적일 수 있는데 이는 하나의 노출된 HTTP 엔드포인트 (예: /graphql)만 있기 때문이에요. 이 엔드포인트 진입점에서 사용자를 인증할 수는 있지만, 그 구현에서 일부 리소스에 대한 공개 접근 옵션을 포기해야 할 수 있어요. 이 유일한 엔드포인트 진입에서 권한을 부여하는 것은 불가능해요. 왜냐하면 어떤 리소스가 쿼리될 지 모르기 때문이에요.\n\n이 게시물의 영감은 해당 주제에 대한 답변을 찾는 스택오버플로우 질문에서 얻은 거예요. # 애플리케이션 설정\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n저의 텍스트는 Python에서 GraphQL와 REST의 예제 구현을 비교한 내용에 대한 후속 게시물입니다. 따라서 애플리케이션을 설정하는 데 필요한 요구 사항을 찾을 수 있습니다.\n\n# 회원 가입 / 로그인\n\n우선 이메일 및 해싱된 패스워드 속성을 가진 간단한 사용자 모델(User)부터 시작합니다.\n\n```js\nfrom sqlalchemy import Column, Integer, String\nfrom sqlalchemy.orm import relationship\nfrom db import Base\n\nclass User(Base):\n    __tablename__ = \"user\"\n\n    id = Column(Integer, primary_key=True, autoincrement=True)\n    email = Column(String, unique=True)\n    password = Column(String)\n    table_bookings = relationship(\"TableBooking\")\n```\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n사용자 등록은 이메일과 비밀번호 매개변수를 받아들이고 데이터베이스에 사용자 레코드를 생성하는 SignUp 뮤테이션을 통해 제공됩니다.\n\n```js\n# api/graphql.py\nimport graphene\nfrom service import sign_up\n\nclass SignUp(graphene.Mutation):\n    class Arguments:\n        email = graphene.String(required=True)\n        password = graphene.String(required=True)\n\n   user = graphene.Field(UserNode)\n\n   def mutate(self, info, email: str, password: str):\n        session = info.context[\"session\"]\n        user = sign_up(session, email, password)\n        return SignUp(user=user)\n\nclass Mutation(graphene.ObjectType):\n    sign_up = SignUp.Field()\n\n# service.py\nfrom auth import generate_password_hash\n\nclass UserAlreadyExist(Exception):\n    pass\n\ndef sign_up(session: Session, email: str, password) -\u003e User:\n    if session.query(User).filter_by(email=email).first():\n        raise UserAlreadyExist()\n    user = User(email=email, password=generate_password_hash(password))\n    session.add(user)\n    session.commit()\n    return user\n\n# auth.py\nimport hashlib\n\nSALT = \"STRONg@Salt\"\n\ndef generate_password_hash(password: str) -\u003e str:\n    h = hashlib.md5(f\"{password}{SALT}\".encode())\n    return h.hexdigest()\n```\n\n뮤테이션은 /graphql 엔드포인트에서 POST 요청을 통해 실행됩니다. GraphQL에 대한 이전 게시물과 같이 insomnia를 사용하여 HTTP 요청을 수행합니다.\n\n![이미지](/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_1.png)\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n사용자 인스턴스가 생성되면 올바른 자격 증명이 전달되면 사용자 인증 JWT 토큰을 생성하는 SignIn 뮤테이션이 필요합니다.\n\n```js\n# api/graphql.py\nimport graphene\nfrom service import sign_in\n\nclass SignIn(graphene.Mutation):\n    class Arguments:\n        email = graphene.String(required=True)\n        password = graphene.String(required=True)\n\n   token = graphene.String()\n\n   def mutate(self, info, email: str, password: str):\n        session = info.context[\"session\"]\n        token = sign_in(session, email, password)\n        return SignIn(token=token)\n\n   class Mutation(graphene.ObjectType):\n        sign_in = SignIn.Field()\n\n# service.py\nfrom sqlalchemy.orm import Session\nfrom auth import generate_token, verify_password\nfrom models import User\n\nclass UserAuthenticationError(Exception):\n    pass\n\ndef sign_in(session: Session, email: str, password) -\u003e str:\n    user = session.query(User).filter_by(email=email).first()\n    if not user:\n        raise UserAuthenticationError()\n    if not verify_password(user, password):\n        raise UserAuthenticationError()\n    return generate_token(user)\n\n# auth.py\nimport hashlib\nfrom itsdangerous import TimedJSONWebSignatureSerializer as Serializer\nfrom models import User\n\nSALT = \"STRONg@Salt\"\nSECRET_KEY = \"!SECRET!\"\nTOKEN_EXPIRES_IN = 3600 * 24 * 30\n\ndef generate_password_hash(password: str) -\u003e str:\n    h = hashlib.md5(f\"{password}{SALT}\".encode())\n    return h.hexdigest()\n\ndef verify_password(user: User, password: str) -\u003e bool:\n    return user.password == generate_password_hash(password)\n\ndef generate_token(user: User) -\u003e str:\n    serializer = Serializer(SECRET_KEY, expires_in=TOKEN_EXPIRES_IN)\n    return serializer.dumps({\"user_id\": user.id}).decode(\"utf-8\")\n```\n\nSignIn 뮤테이션을 위해 이메일과 비밀번호를 전달하고 인증이 필요한 요청에서 사용할 수 있는 토큰을 페이로드로 받습니다.\n\n![이미지](/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_2.png)\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 인증\n\nSignIn 단계에서 생성된 토큰이 있으므로 \"Bearer Authentication\" 프로세스에서 사용할 수 있습니다. 이러한 유형의 인증에서는 유효한 토큰(베어러)을 가진 모든 사용자가 해당 토큰에 해당하는 사용자로 인식될 수 있습니다. 각 GraphQL 필드 리졸버에 사용할 수 있는 sign_in_required 데코레이터를 정의합니다. 이 데코레이터는 \"Authorization\" 요청 헤더에서 토큰을 가져와 해독하여 user_id를 얻은 다음, user_id에 해당하는 User가 있는지 확인합니다. 성공적으로 완료되면 인증된 User가 됩니다.\n\n```js\n# api/graphql.py\n\nimport graphene\nfrom api.auth import sign_in_required\n\nclass Query(graphene.ObjectType):\n    up = graphene.Boolean()\n    restaurants = graphene.relay.ConnectionField(\n        RestaurantConnection, q=graphene.String()\n    )\n    me = graphene.Field(UserNode)\n\n    def resolve_up(root, info, **kwargs):\n        return True\n\n    @sign_in_required()\n    def resolve_restaurants(root, info, **kwargs):\n        query = get_restaurants(\n            info.context[\"session\"], search=kwargs.get(\"q\"), limit=kwargs.get(\"first\")\n        )\n        return [RestaurantNode(id=r.id, name=r.name) for r in query]\n\n    @sign_in_required()\n    def resolve_me(root, info, **kwargs):\n        return kwargs[\"current_user\"]\n\n# api/auth.py\nfrom functools import wraps\nfrom auth import get_user_by_token\nfrom models import User\n\nclass UnauthenticatedUser(Exception):\n    pass\n\ndef sign_in_required():\n    def decorator(func):\n        @wraps(func)\n        def wrapper(root, info, *args, **kwargs):\n            kwargs[\"current_user\"] = get_current_user(info.context)\n            return func(root, info, *args, **kwargs)\n        return wrapper\n    return decorator\n\ndef get_current_user(context) -\u003e User:\n    try:\n        token = get_token_from_request(context[\"request\"])\n        user = get_user_by_token(context[\"session\"], token)\n        if not user:\n            raise UnauthenticatedUser(\"UnauthenticatedUser\")\n        return user\n    except KeyError:\n        raise UnauthenticatedUser(\"UnauthenticatedUser\")\n\ndef get_token_from_request(request) -\u003e str:\n    header = request.headers[\"Authorization\"]\n    token = header.replace(\"Bearer \", \"\", 1)\n    return token\n\n# auth.py\nimport hashlib\nfrom typing import Optional\nfrom itsdangerous import TimedJSONWebSignatureSerializer as Serializer\nfrom sqlalchemy.orm import Session\nfrom models import User\n\nSECRET_KEY = \"!SECRET!\"\nTOKEN_EXPIRES_IN = 3600 * 24 * 30\n\ndef get_user_by_token(session: Session, token: str) -\u003e Optional[User]:\n    serializer = Serializer(SECRET_KEY, expires_in=TOKEN_EXPIRES_IN)\n    data = serializer.loads(token)\n    return session.query(User).get(data[\"user_id\"])\n```\n\nup 필드는 공개 액세스이므로 쿼리를 위해 자격 증명을 전달할 필요가 없습니다. 한편, me 필드는 sign_in_required로 데코레이트되었으므로 적절한 토큰을 전달해야 해결할 수 있습니다.\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n![이미지](/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_3.png)\n\n![이미지](/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_4.png)\n\n\"Authorization\" 헤더에 토큰을 전달하지 않고 sign_in_required로 표시된 필드에 접근하면 UnauthenticatedUser 예외가 발생합니다.\n\n![이미지](/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_5.png)\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 인가\n\n쿼리를 인증하여 로그인한 사용자만 액세스할 수 있도록 제한하는 방법을 살펴보았습니다. 그러나 사용자가 로그인했지만 수행하는 작업이 허용되지 않는 경우는 어떻게 할까요? 예를 들어, 예약한 레스토랑 테이블이 있으며 사용자가 인증되었을 때 허용되어야 하는 경우와 테이블 예약을 취소해야 하는 경우와 같이 사용자가 이전에 생성한 예약만 취소할 수 있는 경우가 있습니다.\n\n우리는 두 가지 작업을 구현했습니다:\n\n- 사용자가 인증되었을 때 허용되어야 하는 BookRestaurantTable 뮤테이션,\n- 취소되어야 하는 TableBooking을 취소하는 CancelTableBooking 뮤테이션.\n\n이를 위해 BookRestaurantTable은 sign_in_required로 데코레이트된 mutate 메서드를 사용하고, CancelTableBooking은 authorize_required로 데코레이트된 새로운 메서드를 사용합니다. 이 데코레이터는 사용자가 인증되었는지 확인하고, table_booking_gid(인스턴스의 전역 ID를 나타내는 값)가 인증된 사용자에 의해 생성된 TableBooking 인스턴스와 일치하는지 확인합니다.\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\nclass BookRestaurantTable(graphene.Mutation):\n    class Arguments:\n        restaurant_gid = graphene.ID(required=True)\n        persons = graphene.Int(required=True)\n\n    table_booking = graphene.Field(TableBookingNode)\n\n    @sign_in_required()\n    def mutate(self, info, restaurant_gid: str, persons: int, **kwargs):\n        session = info.context[\"session\"]\n        current_user = kwargs[\"current_user\"]\n        _, restaurant_id = from_global_id(restaurant_gid)\n        table_booking = book_restaurant_table(\n            session, restaurant_id, current_user.email, persons\n        )\n        return BookRestaurantTable(\n            table_booking=TableBookingNode(\n                id=table_booking.id,\n                is_active=table_booking.is_active,\n            )\n        )\n\nclass CancelTableBooking(graphene.Mutation):\n    class Arguments:\n        table_booking_gid = graphene.ID(required=True)\n\n    table_booking = graphene.Field(TableBookingNode)\n\n    @authorize_required(TableBooking)\n    def mutate(self, info, table_booking_gid: str, **kwargs):\n        session = info.context[\"session\"]\n        table_booking = kwargs[\"instance\"]\n        cancel_table_booking(session, table_booking)\n        return CancelTableBooking(\n            table_booking=TableBookingNode(\n                id=table_booking.id,\n                is_active=table_booking.is_active,\n            )\n        )\n\nclass Mutation(graphene.ObjectType):\n    book_restaurant_table = BookRestaurantTable.Field()\n    cancel_table_booking = CancelTableBooking.Field()\n\n# api/auth.py\nimport re\nfrom functools import wraps\nfrom graphene.relay.node import from_global_id\nfrom auth import authorize\nfrom models import User\n\ndef camel_to_snake(name: str) -\u003e str:\n    \"\"\"CamelCase -\u003e camel_case\"\"\"\n    return re.sub(r\"(?\u003c!^)(?=[A-Z])\", \"_\", name).lower()\n\nclass UnauthorizedAccess(Exception):\n    pass\n\nclass InstanceNotExist(Exception):\n    pass\n\ndef authorize_required(model):\n    \"\"\"\n    We assume that the global id field name of a resource\n    follow convention like:\n    model_name: `TableBooking`\n    global id field name: `table_booking_gid`\n    \"\"\"\n    def decorator(func):\n        @wraps(func)\n        def wrapper(root, info, *args, **kwargs):\n            kwargs[\"current_user\"] = get_current_user(info.context)\n            model_name = model.__name__\n            gid_field_name = f\"{camel_to_snake(model_name)}_gid\"\n            instance_gid = kwargs[gid_field_name]\n            instance_model_name, instance_id = from_global_id(instance_gid)\n            if instance_model_name != f\"{model_name}Node\":\n                raise UnauthorizedAccess(\"UnauthorizedAccess\")\n            instance = info.context[\"session\"].query(model).get(instance_id)\n            if not instance:\n                InstanceNotExist()\n            kwargs[\"instance\"] = instance\n            if not authorize(instance, kwargs[\"current_user\"]):\n                raise UnauthorizedAccess(\"UnauthorizedAccess\")\n            return func(root, info, *args, **kwargs)\n        return wrapper\n    return decorator\n\n# auth.py\nfrom functools import singledispatch\nfrom models import TableBooking, User\n\n@singledispatch\ndef authorize(instance, current_user: User) -\u003e bool:\n    raise NotImplementedError\n\n@authorize.register(TableBooking)\ndef _authorize(instance: TableBooking, current_user: User) -\u003e bool:\n    return instance.user_id == current_user.id\n```\n\nBookRestaurantTable을 실행하기 위해 restaurant_gid 및 persons라는 두 가지 필수 인수를 전달해야 합니다. \"Authorization\" 헤더에 토큰을 추가해야 합니다. Mutation 응답에서는 TableBooking.id를 얻습니다.\n\n이미지가 포함된 파일경로: `/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_6.png`\n\nCancelTableBooking은 BookRestaurantTable 페이로드(TableBooking.id)에서 가져올 수 있는 table_booking_gid만 필요합니다.\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_7.png\" /\u003e\n\n만약 토큰이 주어진 테이블 예약의 소유자와 일치하지 않는 경우, 동작을 수행할 수 없으며, 권한이 없음 예외가 발생합니다.\n\n\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_8.png\" /\u003e\n\n# 결론\n\n\u003c!-- TIL 수평 --\u003e\n\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n인증 및 권한 부여 단계를 쿼리와 뮤테이션 모두 위한 방법을 소개했어요. 이 구현은 매우 범용적이며 어떤 Python GraphQL 프로젝트에도 쉽게 통합할 수 있어요. 전체 소스 코드는 여기에서 확인할 수 있어요: https://github.com/jorzel/service-layer/tree/auth.\n","ogImage":{"url":"/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png"},"coverImage":"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png","tag":["Tech"],"readingTime":15},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cp\u003e아래는 작성한 표의 내용이에요.\u003c/p\u003e\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003ctable\u003e\u003cthead\u003e\u003ctr\u003e\u003cth\u003e제목\u003c/th\u003e\u003cth\u003e링크\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd\u003eAuthentication and authorization\u003c/td\u003e\u003ctd\u003e\u003ca href=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_0.png\"\u003e여기\u003c/a\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003e인증(Authentication)과 권한 부여(authorization)는 종종 혼동되지만, 이러한 개념들은 서로 다른 프로세스를 담당하고 있어요. '인증'은 사용자 식별을 결정하며(사용자가 시스템에 로그인되어 있는지 여부), '권한 부여'는 인증된 사용자가 특정 리소스에 액세스할 수 있는지 여부를 나타냅니다. 그래서 보통 인증 단계가 권한 부여 단계를 선행해요. GraphQL에서 인증과 권한 부여는 도전적일 수 있는데 이는 하나의 노출된 HTTP 엔드포인트 (예: /graphql)만 있기 때문이에요. 이 엔드포인트 진입점에서 사용자를 인증할 수는 있지만, 그 구현에서 일부 리소스에 대한 공개 접근 옵션을 포기해야 할 수 있어요. 이 유일한 엔드포인트 진입에서 권한을 부여하는 것은 불가능해요. 왜냐하면 어떤 리소스가 쿼리될 지 모르기 때문이에요.\u003c/p\u003e\n\u003cp\u003e이 게시물의 영감은 해당 주제에 대한 답변을 찾는 스택오버플로우 질문에서 얻은 거예요. # 애플리케이션 설정\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e저의 텍스트는 Python에서 GraphQL와 REST의 예제 구현을 비교한 내용에 대한 후속 게시물입니다. 따라서 애플리케이션을 설정하는 데 필요한 요구 사항을 찾을 수 있습니다.\u003c/p\u003e\n\u003ch1\u003e회원 가입 / 로그인\u003c/h1\u003e\n\u003cp\u003e우선 이메일 및 해싱된 패스워드 속성을 가진 간단한 사용자 모델(User)부터 시작합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eColumn\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eInteger\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy.\u003cspan class=\"hljs-property\"\u003eorm\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e relationship\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e db \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBase\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eBase\u003c/span\u003e):\n    __tablename__ = \u003cspan class=\"hljs-string\"\u003e\"user\"\u003c/span\u003e\n\n    id = \u003cspan class=\"hljs-title class_\"\u003eColumn\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eInteger\u003c/span\u003e, primary_key=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e, autoincrement=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n    email = \u003cspan class=\"hljs-title class_\"\u003eColumn\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e, unique=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n    password = \u003cspan class=\"hljs-title class_\"\u003eColumn\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e)\n    table_bookings = \u003cspan class=\"hljs-title function_\"\u003erelationship\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"TableBooking\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e사용자 등록은 이메일과 비밀번호 매개변수를 받아들이고 데이터베이스에 사용자 레코드를 생성하는 SignUp 뮤테이션을 통해 제공됩니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e# api/graphql.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e graphene\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e service \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e sign_up\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSignUp\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eMutation\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArguments\u003c/span\u003e:\n        email = graphene.\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n        password = graphene.\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n\n   user = graphene.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eUserNode\u003c/span\u003e)\n\n   def \u003cspan class=\"hljs-title function_\"\u003emutate\u003c/span\u003e(self, info, \u003cspan class=\"hljs-attr\"\u003eemail\u003c/span\u003e: str, \u003cspan class=\"hljs-attr\"\u003epassword\u003c/span\u003e: str):\n        session = info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e]\n        user = \u003cspan class=\"hljs-title function_\"\u003esign_up\u003c/span\u003e(session, email, password)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSignUp\u003c/span\u003e(user=user)\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMutation\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eObjectType\u003c/span\u003e):\n    sign_up = \u003cspan class=\"hljs-title class_\"\u003eSignUp\u003c/span\u003e.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e()\n\n# service.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e auth \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e generate_password_hash\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserAlreadyExist\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eException\u003c/span\u003e):\n    pass\n\ndef \u003cspan class=\"hljs-title function_\"\u003esign_up\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003esession\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eSession\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eemail\u003c/span\u003e: str, password) -\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e session.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003efilter_by\u003c/span\u003e(email=email).\u003cspan class=\"hljs-title function_\"\u003efirst\u003c/span\u003e():\n        raise \u003cspan class=\"hljs-title class_\"\u003eUserAlreadyExist\u003c/span\u003e()\n    user = \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e(email=email, password=\u003cspan class=\"hljs-title function_\"\u003egenerate_password_hash\u003c/span\u003e(password))\n    session.\u003cspan class=\"hljs-title function_\"\u003eadd\u003c/span\u003e(user)\n    session.\u003cspan class=\"hljs-title function_\"\u003ecommit\u003c/span\u003e()\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e user\n\n# auth.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e hashlib\n\n\u003cspan class=\"hljs-variable constant_\"\u003eSALT\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"STRONg@Salt\"\u003c/span\u003e\n\ndef \u003cspan class=\"hljs-title function_\"\u003egenerate_password_hash\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003epassword\u003c/span\u003e: str) -\u003e \u003cspan class=\"hljs-attr\"\u003estr\u003c/span\u003e:\n    h = hashlib.\u003cspan class=\"hljs-title function_\"\u003emd5\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"{password}{SALT}\"\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eencode\u003c/span\u003e())\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e h.\u003cspan class=\"hljs-title function_\"\u003ehexdigest\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e뮤테이션은 /graphql 엔드포인트에서 POST 요청을 통해 실행됩니다. GraphQL에 대한 이전 게시물과 같이 insomnia를 사용하여 HTTP 요청을 수행합니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_1.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e사용자 인스턴스가 생성되면 올바른 자격 증명이 전달되면 사용자 인증 JWT 토큰을 생성하는 SignIn 뮤테이션이 필요합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e# api/graphql.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e graphene\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e service \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e sign_in\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSignIn\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eMutation\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArguments\u003c/span\u003e:\n        email = graphene.\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n        password = graphene.\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n\n   token = graphene.\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e()\n\n   def \u003cspan class=\"hljs-title function_\"\u003emutate\u003c/span\u003e(self, info, \u003cspan class=\"hljs-attr\"\u003eemail\u003c/span\u003e: str, \u003cspan class=\"hljs-attr\"\u003epassword\u003c/span\u003e: str):\n        session = info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e]\n        token = \u003cspan class=\"hljs-title function_\"\u003esign_in\u003c/span\u003e(session, email, password)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSignIn\u003c/span\u003e(token=token)\n\n   \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMutation\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eObjectType\u003c/span\u003e):\n        sign_in = \u003cspan class=\"hljs-title class_\"\u003eSignIn\u003c/span\u003e.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e()\n\n# service.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy.\u003cspan class=\"hljs-property\"\u003eorm\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSession\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e auth \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e generate_token, verify_password\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserAuthenticationError\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eException\u003c/span\u003e):\n    pass\n\ndef \u003cspan class=\"hljs-title function_\"\u003esign_in\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003esession\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eSession\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eemail\u003c/span\u003e: str, password) -\u003e \u003cspan class=\"hljs-attr\"\u003estr\u003c/span\u003e:\n    user = session.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003efilter_by\u003c/span\u003e(email=email).\u003cspan class=\"hljs-title function_\"\u003efirst\u003c/span\u003e()\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e not \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e:\n        raise \u003cspan class=\"hljs-title class_\"\u003eUserAuthenticationError\u003c/span\u003e()\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e not \u003cspan class=\"hljs-title function_\"\u003everify_password\u003c/span\u003e(user, password):\n        raise \u003cspan class=\"hljs-title class_\"\u003eUserAuthenticationError\u003c/span\u003e()\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egenerate_token\u003c/span\u003e(user)\n\n# auth.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e hashlib\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e itsdangerous \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTimedJSONWebSignatureSerializer\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSerializer\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\n\n\u003cspan class=\"hljs-variable constant_\"\u003eSALT\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"STRONg@Salt\"\u003c/span\u003e\n\u003cspan class=\"hljs-variable constant_\"\u003eSECRET_KEY\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"!SECRET!\"\u003c/span\u003e\n\u003cspan class=\"hljs-variable constant_\"\u003eTOKEN_EXPIRES_IN\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e3600\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e30\u003c/span\u003e\n\ndef \u003cspan class=\"hljs-title function_\"\u003egenerate_password_hash\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003epassword\u003c/span\u003e: str) -\u003e \u003cspan class=\"hljs-attr\"\u003estr\u003c/span\u003e:\n    h = hashlib.\u003cspan class=\"hljs-title function_\"\u003emd5\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"{password}{SALT}\"\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eencode\u003c/span\u003e())\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e h.\u003cspan class=\"hljs-title function_\"\u003ehexdigest\u003c/span\u003e()\n\ndef \u003cspan class=\"hljs-title function_\"\u003everify_password\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003epassword\u003c/span\u003e: str) -\u003e \u003cspan class=\"hljs-attr\"\u003ebool\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e user.\u003cspan class=\"hljs-property\"\u003epassword\u003c/span\u003e == \u003cspan class=\"hljs-title function_\"\u003egenerate_password_hash\u003c/span\u003e(password)\n\ndef \u003cspan class=\"hljs-title function_\"\u003egenerate_token\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e) -\u003e \u003cspan class=\"hljs-attr\"\u003estr\u003c/span\u003e:\n    serializer = \u003cspan class=\"hljs-title class_\"\u003eSerializer\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eSECRET_KEY\u003c/span\u003e, expires_in=\u003cspan class=\"hljs-variable constant_\"\u003eTOKEN_EXPIRES_IN\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e serializer.\u003cspan class=\"hljs-title function_\"\u003edumps\u003c/span\u003e({\u003cspan class=\"hljs-string\"\u003e\"user_id\"\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e}).\u003cspan class=\"hljs-title function_\"\u003edecode\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"utf-8\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSignIn 뮤테이션을 위해 이메일과 비밀번호를 전달하고 인증이 필요한 요청에서 사용할 수 있는 토큰을 페이로드로 받습니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_2.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e인증\u003c/h1\u003e\n\u003cp\u003eSignIn 단계에서 생성된 토큰이 있으므로 \"Bearer Authentication\" 프로세스에서 사용할 수 있습니다. 이러한 유형의 인증에서는 유효한 토큰(베어러)을 가진 모든 사용자가 해당 토큰에 해당하는 사용자로 인식될 수 있습니다. 각 GraphQL 필드 리졸버에 사용할 수 있는 sign_in_required 데코레이터를 정의합니다. 이 데코레이터는 \"Authorization\" 요청 헤더에서 토큰을 가져와 해독하여 user_id를 얻은 다음, user_id에 해당하는 User가 있는지 확인합니다. 성공적으로 완료되면 인증된 User가 됩니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e# api/graphql.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e graphene\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e api.\u003cspan class=\"hljs-property\"\u003eauth\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e sign_in_required\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eQuery\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eObjectType\u003c/span\u003e):\n    up = graphene.\u003cspan class=\"hljs-title class_\"\u003eBoolean\u003c/span\u003e()\n    restaurants = graphene.\u003cspan class=\"hljs-property\"\u003erelay\u003c/span\u003e.\u003cspan class=\"hljs-title class_\"\u003eConnectionField\u003c/span\u003e(\n        \u003cspan class=\"hljs-title class_\"\u003eRestaurantConnection\u003c/span\u003e, q=graphene.\u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e()\n    )\n    me = graphene.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eUserNode\u003c/span\u003e)\n\n    def \u003cspan class=\"hljs-title function_\"\u003eresolve_up\u003c/span\u003e(root, info, **kwargs):\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e\n\n    @\u003cspan class=\"hljs-title function_\"\u003esign_in_required\u003c/span\u003e()\n    def \u003cspan class=\"hljs-title function_\"\u003eresolve_restaurants\u003c/span\u003e(root, info, **kwargs):\n        query = \u003cspan class=\"hljs-title function_\"\u003eget_restaurants\u003c/span\u003e(\n            info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e], search=kwargs.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"q\"\u003c/span\u003e), limit=kwargs.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"first\"\u003c/span\u003e)\n        )\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [\u003cspan class=\"hljs-title class_\"\u003eRestaurantNode\u003c/span\u003e(id=r.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, name=r.\u003cspan class=\"hljs-property\"\u003ename\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e r \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e query]\n\n    @\u003cspan class=\"hljs-title function_\"\u003esign_in_required\u003c/span\u003e()\n    def \u003cspan class=\"hljs-title function_\"\u003eresolve_me\u003c/span\u003e(root, info, **kwargs):\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e kwargs[\u003cspan class=\"hljs-string\"\u003e\"current_user\"\u003c/span\u003e]\n\n# api/auth.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e functools \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e wraps\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e auth \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e get_user_by_token\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUnauthenticatedUser\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eException\u003c/span\u003e):\n    pass\n\ndef \u003cspan class=\"hljs-title function_\"\u003esign_in_required\u003c/span\u003e():\n    def \u003cspan class=\"hljs-title function_\"\u003edecorator\u003c/span\u003e(func):\n        @\u003cspan class=\"hljs-title function_\"\u003ewraps\u003c/span\u003e(func)\n        def \u003cspan class=\"hljs-title function_\"\u003ewrapper\u003c/span\u003e(root, info, *args, **kwargs):\n            kwargs[\u003cspan class=\"hljs-string\"\u003e\"current_user\"\u003c/span\u003e] = \u003cspan class=\"hljs-title function_\"\u003eget_current_user\u003c/span\u003e(info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e)\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efunc\u003c/span\u003e(root, info, *args, **kwargs)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e wrapper\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e decorator\n\ndef \u003cspan class=\"hljs-title function_\"\u003eget_current_user\u003c/span\u003e(context) -\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e:\n    \u003cspan class=\"hljs-attr\"\u003etry\u003c/span\u003e:\n        token = \u003cspan class=\"hljs-title function_\"\u003eget_token_from_request\u003c/span\u003e(context[\u003cspan class=\"hljs-string\"\u003e\"request\"\u003c/span\u003e])\n        user = \u003cspan class=\"hljs-title function_\"\u003eget_user_by_token\u003c/span\u003e(context[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e], token)\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e not \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e:\n            raise \u003cspan class=\"hljs-title class_\"\u003eUnauthenticatedUser\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"UnauthenticatedUser\"\u003c/span\u003e)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e user\n    except \u003cspan class=\"hljs-title class_\"\u003eKeyError\u003c/span\u003e:\n        raise \u003cspan class=\"hljs-title class_\"\u003eUnauthenticatedUser\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"UnauthenticatedUser\"\u003c/span\u003e)\n\ndef \u003cspan class=\"hljs-title function_\"\u003eget_token_from_request\u003c/span\u003e(request) -\u003e \u003cspan class=\"hljs-attr\"\u003estr\u003c/span\u003e:\n    header = request.\u003cspan class=\"hljs-property\"\u003eheaders\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"Authorization\"\u003c/span\u003e]\n    token = header.\u003cspan class=\"hljs-title function_\"\u003ereplace\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"Bearer \"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e token\n\n# auth.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e hashlib\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e typing \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eOptional\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e itsdangerous \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTimedJSONWebSignatureSerializer\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSerializer\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e sqlalchemy.\u003cspan class=\"hljs-property\"\u003eorm\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSession\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\n\n\u003cspan class=\"hljs-variable constant_\"\u003eSECRET_KEY\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"!SECRET!\"\u003c/span\u003e\n\u003cspan class=\"hljs-variable constant_\"\u003eTOKEN_EXPIRES_IN\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e3600\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e30\u003c/span\u003e\n\ndef \u003cspan class=\"hljs-title function_\"\u003eget_user_by_token\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003esession\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eSession\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003etoken\u003c/span\u003e: str) -\u003e \u003cspan class=\"hljs-title class_\"\u003eOptional\u003c/span\u003e[\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e]:\n    serializer = \u003cspan class=\"hljs-title class_\"\u003eSerializer\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eSECRET_KEY\u003c/span\u003e, expires_in=\u003cspan class=\"hljs-variable constant_\"\u003eTOKEN_EXPIRES_IN\u003c/span\u003e)\n    data = serializer.\u003cspan class=\"hljs-title function_\"\u003eloads\u003c/span\u003e(token)\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e session.\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(data[\u003cspan class=\"hljs-string\"\u003e\"user_id\"\u003c/span\u003e])\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eup 필드는 공개 액세스이므로 쿼리를 위해 자격 증명을 전달할 필요가 없습니다. 한편, me 필드는 sign_in_required로 데코레이트되었으므로 적절한 토큰을 전달해야 해결할 수 있습니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_3.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_4.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e\"Authorization\" 헤더에 토큰을 전달하지 않고 sign_in_required로 표시된 필드에 접근하면 UnauthenticatedUser 예외가 발생합니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_5.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e인가\u003c/h1\u003e\n\u003cp\u003e쿼리를 인증하여 로그인한 사용자만 액세스할 수 있도록 제한하는 방법을 살펴보았습니다. 그러나 사용자가 로그인했지만 수행하는 작업이 허용되지 않는 경우는 어떻게 할까요? 예를 들어, 예약한 레스토랑 테이블이 있으며 사용자가 인증되었을 때 허용되어야 하는 경우와 테이블 예약을 취소해야 하는 경우와 같이 사용자가 이전에 생성한 예약만 취소할 수 있는 경우가 있습니다.\u003c/p\u003e\n\u003cp\u003e우리는 두 가지 작업을 구현했습니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e사용자가 인증되었을 때 허용되어야 하는 BookRestaurantTable 뮤테이션,\u003c/li\u003e\n\u003cli\u003e취소되어야 하는 TableBooking을 취소하는 CancelTableBooking 뮤테이션.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e이를 위해 BookRestaurantTable은 sign_in_required로 데코레이트된 mutate 메서드를 사용하고, CancelTableBooking은 authorize_required로 데코레이트된 새로운 메서드를 사용합니다. 이 데코레이터는 사용자가 인증되었는지 확인하고, table_booking_gid(인스턴스의 전역 ID를 나타내는 값)가 인증된 사용자에 의해 생성된 TableBooking 인스턴스와 일치하는지 확인합니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBookRestaurantTable\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eMutation\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArguments\u003c/span\u003e:\n        restaurant_gid = graphene.\u003cspan class=\"hljs-title function_\"\u003eID\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n        persons = graphene.\u003cspan class=\"hljs-title class_\"\u003eInt\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n\n    table_booking = graphene.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eTableBookingNode\u003c/span\u003e)\n\n    @\u003cspan class=\"hljs-title function_\"\u003esign_in_required\u003c/span\u003e()\n    def \u003cspan class=\"hljs-title function_\"\u003emutate\u003c/span\u003e(self, info, \u003cspan class=\"hljs-attr\"\u003erestaurant_gid\u003c/span\u003e: str, \u003cspan class=\"hljs-attr\"\u003epersons\u003c/span\u003e: int, **kwargs):\n        session = info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e]\n        current_user = kwargs[\u003cspan class=\"hljs-string\"\u003e\"current_user\"\u003c/span\u003e]\n        _, restaurant_id = \u003cspan class=\"hljs-title function_\"\u003efrom_global_id\u003c/span\u003e(restaurant_gid)\n        table_booking = \u003cspan class=\"hljs-title function_\"\u003ebook_restaurant_table\u003c/span\u003e(\n            session, restaurant_id, current_user.\u003cspan class=\"hljs-property\"\u003eemail\u003c/span\u003e, persons\n        )\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBookRestaurantTable\u003c/span\u003e(\n            table_booking=\u003cspan class=\"hljs-title class_\"\u003eTableBookingNode\u003c/span\u003e(\n                id=table_booking.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e,\n                is_active=table_booking.\u003cspan class=\"hljs-property\"\u003eis_active\u003c/span\u003e,\n            )\n        )\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eCancelTableBooking\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eMutation\u003c/span\u003e):\n    \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArguments\u003c/span\u003e:\n        table_booking_gid = graphene.\u003cspan class=\"hljs-title function_\"\u003eID\u003c/span\u003e(required=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n\n    table_booking = graphene.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eTableBookingNode\u003c/span\u003e)\n\n    @\u003cspan class=\"hljs-title function_\"\u003eauthorize_required\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eTableBooking\u003c/span\u003e)\n    def \u003cspan class=\"hljs-title function_\"\u003emutate\u003c/span\u003e(self, info, \u003cspan class=\"hljs-attr\"\u003etable_booking_gid\u003c/span\u003e: str, **kwargs):\n        session = info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e]\n        table_booking = kwargs[\u003cspan class=\"hljs-string\"\u003e\"instance\"\u003c/span\u003e]\n        \u003cspan class=\"hljs-title function_\"\u003ecancel_table_booking\u003c/span\u003e(session, table_booking)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eCancelTableBooking\u003c/span\u003e(\n            table_booking=\u003cspan class=\"hljs-title class_\"\u003eTableBookingNode\u003c/span\u003e(\n                id=table_booking.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e,\n                is_active=table_booking.\u003cspan class=\"hljs-property\"\u003eis_active\u003c/span\u003e,\n            )\n        )\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMutation\u003c/span\u003e(graphene.\u003cspan class=\"hljs-property\"\u003eObjectType\u003c/span\u003e):\n    book_restaurant_table = \u003cspan class=\"hljs-title class_\"\u003eBookRestaurantTable\u003c/span\u003e.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e()\n    cancel_table_booking = \u003cspan class=\"hljs-title class_\"\u003eCancelTableBooking\u003c/span\u003e.\u003cspan class=\"hljs-title class_\"\u003eField\u003c/span\u003e()\n\n# api/auth.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e re\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e functools \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e wraps\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e graphene.\u003cspan class=\"hljs-property\"\u003erelay\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enode\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e from_global_id\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e auth \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e authorize\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\n\ndef \u003cspan class=\"hljs-title function_\"\u003ecamel_to_snake\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: str) -\u003e \u003cspan class=\"hljs-attr\"\u003estr\u003c/span\u003e:\n    \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"CamelCase -\u003e camel_case\"\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e re.\u003cspan class=\"hljs-title function_\"\u003esub\u003c/span\u003e(r\u003cspan class=\"hljs-string\"\u003e\"(?\u0026#x3C;!^)(?=[A-Z])\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"_\"\u003c/span\u003e, name).\u003cspan class=\"hljs-title function_\"\u003elower\u003c/span\u003e()\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUnauthorizedAccess\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eException\u003c/span\u003e):\n    pass\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eInstanceNotExist\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eException\u003c/span\u003e):\n    pass\n\ndef \u003cspan class=\"hljs-title function_\"\u003eauthorize_required\u003c/span\u003e(model):\n    \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"\n    We assume that the global id field name of a resource\n    follow convention like:\n    model_name: `TableBooking`\n    global id field name: `table_booking_gid`\n    \"\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\n    def \u003cspan class=\"hljs-title function_\"\u003edecorator\u003c/span\u003e(func):\n        @\u003cspan class=\"hljs-title function_\"\u003ewraps\u003c/span\u003e(func)\n        def \u003cspan class=\"hljs-title function_\"\u003ewrapper\u003c/span\u003e(root, info, *args, **kwargs):\n            kwargs[\u003cspan class=\"hljs-string\"\u003e\"current_user\"\u003c/span\u003e] = \u003cspan class=\"hljs-title function_\"\u003eget_current_user\u003c/span\u003e(info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e)\n            model_name = model.\u003cspan class=\"hljs-property\"\u003e__name__\u003c/span\u003e\n            gid_field_name = f\u003cspan class=\"hljs-string\"\u003e\"{camel_to_snake(model_name)}_gid\"\u003c/span\u003e\n            instance_gid = kwargs[gid_field_name]\n            instance_model_name, instance_id = \u003cspan class=\"hljs-title function_\"\u003efrom_global_id\u003c/span\u003e(instance_gid)\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e instance_model_name != f\u003cspan class=\"hljs-string\"\u003e\"{model_name}Node\"\u003c/span\u003e:\n                raise \u003cspan class=\"hljs-title class_\"\u003eUnauthorizedAccess\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"UnauthorizedAccess\"\u003c/span\u003e)\n            instance = info.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"session\"\u003c/span\u003e].\u003cspan class=\"hljs-title function_\"\u003equery\u003c/span\u003e(model).\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(instance_id)\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e not \u003cspan class=\"hljs-attr\"\u003einstance\u003c/span\u003e:\n                \u003cspan class=\"hljs-title class_\"\u003eInstanceNotExist\u003c/span\u003e()\n            kwargs[\u003cspan class=\"hljs-string\"\u003e\"instance\"\u003c/span\u003e] = instance\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e not \u003cspan class=\"hljs-title function_\"\u003eauthorize\u003c/span\u003e(instance, kwargs[\u003cspan class=\"hljs-string\"\u003e\"current_user\"\u003c/span\u003e]):\n                raise \u003cspan class=\"hljs-title class_\"\u003eUnauthorizedAccess\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"UnauthorizedAccess\"\u003c/span\u003e)\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efunc\u003c/span\u003e(root, info, *args, **kwargs)\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e wrapper\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e decorator\n\n# auth.\u003cspan class=\"hljs-property\"\u003epy\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e functools \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e singledispatch\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTableBooking\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\n\n@singledispatch\ndef \u003cspan class=\"hljs-title function_\"\u003eauthorize\u003c/span\u003e(instance, \u003cspan class=\"hljs-attr\"\u003ecurrent_user\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e) -\u003e \u003cspan class=\"hljs-attr\"\u003ebool\u003c/span\u003e:\n    raise \u003cspan class=\"hljs-title class_\"\u003eNotImplementedError\u003c/span\u003e\n\n@authorize.\u003cspan class=\"hljs-title function_\"\u003eregister\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eTableBooking\u003c/span\u003e)\ndef \u003cspan class=\"hljs-title function_\"\u003e_authorize\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003einstance\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eTableBooking\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003ecurrent_user\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e) -\u003e \u003cspan class=\"hljs-attr\"\u003ebool\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e instance.\u003cspan class=\"hljs-property\"\u003euser_id\u003c/span\u003e == current_user.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBookRestaurantTable을 실행하기 위해 restaurant_gid 및 persons라는 두 가지 필수 인수를 전달해야 합니다. \"Authorization\" 헤더에 토큰을 추가해야 합니다. Mutation 응답에서는 TableBooking.id를 얻습니다.\u003c/p\u003e\n\u003cp\u003e이미지가 포함된 파일경로: \u003ccode\u003e/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_6.png\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eCancelTableBooking은 BookRestaurantTable 페이로드(TableBooking.id)에서 가져올 수 있는 table_booking_gid만 필요합니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_7.png\"\u003e\n\u003cp\u003e만약 토큰이 주어진 테이블 예약의 소유자와 일치하지 않는 경우, 동작을 수행할 수 없으며, 권한이 없음 예외가 발생합니다.\u003c/p\u003e\n\u003cimg src=\"/TIL/assets/img/2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI_8.png\"\u003e\n\u003ch1\u003e결론\u003c/h1\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e인증 및 권한 부여 단계를 쿼리와 뮤테이션 모두 위한 방법을 소개했어요. 이 구현은 매우 범용적이며 어떤 Python GraphQL 프로젝트에도 쉽게 통합할 수 있어요. 전체 소스 코드는 여기에서 확인할 수 있어요: \u003ca href=\"https://github.com/jorzel/service-layer/tree/auth\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://github.com/jorzel/service-layer/tree/auth\u003c/a\u003e.\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-07-09-HowtohandleauthenticationandauthorizationinGraphQLAPI"},"buildId":"N1mNhRlQaHCliEGDvPEpG","assetPrefix":"/TIL","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4877378276818686","strategy":"lazyOnload","crossOrigin":"anonymous"}]}</script></body></html>