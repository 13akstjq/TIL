<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>Airflow 변수 완전 정복하는 방법 | TIL</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://13akstjq.github.io/TIL//post/2024-07-13-MasteringAirflowVariables" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="Airflow 변수 완전 정복하는 방법 | TIL" data-gatsby-head="true"/><meta property="og:title" content="Airflow 변수 완전 정복하는 방법 | TIL" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://TIL.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://13akstjq.github.io/TIL//post/2024-07-13-MasteringAirflowVariables" data-gatsby-head="true"/><meta name="twitter:title" content="Airflow 변수 완전 정복하는 방법 | TIL" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | TIL" data-gatsby-head="true"/><meta name="article:published_time" content="2024-07-13 20:34" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/TIL/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/TIL/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/TIL/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/TIL/favicons/favicon-96x96.png"/><link rel="icon" href="/TIL/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/TIL/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/TIL/favicons/browserconfig.xml"/><link rel="preload" href="/TIL/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/TIL/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/TIL/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/TIL/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/TIL/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/TIL/_next/static/chunks/webpack-21ffe88bdca56cba.js" defer=""></script><script src="/TIL/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/TIL/_next/static/chunks/main-a5eeabb286676ce6.js" defer=""></script><script src="/TIL/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/TIL/_next/static/chunks/75fc9c18-4a646156c659a948.js" defer=""></script><script src="/TIL/_next/static/chunks/348-02483b66b493dd81.js" defer=""></script><script src="/TIL/_next/static/chunks/pages/post/%5Bslug%5D-5ecfd58aae5a7e3d.js" defer=""></script><script src="/TIL/_next/static/Suu-uTE6tpVjS7rqQHkw3/_buildManifest.js" defer=""></script><script src="/TIL/_next/static/Suu-uTE6tpVjS7rqQHkw3/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/TIL">TIL</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/TIL/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">Airflow 변수 완전 정복하는 방법</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="Airflow 변수 완전 정복하는 방법" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/TIL/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">TIL</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On Jul 13, 2024</span><span class="posts_reading_time__f7YPP">17<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-07-13-MasteringAirflowVariables&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<img src="/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png">
<p>만약 여러 데이터 파이프라인이 동일한 API 엔드포인트와 상호 작용해야 하는 상황이 있다면, 정말 모든 파이프라인에서 이 엔드포인트를 선언해야 할까요? 이 엔드포인트가 나중에 변경된다면, 모든 파일에서 해당 값을 업데이트해야 합니다.</p>
<p>Airflow 변수는 간단하면서도 가치 있는 구조로, 여러 DAG에서 중복 선언을 방지하는 데 사용됩니다. 이들은 단순히 키와 JSON 직렬화 가능한 값으로 구성된 객체로, Airflow의 메타데이터베이스에 저장됩니다.</p>
<p>그리고 코드가 토큰이나 기타 유형의 비밀을 사용한다면 어떻게 해야 할까요? 평문으로 하드코딩하는 것은 안전한 접근 방식으로 보이지 않습니다. 반복을 줄이는 데 beyond하는 Airflow 변수는 민감한 정보를 관리하는 데도 도움이 됩니다. Airflow에서 변수를 정의하는 여섯 가지 다양한 방법 중에서 적합한 방법을 선택하는 것은 보안과 이식성을 보장하기 위해 중요합니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>자주 간과되는 측면 중 하나는 변수 검색이 Airflow 성능에 미치는 영향입니다. 스케줄러가 DAG 파일을 파싱할 때마다 메타데이터베이스에 요청하는 것은 성능에 부담이 될 수 있습니다(기본값은 삼십 초입니다).</p>
<p>이 함정에 빠지기는 꽤 쉽습니다. DAG를 구문 분석하는 방법과 데이터베이스에서 변수를 검색하는 방법을 이해하지 않는 한요하는 베스트 프렉티스를 적용하는 것이 중요합니다.</p>
<h1>Airflow 변수 정의</h1>
<p>DAG 파일을 파싱하는 방법과 DAGs를 최적화하기 위해 적용해야 하는 베스트 프렉티스에 대해 논의하기 전에, 기초를 제대로 이해하는 것이 중요합니다. 여기서는 어떻게 Airflow에서 변수를 선언하는지에만 초점을 맞춰 보겠습니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>이미 언급한 바와 같이, Airflow에서 변수를 선언하는 여러 가지 방법이 있습니다. 그 중 일부는 다른 것보다 더 안전하고 이식성이 뛰어난 것으로 나타나므로, 이들의 장단점을 살펴보고 이해해 봅시다.</p>
<h2>1. 사용자 인터페이스에서 변수 생성</h2>
<p>첫 번째 방법으로, 사용자 인터페이스를 통해 변수를 생성하는 방법을 살펴보겠습니다. 상위 메뉴에서 Admin → Variables → + 를 선택합니다.</p>
<p>키와 값을 입력한 후, 만들기를 클릭하여 생성합니다. 변수는 이제 변수 목록에서 확인할 수 있어야 합니다. 기본적으로 UI에서 생성된 변수는 자동으로 메타데이터 데이터베이스에 저장됩니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>변수 값이 평문으로 표시된다는 것을 알 수 있어요. Airflow 변수 중 민감한 정보를 저장하려면 UI 방식이 가장 적합하지 않을 수 있어요.</p>
<p>또한, 이 방법은 이식성이 떨어집니다. 환경을 재생성하려면 먼저 현재 환경에서 수동으로 내보내고, 마지막으로 새로 만든 환경으로 다시 가져와야 해요.</p>
<h2>2. 환경 변수를 내보내어 변수 생성하기</h2>
<p>두 번째 옵션은 AIRFLOW_VAR_<code>변수_이름</code> 표기법을 사용하여 환경 변수를 내보내는 것이에요.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>다음 명령어를 사용하여 두 변수인 foo와 bar를 생성할 수 있습니다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">export</span> <span class="hljs-variable constant_">AIRFLOW_VAR_FOO</span>=my_value
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">AIRFLOW_VAR_BAR</span>=<span class="hljs-string">'{"newsletter":"Data Pipeline"}'</span>
</code></pre>
<p>이 방법의 장점 중 하나는 환경 변수를 통해 생성된 변수가 UI에 표시되지 않는다는 것입니다(물론 코드에서 참조할 수는 있습니다). 즉, 민감한 정보가 노출되지 않습니다.</p>
<p>UI를 통해 생성된 변수와는 달리, 이 방법은 메타데이터베이스에 지속적으로 저장하지 않습니다. 따라서 환경 변수를 사용하면 데이터베이스 연결을 설정할 필요가 없어 빠르게 검색할 수 있습니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>하지만 여전히 환경 변수를 관리하는 것도 어려울 수 있습니다. 환경 변수가 Airflow 배포를 담당하는 자동화 스크립트에서 사용되는 파일에 저장된 경우 값들을 어떻게 안전하게 보호할 수 있을까요?</p>
<h2>3. Airflow CLI를 통한 변수 생성</h2>
<p>Airflow CLI를 사용하여 변수를 생성할 수도 있습니다. 먼저 Airflow 스케줄러 워커에 연결해야 합니다. 예를 들어 Docker를 통해 Airflow를 실행 중이라면, 먼저 스케줄러의 컨테이너 ID를 찾은 다음 다음 명령을 실행하세요.</p>
<pre><code class="hljs language-js">docker exec -it &#x3C;airflow-scheduler-container-id> <span class="hljs-regexp">/bin/</span>bash
</code></pre>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>Airflow 변수를 만들려면 다음의 명령어를 사용할 수 있어요:</p>
<pre><code class="hljs language-js">airflow variables set \
    my_cli_var \
    my_value \
    --description <span class="hljs-string">'이 변수는 CLI를 통해 생성되었어요'</span>
</code></pre>
<p>만약 특정 변수에 여러 값을 할당하려면 JSON 형식을 사용하는 것이 좋아요:</p>
<pre><code class="hljs language-js">airflow variables set \
    my_cli_json_var \
    <span class="hljs-string">'{"key": "value", "another_key": "another_value"}'</span> \
    --description <span class="hljs-string">'이 변수는 CLI를 통해 생성되었어요'</span>
</code></pre>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>JSON 변수를 직렬화하는 옵션도 있습니다. 이를 위해 -j 또는 --json 플래그를 제공하여 수행할 수 있습니다.</p>
<pre><code class="hljs language-js">airflow variables set \
    --json \
    my_cli_serialised_json_var \
    <span class="hljs-string">'{"key": "value", "another_key": "another_value"}'</span> \
    --description <span class="hljs-string">'CLI를 통해 생성된 이 변수'</span>
</code></pre>
<p>이제 UI의 변수 목록으로 돌아가보면, 이전 단계에서 만든 세 가지 변수가 모두 표시됩니다.</p>
<p>CLI를 통해 생성된 변수는 UI에서 확인할 수 있어 민감한 정보도 노출되고 메타데이터베이스에 저장될 수 있습니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>내 의견으로는, 이 방법은 개발 환경에서 유용합니다. 특정 변수를 빠르게 생성하고 테스트하거나 해당 변수를 참조하는 기능을 테스트하고 싶을 때 유용합니다. 프로덕션 배포의 경우, 변수를 생성(또는 업데이트)하기 위한 자동화 스크립트를 작성해야 하며, 이 정보는 파일에 저장되어야 합니다. 그렇기 때문에 몇 가지 변수에는 민감한 정보가 포함될 수 있어 처리하기 어려울 수 있습니다.</p>
<h2>4. REST API를 사용하여 변수 생성</h2>
<p>이 네 번째 방법은 REST API를 호출하여 몇 가지 변수를 생성하는 것을 포함합니다. 이는 Airflow CLI 방식과 유사하며 동일한 장단점을 제공합니다.</p>
<pre><code class="hljs language-js">curl -X <span class="hljs-variable constant_">POST</span> ${<span class="hljs-variable constant_">AIRFLOW_URL</span>}/api/v1/variables \
        -H <span class="hljs-string">"Content-Type: application/json"</span> \
        --user <span class="hljs-string">"${AIRFLOW_USERNAME}:${AIRFLOW_PASSWORD}"</span> \
        -d <span class="hljs-string">'{"key": "json_var", "value": "{\"key1\":\"val1\"}"}'</span>
</code></pre>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>5. 변수를 프로그래밍적으로 생성하기</h2>
<p>프로그래밍적으로 변수를 생성하는 것도 실행 가능하고 간단합니다.</p>
<pre><code class="hljs language-js">def <span class="hljs-title function_">create_vars</span>():
    <span class="hljs-keyword">from</span> airflow.<span class="hljs-property">models</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Variable</span>

    <span class="hljs-title class_">Variable</span>.<span class="hljs-title function_">set</span>(key=<span class="hljs-string">'my_var'</span>, value=<span class="hljs-string">'my_val'</span>)
    <span class="hljs-title class_">Variable</span>.<span class="hljs-title function_">set</span>(
        key=<span class="hljs-string">'my_json_var'</span>, 
        value={<span class="hljs-string">'my_key'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'another_key'</span>: <span class="hljs-string">'another_val'</span>}, 
        serialize_json=<span class="hljs-title class_">True</span>,
    )

...

<span class="hljs-title class_">PythonOperator</span>(
    task_id=<span class="hljs-string">'create_variables'</span>,
    python_callable=create_vars,
)
</code></pre>
<p>물론 이것은 나쁜 관행이며 프로덕션 배포에서 피해야 합니다. 변수 - 특히 민감한 정보를 포함하는 변수 - 는 DAG 파일에서 선언되어서는 안 되며 코드는 버전 관리되고 UI의 코드 탭에서도 볼 수 있기 때문입니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>6. 시크릿 스토어/백엔드에서 변수 만들기 ❤</h2>
<p>환경 변수나 메타스토어 데이터베이스에서 변수를 검색하는 것 외에도 Airflow 변수를 검색하기 위해 대체 시크릿 백엔드를 활성화할 수 있습니다.</p>
<p>현재 Apache Airflow 커뮤니티에서 제공하는 시크릿 백엔드 구현에는 다음이 포함됩니다:</p>
<ul>
<li>Amazon (Secrets Manager 및 Systems Manager Parameter Store)</li>
<li>Google (Cloud Secret Manager)</li>
<li>Microsoft (Azure Key Vault)</li>
<li>HashiCorp (Vault)</li>
</ul>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>사실, Airflow에서 변수를 정의하는 가장 좋고 안전하며 휴대성이 뛰어난 방법입니다.</p>
<h1>민감한 변수 값 숨기기</h1>
<p>이전 섹션에서 설명한 몇 가지 방법 중 일부에서 민감한 정보가 실제로 사용자 인터페이스에 표시될 수 있다고 언급했습니다. 사실, 변수가 올바르게 이름 지어진 경우에는 민감한 값을 숨길 수 있습니다.</p>
<p>변수 이름에 특정 키워드가 포함되어 민감한 정보를 나타낼 수 있다고 생각되면 해당 값이 자동으로 숨겨집니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>다음은 민감한 정보를 값으로 저장하게끔 변수를 자격 부여할 키워드 목록입니다:</p>
<pre><code class="hljs language-js">access_token
api_key
apikey
authorization
passphrase
passwd
password
private_key
secret
token
keyfile_dict
service_account
</code></pre>
<p>만약 변수 이름에 이 키워드 중 하나가 포함되어 있다면, Airflow는 해당 값을 적절히 처리할 것입니다. 이 기능이 예상대로 작동하는지 확인하기 위해 예제를 시도해 보겠습니다.</p>
<p>먼저, 위에 언급된 키워드 중 하나를 추가하지 않고 새 변수를 만들어 보겠습니다. 우리는 변수의 값이 사용자 인터페이스에서 보이는 것을 확인할 수 있습니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>다음 화면에서는 새로운 변수인 my_api_key를 생성하려고 시도합니다. 이전에 토론한 대로 변수 이름에 api_key 키워드가 포함되어 있기 때문에 Airflow는 민감한 정보를 보호하는 방식으로 해당 값을 처리해야 합니다.</p>
<p>실제로 지금 UI의 변수 목록으로 돌아가보면 새로 생성된 변수의 값을 숨겨진 것을 볼 수 있습니다.</p>
<p>기존 키워드 목록에 만족스럽지 않다면, 추가적인 키워드를 지정하여 변수 값 숨김 시 고려해야 하는 키워드 목록을 확장할 수도 있습니다. 이는 airflow.cfg( [core] 섹션 내)의 sensitive_var_conn_names를 통해 구성하거나 AIRFLOW__CORE__SENSITIVE_VAR_CONN_NAMES 환경 변수를 내보내는 것으로 설정할 수 있습니다.</p>
<h1>효율적인 변수 검색</h1>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>기본 설정으로 Airflow DAG는 30초마다 구문 분석됩니다. 스케줄러는 DAG 폴더를 스캔하여 DAG 파일에 대한 변경 사항을 식별합니다. 변수를 올바르게 가져오지 않으면 DAG 구문 분석 프로세스가 곧 병목 현상이 될 수 있습니다.</p>
<p>변수를 선언하는 방법에 따라 Airflow는 DAG 파일에서 선언된 각 변수에 대해 메타스토어 데이터베이스에 연결을 초기화해야 할 수 있습니다.</p>
<h1>요청으로 메타스토어 과부하 피하기</h1>
<p>DAG에서 변수를 검색하기 위해 두 가지 접근 방식을 취할 수 있습니다:</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ul>
<li>Variable.get() 함수 사용</li>
<li>var 템플릿 변수 사용</li>
</ul>
<p>만약 첫 번째 옵션을 선택하신 경우, Variable.get()은 지정된 변수의 값을 추론하기 위해 메타스토어 데이터베이스와의 새로운 연결을 생성할 것입니다. 이제 DAG 파일에서 이 함수를 호출하는 위치는 성능에 큰 영향을 미칠 수 있습니다.</p>
<h2>잘못된 예시</h2>
<p>만약 이 함수가 태스크 외부에서 호출되거나 DAG Context Manager 내에서 호출된다면, 메타스토어와의 -의미 없는- 새로운 연결이 DAG가 파싱될 때마다 생성될 것입니다(즉, 30초마다).</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> DAG
<span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> Variable
<span class="hljs-keyword">from</span> airflow.operators.python <span class="hljs-keyword">import</span> PythonOperator

my_var = Variable.get(<span class="hljs-string">'my_var'</span>)

<span class="hljs-keyword">with</span> DAG(<span class="hljs-string">'my_dag'</span>, start_date=datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> dag:
    print_var = PythonOperator(
        task_id=<span class="hljs-string">'print_var'</span>,
        python_callable=<span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(my_var),
    )
</code></pre>
<p>만약 동일한 패턴이 많은 다른 DAG에서 사용된다면, 언젠가는 메타스토어 데이터베이스에 문제가 발생할 수 있습니다.</p>
<p>실제로 이 패턴을 피할 수 없는 몇 가지 예외적인 상황이 있습니다. 예를 들어 변수의 값에 따라 동적으로 작업을 생성하고 싶다고 가정해보겠습니다. 그 경우 해당 함수를 작업 외부에서 호출하거나 Context Manager 내에서 호출해야 할 수도 있습니다. 하지만 가능하면 이 접근 방식을 피하는 것이 중요합니다.</p>
<p>또한, 연산자의 인수에서 Variable.get() 함수를 호출하더라도 동일한 문제가 발생할 것임을 언급하는 것이 중요합니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> DAG
<span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> Variable
<span class="hljs-keyword">from</span> airflow.operators.python <span class="hljs-keyword">import</span> PythonOperator

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_print_var</span>(<span class="hljs-params">my_var</span>):
    <span class="hljs-built_in">print</span>(my_var)
<span class="hljs-keyword">with</span> DAG(<span class="hljs-string">'my_dag'</span>, start_date=datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> dag:
    print_var = PythonOperator(
        task_id=<span class="hljs-string">'print_var'</span>,
        python_callable=_print_var,
        op_args=[Variable.get(<span class="hljs-string">'my_var'</span>)],
    )
</code></pre>
<p>사실 템플릿 엔진을 사용하면 이런 문제를 쉽게 피할 수 있어요.</p>
<h2>Best Practices</h2>
<p>기본적으로 Variable.get()를 호출하는 대신에 템플릿 참조를 사용할 수 있어요. 이 기술을 사용하면 변수의 값은 런타임에만 가져와지게 돼요.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>아래의 코드 스니펫은 JSON 또는 JSON이 아닌 값에 대한 변수의 템플릿 참조를 사용하는 방법을 보여줍니다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">DAG</span>
<span class="hljs-keyword">from</span> airflow.<span class="hljs-property">models</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Variable</span>
<span class="hljs-keyword">from</span> airflow.<span class="hljs-property">operators</span>.<span class="hljs-property">python</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">PythonOperator</span>

def <span class="hljs-title function_">_print_var</span>(val1, val2, val3, val4):
    <span class="hljs-title function_">print</span>(val1)
    <span class="hljs-title function_">print</span>(val2)
    <span class="hljs-title function_">print</span>(val3)
    <span class="hljs-title function_">print</span>(val4)

<span class="hljs-keyword">with</span> <span class="hljs-title function_">DAG</span>(<span class="hljs-string">'my_dag'</span>, start_date=<span class="hljs-title function_">datetime</span>(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> <span class="hljs-attr">dag</span>:
    print_var = <span class="hljs-title class_">PythonOperator</span>(
        task_id=<span class="hljs-string">'print_var'</span>,
        python_callable=_print_var,
        op_args=[
            <span class="hljs-string">'{ var.value.my_var }'</span>,
            <span class="hljs-string">'{ var.json.my_vars.key1 }'</span>,
            <span class="hljs-string">'{ var.json.my_vars.key2 }'</span>,
            <span class="hljs-string">'{ var.json.my_vars.key3 }'</span>,
        ],
    )
</code></pre>
<p>그러나 템플릿 엔진 접근 방식은 템플릿 참조를 제공할 인수에 대해 오퍼레이터가 템플릿화된 필드를 지원하는 경우에만 적용됩니다.</p>
<p>템플릿 참조가 작동하지 않는 경우에는 여전히 Variable.get()이 작업 내에서 호출되도록하여 매번 DAG가 구문 분석될 때 메타스토어 데이터베이스로의 연결이 초기화되지 않도록 할 수 있습니다.</p>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> DAG
<span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> Variable
<span class="hljs-keyword">from</span> airflow.operators.python <span class="hljs-keyword">import</span> PythonOperator

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_print_var</span>():
    my_var = Variable.get(<span class="hljs-string">'my_var'</span>)
    <span class="hljs-built_in">print</span>(my_var)

<span class="hljs-keyword">with</span> DAG(<span class="hljs-string">'my_dag'</span>, start_date=datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> dag:
    print_var = PythonOperator(
        task_id=<span class="hljs-string">'print_var'</span>,
        python_callable=_print_var,
    )
</code></pre>
<h1>단일 변수에 여러 값을 저장하기</h1>
<p>이제 특정 DAG가 세 가지 다른 값을 검색해야 한다고 가정해 봅시다. 이전 섹션에서 소개된 최선의 방법을 따르더라도 메타스토어 데이터베이스에 대해 세 개의 개별 연결을 시작해야 합니다.</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> DAG
<span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> Variable
<span class="hljs-keyword">from</span> airflow.operators.python <span class="hljs-keyword">import</span> PythonOperator

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_print_vars</span>():
    my_var = Variable.get(<span class="hljs-string">'my_var'</span>)
    another_var = Variable.get(<span class="hljs-string">'another_var'</span>)
    one_more_var = Variable.get(<span class="hljs-string">'one_more_var'</span>)
    <span class="hljs-built_in">print</span>(my_var)
    <span class="hljs-built_in">print</span>(another_var)
    <span class="hljs-built_in">print</span>(one_more_var)

<span class="hljs-keyword">with</span> DAG(<span class="hljs-string">'my_dag'</span>, start_date=datetime(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> dag:
    print_var = PythonOperator(
        task_id=<span class="hljs-string">'print_vars'</span>,
        python_callable=_print_vars,
    )
</code></pre>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>대신, 세 개의 키-값 쌍으로 구성된 단일 JSON 변수를 생성할 수 있습니다. 당연히 이 작업은 세 값을 한 변수로 압축하는 데 논리적으로 의미가 있는 한 수행해야 합니다.</p>
<p>이제 메타스토어 데이터베이스로의 연결을 한 번만 수행하여 변수에서 지정된 모든 키의 값을 검색할 수 있습니다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> airflow <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">DAG</span>
<span class="hljs-keyword">from</span> airflow.<span class="hljs-property">models</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Variable</span>
<span class="hljs-keyword">from</span> airflow.<span class="hljs-property">operators</span>.<span class="hljs-property">python</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">PythonOperator</span>

def <span class="hljs-title function_">_print_vars</span>():
    my_vars = <span class="hljs-title class_">Variable</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'my_vars'</span>, deserialize_json=<span class="hljs-title class_">True</span>)
    <span class="hljs-title function_">print</span>(my_vars[<span class="hljs-string">'key1'</span>])
    <span class="hljs-title function_">print</span>(my_vars[<span class="hljs-string">'key2'</span>])
    <span class="hljs-title function_">print</span>(my_vars[<span class="hljs-string">'key3'</span>])

<span class="hljs-keyword">with</span> <span class="hljs-title function_">DAG</span>(<span class="hljs-string">'my_dag'</span>, start_date=<span class="hljs-title function_">datetime</span>(<span class="hljs-number">2024</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> <span class="hljs-attr">dag</span>:
    print_var = <span class="hljs-title class_">PythonOperator</span>(
        task_id=<span class="hljs-string">'print_vars'</span>,
        python_callable=_print_vars,
    )
</code></pre>
<h1>최종 생각..</h1>
<!-- TIL 수평 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="1549334788" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>에어플로우 변수 선언은 간단하지만, 가장 좋은 방법을 적용하지 않으면 메타스토어 데이터베이스에서 가져오는 과정이 악몽이 될 수 있습니다.</p>
<p>이 튜토리얼에서는 여섯 가지 다른 방법으로 에어플로우 변수를 생성하는 방법을 보여드렸습니다. 각 접근 방식에는 장단점이 있으며, 그에 맞춰 사용해야 합니다. 프로덕션 배포에서의 최상의 관례는 보안과 이식성을 제공하는 백엔드 시크릿을 사용하는 것입니다.</p>
<p>더 중요한 건, 에어플로우 데이터베이스를 과부하시키지 않기 위해 피해야 할 기술들과 변수 구조 활용의 최적화 방법에 대해 논의했습니다. 이제 변수는 템플릿 참조를 통해 유추하거나 작업 함수 정의 내에서 정의되어야 한다는 점이 분명해졌기를 바랍니다.</p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Airflow 변수 완전 정복하는 방법","description":"","date":"2024-07-13 20:34","slug":"2024-07-13-MasteringAirflowVariables","content":"\n\n\u003cimg src=\"/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png\" /\u003e\n\n만약 여러 데이터 파이프라인이 동일한 API 엔드포인트와 상호 작용해야 하는 상황이 있다면, 정말 모든 파이프라인에서 이 엔드포인트를 선언해야 할까요? 이 엔드포인트가 나중에 변경된다면, 모든 파일에서 해당 값을 업데이트해야 합니다.\n\nAirflow 변수는 간단하면서도 가치 있는 구조로, 여러 DAG에서 중복 선언을 방지하는 데 사용됩니다. 이들은 단순히 키와 JSON 직렬화 가능한 값으로 구성된 객체로, Airflow의 메타데이터베이스에 저장됩니다.\n\n그리고 코드가 토큰이나 기타 유형의 비밀을 사용한다면 어떻게 해야 할까요? 평문으로 하드코딩하는 것은 안전한 접근 방식으로 보이지 않습니다. 반복을 줄이는 데 beyond하는 Airflow 변수는 민감한 정보를 관리하는 데도 도움이 됩니다. Airflow에서 변수를 정의하는 여섯 가지 다양한 방법 중에서 적합한 방법을 선택하는 것은 보안과 이식성을 보장하기 위해 중요합니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n자주 간과되는 측면 중 하나는 변수 검색이 Airflow 성능에 미치는 영향입니다. 스케줄러가 DAG 파일을 파싱할 때마다 메타데이터베이스에 요청하는 것은 성능에 부담이 될 수 있습니다(기본값은 삼십 초입니다).\n\n이 함정에 빠지기는 꽤 쉽습니다. DAG를 구문 분석하는 방법과 데이터베이스에서 변수를 검색하는 방법을 이해하지 않는 한요하는 베스트 프렉티스를 적용하는 것이 중요합니다.\n\n# Airflow 변수 정의\n\nDAG 파일을 파싱하는 방법과 DAGs를 최적화하기 위해 적용해야 하는 베스트 프렉티스에 대해 논의하기 전에, 기초를 제대로 이해하는 것이 중요합니다. 여기서는 어떻게 Airflow에서 변수를 선언하는지에만 초점을 맞춰 보겠습니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n이미 언급한 바와 같이, Airflow에서 변수를 선언하는 여러 가지 방법이 있습니다. 그 중 일부는 다른 것보다 더 안전하고 이식성이 뛰어난 것으로 나타나므로, 이들의 장단점을 살펴보고 이해해 봅시다.\n\n## 1. 사용자 인터페이스에서 변수 생성\n\n첫 번째 방법으로, 사용자 인터페이스를 통해 변수를 생성하는 방법을 살펴보겠습니다. 상위 메뉴에서 Admin → Variables → + 를 선택합니다.\n\n키와 값을 입력한 후, 만들기를 클릭하여 생성합니다. 변수는 이제 변수 목록에서 확인할 수 있어야 합니다. 기본적으로 UI에서 생성된 변수는 자동으로 메타데이터 데이터베이스에 저장됩니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n변수 값이 평문으로 표시된다는 것을 알 수 있어요. Airflow 변수 중 민감한 정보를 저장하려면 UI 방식이 가장 적합하지 않을 수 있어요.\n\n또한, 이 방법은 이식성이 떨어집니다. 환경을 재생성하려면 먼저 현재 환경에서 수동으로 내보내고, 마지막으로 새로 만든 환경으로 다시 가져와야 해요.\n\n## 2. 환경 변수를 내보내어 변수 생성하기\n\n두 번째 옵션은 AIRFLOW_VAR_`변수_이름` 표기법을 사용하여 환경 변수를 내보내는 것이에요.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n다음 명령어를 사용하여 두 변수인 foo와 bar를 생성할 수 있습니다.\n\n```js\nexport AIRFLOW_VAR_FOO=my_value\nexport AIRFLOW_VAR_BAR='{\"newsletter\":\"Data Pipeline\"}'\n```\n\n이 방법의 장점 중 하나는 환경 변수를 통해 생성된 변수가 UI에 표시되지 않는다는 것입니다(물론 코드에서 참조할 수는 있습니다). 즉, 민감한 정보가 노출되지 않습니다.\n\nUI를 통해 생성된 변수와는 달리, 이 방법은 메타데이터베이스에 지속적으로 저장하지 않습니다. 따라서 환경 변수를 사용하면 데이터베이스 연결을 설정할 필요가 없어 빠르게 검색할 수 있습니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n하지만 여전히 환경 변수를 관리하는 것도 어려울 수 있습니다. 환경 변수가 Airflow 배포를 담당하는 자동화 스크립트에서 사용되는 파일에 저장된 경우 값들을 어떻게 안전하게 보호할 수 있을까요?\n\n## 3. Airflow CLI를 통한 변수 생성\n\nAirflow CLI를 사용하여 변수를 생성할 수도 있습니다. 먼저 Airflow 스케줄러 워커에 연결해야 합니다. 예를 들어 Docker를 통해 Airflow를 실행 중이라면, 먼저 스케줄러의 컨테이너 ID를 찾은 다음 다음 명령을 실행하세요.\n\n```js\ndocker exec -it \u003cairflow-scheduler-container-id\u003e /bin/bash\n```\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\nAirflow 변수를 만들려면 다음의 명령어를 사용할 수 있어요:\n\n```js\nairflow variables set \\\n    my_cli_var \\\n    my_value \\\n    --description '이 변수는 CLI를 통해 생성되었어요'\n```\n\n만약 특정 변수에 여러 값을 할당하려면 JSON 형식을 사용하는 것이 좋아요:\n\n```js\nairflow variables set \\\n    my_cli_json_var \\\n    '{\"key\": \"value\", \"another_key\": \"another_value\"}' \\\n    --description '이 변수는 CLI를 통해 생성되었어요'\n```\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\nJSON 변수를 직렬화하는 옵션도 있습니다. 이를 위해 -j 또는 --json 플래그를 제공하여 수행할 수 있습니다.\n\n```js\nairflow variables set \\\n    --json \\\n    my_cli_serialised_json_var \\\n    '{\"key\": \"value\", \"another_key\": \"another_value\"}' \\\n    --description 'CLI를 통해 생성된 이 변수'\n```\n\n이제 UI의 변수 목록으로 돌아가보면, 이전 단계에서 만든 세 가지 변수가 모두 표시됩니다.\n\nCLI를 통해 생성된 변수는 UI에서 확인할 수 있어 민감한 정보도 노출되고 메타데이터베이스에 저장될 수 있습니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n내 의견으로는, 이 방법은 개발 환경에서 유용합니다. 특정 변수를 빠르게 생성하고 테스트하거나 해당 변수를 참조하는 기능을 테스트하고 싶을 때 유용합니다. 프로덕션 배포의 경우, 변수를 생성(또는 업데이트)하기 위한 자동화 스크립트를 작성해야 하며, 이 정보는 파일에 저장되어야 합니다. 그렇기 때문에 몇 가지 변수에는 민감한 정보가 포함될 수 있어 처리하기 어려울 수 있습니다.\n\n## 4. REST API를 사용하여 변수 생성\n\n이 네 번째 방법은 REST API를 호출하여 몇 가지 변수를 생성하는 것을 포함합니다. 이는 Airflow CLI 방식과 유사하며 동일한 장단점을 제공합니다.\n\n```js\ncurl -X POST ${AIRFLOW_URL}/api/v1/variables \\\n        -H \"Content-Type: application/json\" \\\n        --user \"${AIRFLOW_USERNAME}:${AIRFLOW_PASSWORD}\" \\\n        -d '{\"key\": \"json_var\", \"value\": \"{\\\"key1\\\":\\\"val1\\\"}\"}'\n```\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## 5. 변수를 프로그래밍적으로 생성하기\n\n프로그래밍적으로 변수를 생성하는 것도 실행 가능하고 간단합니다.\n\n```js\ndef create_vars():\n    from airflow.models import Variable\n\n    Variable.set(key='my_var', value='my_val')\n    Variable.set(\n        key='my_json_var', \n        value={'my_key': 23, 'another_key': 'another_val'}, \n        serialize_json=True,\n    )\n\n...\n\nPythonOperator(\n    task_id='create_variables',\n    python_callable=create_vars,\n)\n```\n\n물론 이것은 나쁜 관행이며 프로덕션 배포에서 피해야 합니다. 변수 - 특히 민감한 정보를 포함하는 변수 - 는 DAG 파일에서 선언되어서는 안 되며 코드는 버전 관리되고 UI의 코드 탭에서도 볼 수 있기 때문입니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## 6. 시크릿 스토어/백엔드에서 변수 만들기 ❤\n\n환경 변수나 메타스토어 데이터베이스에서 변수를 검색하는 것 외에도 Airflow 변수를 검색하기 위해 대체 시크릿 백엔드를 활성화할 수 있습니다.\n\n현재 Apache Airflow 커뮤니티에서 제공하는 시크릿 백엔드 구현에는 다음이 포함됩니다:\n\n- Amazon (Secrets Manager 및 Systems Manager Parameter Store)\n- Google (Cloud Secret Manager)\n- Microsoft (Azure Key Vault)\n- HashiCorp (Vault)\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n사실, Airflow에서 변수를 정의하는 가장 좋고 안전하며 휴대성이 뛰어난 방법입니다.\n\n# 민감한 변수 값 숨기기\n\n이전 섹션에서 설명한 몇 가지 방법 중 일부에서 민감한 정보가 실제로 사용자 인터페이스에 표시될 수 있다고 언급했습니다. 사실, 변수가 올바르게 이름 지어진 경우에는 민감한 값을 숨길 수 있습니다.\n\n변수 이름에 특정 키워드가 포함되어 민감한 정보를 나타낼 수 있다고 생각되면 해당 값이 자동으로 숨겨집니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n다음은 민감한 정보를 값으로 저장하게끔 변수를 자격 부여할 키워드 목록입니다:\n\n```js\naccess_token\napi_key\napikey\nauthorization\npassphrase\npasswd\npassword\nprivate_key\nsecret\ntoken\nkeyfile_dict\nservice_account\n```\n\n만약 변수 이름에 이 키워드 중 하나가 포함되어 있다면, Airflow는 해당 값을 적절히 처리할 것입니다. 이 기능이 예상대로 작동하는지 확인하기 위해 예제를 시도해 보겠습니다.\n\n먼저, 위에 언급된 키워드 중 하나를 추가하지 않고 새 변수를 만들어 보겠습니다. 우리는 변수의 값이 사용자 인터페이스에서 보이는 것을 확인할 수 있습니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n다음 화면에서는 새로운 변수인 my_api_key를 생성하려고 시도합니다. 이전에 토론한 대로 변수 이름에 api_key 키워드가 포함되어 있기 때문에 Airflow는 민감한 정보를 보호하는 방식으로 해당 값을 처리해야 합니다.\n\n실제로 지금 UI의 변수 목록으로 돌아가보면 새로 생성된 변수의 값을 숨겨진 것을 볼 수 있습니다.\n\n기존 키워드 목록에 만족스럽지 않다면, 추가적인 키워드를 지정하여 변수 값 숨김 시 고려해야 하는 키워드 목록을 확장할 수도 있습니다. 이는 airflow.cfg( [core] 섹션 내)의 sensitive_var_conn_names를 통해 구성하거나 AIRFLOW__CORE__SENSITIVE_VAR_CONN_NAMES 환경 변수를 내보내는 것으로 설정할 수 있습니다.\n\n# 효율적인 변수 검색\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n기본 설정으로 Airflow DAG는 30초마다 구문 분석됩니다. 스케줄러는 DAG 폴더를 스캔하여 DAG 파일에 대한 변경 사항을 식별합니다. 변수를 올바르게 가져오지 않으면 DAG 구문 분석 프로세스가 곧 병목 현상이 될 수 있습니다.\n\n변수를 선언하는 방법에 따라 Airflow는 DAG 파일에서 선언된 각 변수에 대해 메타스토어 데이터베이스에 연결을 초기화해야 할 수 있습니다.\n\n# 요청으로 메타스토어 과부하 피하기\n\nDAG에서 변수를 검색하기 위해 두 가지 접근 방식을 취할 수 있습니다:\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n- Variable.get() 함수 사용\n- var 템플릿 변수 사용\n\n만약 첫 번째 옵션을 선택하신 경우, Variable.get()은 지정된 변수의 값을 추론하기 위해 메타스토어 데이터베이스와의 새로운 연결을 생성할 것입니다. 이제 DAG 파일에서 이 함수를 호출하는 위치는 성능에 큰 영향을 미칠 수 있습니다.\n\n## 잘못된 예시\n\n만약 이 함수가 태스크 외부에서 호출되거나 DAG Context Manager 내에서 호출된다면, 메타스토어와의 -의미 없는- 새로운 연결이 DAG가 파싱될 때마다 생성될 것입니다(즉, 30초마다).\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```python\nfrom datetime import datetime\n\nfrom airflow import DAG\nfrom airflow.models import Variable\nfrom airflow.operators.python import PythonOperator\n\nmy_var = Variable.get('my_var')\n\nwith DAG('my_dag', start_date=datetime(2024, 1, 1)) as dag:\n    print_var = PythonOperator(\n        task_id='print_var',\n        python_callable=lambda: print(my_var),\n    )\n```\n\n만약 동일한 패턴이 많은 다른 DAG에서 사용된다면, 언젠가는 메타스토어 데이터베이스에 문제가 발생할 수 있습니다.\n\n실제로 이 패턴을 피할 수 없는 몇 가지 예외적인 상황이 있습니다. 예를 들어 변수의 값에 따라 동적으로 작업을 생성하고 싶다고 가정해보겠습니다. 그 경우 해당 함수를 작업 외부에서 호출하거나 Context Manager 내에서 호출해야 할 수도 있습니다. 하지만 가능하면 이 접근 방식을 피하는 것이 중요합니다.\n\n또한, 연산자의 인수에서 Variable.get() 함수를 호출하더라도 동일한 문제가 발생할 것임을 언급하는 것이 중요합니다.\n\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```python\nfrom datetime import datetime\n\nfrom airflow import DAG\nfrom airflow.models import Variable\nfrom airflow.operators.python import PythonOperator\n\ndef _print_var(my_var):\n    print(my_var)\nwith DAG('my_dag', start_date=datetime(2024, 1, 1)) as dag:\n    print_var = PythonOperator(\n        task_id='print_var',\n        python_callable=_print_var,\n        op_args=[Variable.get('my_var')],\n    )\n```\n\n사실 템플릿 엔진을 사용하면 이런 문제를 쉽게 피할 수 있어요.\n\n## Best Practices\n\n기본적으로 Variable.get()를 호출하는 대신에 템플릿 참조를 사용할 수 있어요. 이 기술을 사용하면 변수의 값은 런타임에만 가져와지게 돼요.\n\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n아래의 코드 스니펫은 JSON 또는 JSON이 아닌 값에 대한 변수의 템플릿 참조를 사용하는 방법을 보여줍니다.\n\n```js\nfrom datetime import datetime\n\nfrom airflow import DAG\nfrom airflow.models import Variable\nfrom airflow.operators.python import PythonOperator\n\ndef _print_var(val1, val2, val3, val4):\n    print(val1)\n    print(val2)\n    print(val3)\n    print(val4)\n\nwith DAG('my_dag', start_date=datetime(2024, 1, 1)) as dag:\n    print_var = PythonOperator(\n        task_id='print_var',\n        python_callable=_print_var,\n        op_args=[\n            '{ var.value.my_var }',\n            '{ var.json.my_vars.key1 }',\n            '{ var.json.my_vars.key2 }',\n            '{ var.json.my_vars.key3 }',\n        ],\n    )\n```\n\n그러나 템플릿 엔진 접근 방식은 템플릿 참조를 제공할 인수에 대해 오퍼레이터가 템플릿화된 필드를 지원하는 경우에만 적용됩니다.\n\n템플릿 참조가 작동하지 않는 경우에는 여전히 Variable.get()이 작업 내에서 호출되도록하여 매번 DAG가 구문 분석될 때 메타스토어 데이터베이스로의 연결이 초기화되지 않도록 할 수 있습니다.\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```python\nfrom datetime import datetime\n\nfrom airflow import DAG\nfrom airflow.models import Variable\nfrom airflow.operators.python import PythonOperator\n\ndef _print_var():\n    my_var = Variable.get('my_var')\n    print(my_var)\n\nwith DAG('my_dag', start_date=datetime(2024, 1, 1)) as dag:\n    print_var = PythonOperator(\n        task_id='print_var',\n        python_callable=_print_var,\n    )\n```\n\n# 단일 변수에 여러 값을 저장하기\n\n이제 특정 DAG가 세 가지 다른 값을 검색해야 한다고 가정해 봅시다. 이전 섹션에서 소개된 최선의 방법을 따르더라도 메타스토어 데이터베이스에 대해 세 개의 개별 연결을 시작해야 합니다.\n\n```python\nfrom datetime import datetime\n\nfrom airflow import DAG\nfrom airflow.models import Variable\nfrom airflow.operators.python import PythonOperator\n\ndef _print_vars():\n    my_var = Variable.get('my_var')\n    another_var = Variable.get('another_var')\n    one_more_var = Variable.get('one_more_var')\n    print(my_var)\n    print(another_var)\n    print(one_more_var)\n\nwith DAG('my_dag', start_date=datetime(2024, 1, 1)) as dag:\n    print_var = PythonOperator(\n        task_id='print_vars',\n        python_callable=_print_vars,\n    )\n```\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n대신, 세 개의 키-값 쌍으로 구성된 단일 JSON 변수를 생성할 수 있습니다. 당연히 이 작업은 세 값을 한 변수로 압축하는 데 논리적으로 의미가 있는 한 수행해야 합니다.\n\n이제 메타스토어 데이터베이스로의 연결을 한 번만 수행하여 변수에서 지정된 모든 키의 값을 검색할 수 있습니다.\n\n```js\nfrom datetime import datetime\n\nfrom airflow import DAG\nfrom airflow.models import Variable\nfrom airflow.operators.python import PythonOperator\n\ndef _print_vars():\n    my_vars = Variable.get('my_vars', deserialize_json=True)\n    print(my_vars['key1'])\n    print(my_vars['key2'])\n    print(my_vars['key3'])\n\nwith DAG('my_dag', start_date=datetime(2024, 1, 1)) as dag:\n    print_var = PythonOperator(\n        task_id='print_vars',\n        python_callable=_print_vars,\n    )\n```\n\n# 최종 생각..\n\n\u003c!-- TIL 수평 --\u003e\n\u003cins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n에어플로우 변수 선언은 간단하지만, 가장 좋은 방법을 적용하지 않으면 메타스토어 데이터베이스에서 가져오는 과정이 악몽이 될 수 있습니다.\n\n이 튜토리얼에서는 여섯 가지 다른 방법으로 에어플로우 변수를 생성하는 방법을 보여드렸습니다. 각 접근 방식에는 장단점이 있으며, 그에 맞춰 사용해야 합니다. 프로덕션 배포에서의 최상의 관례는 보안과 이식성을 제공하는 백엔드 시크릿을 사용하는 것입니다.\n\n더 중요한 건, 에어플로우 데이터베이스를 과부하시키지 않기 위해 피해야 할 기술들과 변수 구조 활용의 최적화 방법에 대해 논의했습니다. 이제 변수는 템플릿 참조를 통해 유추하거나 작업 함수 정의 내에서 정의되어야 한다는 점이 분명해졌기를 바랍니다.","ogImage":{"url":"/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png"},"coverImage":"/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png","tag":["Tech"],"readingTime":17},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cimg src=\"/TIL/assets/img/2024-07-13-MasteringAirflowVariables_0.png\"\u003e\n\u003cp\u003e만약 여러 데이터 파이프라인이 동일한 API 엔드포인트와 상호 작용해야 하는 상황이 있다면, 정말 모든 파이프라인에서 이 엔드포인트를 선언해야 할까요? 이 엔드포인트가 나중에 변경된다면, 모든 파일에서 해당 값을 업데이트해야 합니다.\u003c/p\u003e\n\u003cp\u003eAirflow 변수는 간단하면서도 가치 있는 구조로, 여러 DAG에서 중복 선언을 방지하는 데 사용됩니다. 이들은 단순히 키와 JSON 직렬화 가능한 값으로 구성된 객체로, Airflow의 메타데이터베이스에 저장됩니다.\u003c/p\u003e\n\u003cp\u003e그리고 코드가 토큰이나 기타 유형의 비밀을 사용한다면 어떻게 해야 할까요? 평문으로 하드코딩하는 것은 안전한 접근 방식으로 보이지 않습니다. 반복을 줄이는 데 beyond하는 Airflow 변수는 민감한 정보를 관리하는 데도 도움이 됩니다. Airflow에서 변수를 정의하는 여섯 가지 다양한 방법 중에서 적합한 방법을 선택하는 것은 보안과 이식성을 보장하기 위해 중요합니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e자주 간과되는 측면 중 하나는 변수 검색이 Airflow 성능에 미치는 영향입니다. 스케줄러가 DAG 파일을 파싱할 때마다 메타데이터베이스에 요청하는 것은 성능에 부담이 될 수 있습니다(기본값은 삼십 초입니다).\u003c/p\u003e\n\u003cp\u003e이 함정에 빠지기는 꽤 쉽습니다. DAG를 구문 분석하는 방법과 데이터베이스에서 변수를 검색하는 방법을 이해하지 않는 한요하는 베스트 프렉티스를 적용하는 것이 중요합니다.\u003c/p\u003e\n\u003ch1\u003eAirflow 변수 정의\u003c/h1\u003e\n\u003cp\u003eDAG 파일을 파싱하는 방법과 DAGs를 최적화하기 위해 적용해야 하는 베스트 프렉티스에 대해 논의하기 전에, 기초를 제대로 이해하는 것이 중요합니다. 여기서는 어떻게 Airflow에서 변수를 선언하는지에만 초점을 맞춰 보겠습니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e이미 언급한 바와 같이, Airflow에서 변수를 선언하는 여러 가지 방법이 있습니다. 그 중 일부는 다른 것보다 더 안전하고 이식성이 뛰어난 것으로 나타나므로, 이들의 장단점을 살펴보고 이해해 봅시다.\u003c/p\u003e\n\u003ch2\u003e1. 사용자 인터페이스에서 변수 생성\u003c/h2\u003e\n\u003cp\u003e첫 번째 방법으로, 사용자 인터페이스를 통해 변수를 생성하는 방법을 살펴보겠습니다. 상위 메뉴에서 Admin → Variables → + 를 선택합니다.\u003c/p\u003e\n\u003cp\u003e키와 값을 입력한 후, 만들기를 클릭하여 생성합니다. 변수는 이제 변수 목록에서 확인할 수 있어야 합니다. 기본적으로 UI에서 생성된 변수는 자동으로 메타데이터 데이터베이스에 저장됩니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e변수 값이 평문으로 표시된다는 것을 알 수 있어요. Airflow 변수 중 민감한 정보를 저장하려면 UI 방식이 가장 적합하지 않을 수 있어요.\u003c/p\u003e\n\u003cp\u003e또한, 이 방법은 이식성이 떨어집니다. 환경을 재생성하려면 먼저 현재 환경에서 수동으로 내보내고, 마지막으로 새로 만든 환경으로 다시 가져와야 해요.\u003c/p\u003e\n\u003ch2\u003e2. 환경 변수를 내보내어 변수 생성하기\u003c/h2\u003e\n\u003cp\u003e두 번째 옵션은 AIRFLOW_VAR_\u003ccode\u003e변수_이름\u003c/code\u003e 표기법을 사용하여 환경 변수를 내보내는 것이에요.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e다음 명령어를 사용하여 두 변수인 foo와 bar를 생성할 수 있습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAIRFLOW_VAR_FOO\u003c/span\u003e=my_value\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAIRFLOW_VAR_BAR\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'{\"newsletter\":\"Data Pipeline\"}'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이 방법의 장점 중 하나는 환경 변수를 통해 생성된 변수가 UI에 표시되지 않는다는 것입니다(물론 코드에서 참조할 수는 있습니다). 즉, 민감한 정보가 노출되지 않습니다.\u003c/p\u003e\n\u003cp\u003eUI를 통해 생성된 변수와는 달리, 이 방법은 메타데이터베이스에 지속적으로 저장하지 않습니다. 따라서 환경 변수를 사용하면 데이터베이스 연결을 설정할 필요가 없어 빠르게 검색할 수 있습니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e하지만 여전히 환경 변수를 관리하는 것도 어려울 수 있습니다. 환경 변수가 Airflow 배포를 담당하는 자동화 스크립트에서 사용되는 파일에 저장된 경우 값들을 어떻게 안전하게 보호할 수 있을까요?\u003c/p\u003e\n\u003ch2\u003e3. Airflow CLI를 통한 변수 생성\u003c/h2\u003e\n\u003cp\u003eAirflow CLI를 사용하여 변수를 생성할 수도 있습니다. 먼저 Airflow 스케줄러 워커에 연결해야 합니다. 예를 들어 Docker를 통해 Airflow를 실행 중이라면, 먼저 스케줄러의 컨테이너 ID를 찾은 다음 다음 명령을 실행하세요.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003edocker exec -it \u0026#x3C;airflow-scheduler-container-id\u003e \u003cspan class=\"hljs-regexp\"\u003e/bin/\u003c/span\u003ebash\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003eAirflow 변수를 만들려면 다음의 명령어를 사용할 수 있어요:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eairflow variables set \\\n    my_cli_var \\\n    my_value \\\n    --description \u003cspan class=\"hljs-string\"\u003e'이 변수는 CLI를 통해 생성되었어요'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e만약 특정 변수에 여러 값을 할당하려면 JSON 형식을 사용하는 것이 좋아요:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eairflow variables set \\\n    my_cli_json_var \\\n    \u003cspan class=\"hljs-string\"\u003e'{\"key\": \"value\", \"another_key\": \"another_value\"}'\u003c/span\u003e \\\n    --description \u003cspan class=\"hljs-string\"\u003e'이 변수는 CLI를 통해 생성되었어요'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003eJSON 변수를 직렬화하는 옵션도 있습니다. 이를 위해 -j 또는 --json 플래그를 제공하여 수행할 수 있습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eairflow variables set \\\n    --json \\\n    my_cli_serialised_json_var \\\n    \u003cspan class=\"hljs-string\"\u003e'{\"key\": \"value\", \"another_key\": \"another_value\"}'\u003c/span\u003e \\\n    --description \u003cspan class=\"hljs-string\"\u003e'CLI를 통해 생성된 이 변수'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이제 UI의 변수 목록으로 돌아가보면, 이전 단계에서 만든 세 가지 변수가 모두 표시됩니다.\u003c/p\u003e\n\u003cp\u003eCLI를 통해 생성된 변수는 UI에서 확인할 수 있어 민감한 정보도 노출되고 메타데이터베이스에 저장될 수 있습니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e내 의견으로는, 이 방법은 개발 환경에서 유용합니다. 특정 변수를 빠르게 생성하고 테스트하거나 해당 변수를 참조하는 기능을 테스트하고 싶을 때 유용합니다. 프로덕션 배포의 경우, 변수를 생성(또는 업데이트)하기 위한 자동화 스크립트를 작성해야 하며, 이 정보는 파일에 저장되어야 합니다. 그렇기 때문에 몇 가지 변수에는 민감한 정보가 포함될 수 있어 처리하기 어려울 수 있습니다.\u003c/p\u003e\n\u003ch2\u003e4. REST API를 사용하여 변수 생성\u003c/h2\u003e\n\u003cp\u003e이 네 번째 방법은 REST API를 호출하여 몇 가지 변수를 생성하는 것을 포함합니다. 이는 Airflow CLI 방식과 유사하며 동일한 장단점을 제공합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003ecurl -X \u003cspan class=\"hljs-variable constant_\"\u003ePOST\u003c/span\u003e ${\u003cspan class=\"hljs-variable constant_\"\u003eAIRFLOW_URL\u003c/span\u003e}/api/v1/variables \\\n        -H \u003cspan class=\"hljs-string\"\u003e\"Content-Type: application/json\"\u003c/span\u003e \\\n        --user \u003cspan class=\"hljs-string\"\u003e\"${AIRFLOW_USERNAME}:${AIRFLOW_PASSWORD}\"\u003c/span\u003e \\\n        -d \u003cspan class=\"hljs-string\"\u003e'{\"key\": \"json_var\", \"value\": \"{\\\"key1\\\":\\\"val1\\\"}\"}'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003e5. 변수를 프로그래밍적으로 생성하기\u003c/h2\u003e\n\u003cp\u003e프로그래밍적으로 변수를 생성하는 것도 실행 가능하고 간단합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003edef \u003cspan class=\"hljs-title function_\"\u003ecreate_vars\u003c/span\u003e():\n    \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.\u003cspan class=\"hljs-property\"\u003emodels\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eVariable\u003c/span\u003e\n\n    \u003cspan class=\"hljs-title class_\"\u003eVariable\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(key=\u003cspan class=\"hljs-string\"\u003e'my_var'\u003c/span\u003e, value=\u003cspan class=\"hljs-string\"\u003e'my_val'\u003c/span\u003e)\n    \u003cspan class=\"hljs-title class_\"\u003eVariable\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(\n        key=\u003cspan class=\"hljs-string\"\u003e'my_json_var'\u003c/span\u003e, \n        value={\u003cspan class=\"hljs-string\"\u003e'my_key'\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e23\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'another_key'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'another_val'\u003c/span\u003e}, \n        serialize_json=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e,\n    )\n\n...\n\n\u003cspan class=\"hljs-title class_\"\u003ePythonOperator\u003c/span\u003e(\n    task_id=\u003cspan class=\"hljs-string\"\u003e'create_variables'\u003c/span\u003e,\n    python_callable=create_vars,\n)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e물론 이것은 나쁜 관행이며 프로덕션 배포에서 피해야 합니다. 변수 - 특히 민감한 정보를 포함하는 변수 - 는 DAG 파일에서 선언되어서는 안 되며 코드는 버전 관리되고 UI의 코드 탭에서도 볼 수 있기 때문입니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003e6. 시크릿 스토어/백엔드에서 변수 만들기 ❤\u003c/h2\u003e\n\u003cp\u003e환경 변수나 메타스토어 데이터베이스에서 변수를 검색하는 것 외에도 Airflow 변수를 검색하기 위해 대체 시크릿 백엔드를 활성화할 수 있습니다.\u003c/p\u003e\n\u003cp\u003e현재 Apache Airflow 커뮤니티에서 제공하는 시크릿 백엔드 구현에는 다음이 포함됩니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAmazon (Secrets Manager 및 Systems Manager Parameter Store)\u003c/li\u003e\n\u003cli\u003eGoogle (Cloud Secret Manager)\u003c/li\u003e\n\u003cli\u003eMicrosoft (Azure Key Vault)\u003c/li\u003e\n\u003cli\u003eHashiCorp (Vault)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e사실, Airflow에서 변수를 정의하는 가장 좋고 안전하며 휴대성이 뛰어난 방법입니다.\u003c/p\u003e\n\u003ch1\u003e민감한 변수 값 숨기기\u003c/h1\u003e\n\u003cp\u003e이전 섹션에서 설명한 몇 가지 방법 중 일부에서 민감한 정보가 실제로 사용자 인터페이스에 표시될 수 있다고 언급했습니다. 사실, 변수가 올바르게 이름 지어진 경우에는 민감한 값을 숨길 수 있습니다.\u003c/p\u003e\n\u003cp\u003e변수 이름에 특정 키워드가 포함되어 민감한 정보를 나타낼 수 있다고 생각되면 해당 값이 자동으로 숨겨집니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e다음은 민감한 정보를 값으로 저장하게끔 변수를 자격 부여할 키워드 목록입니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eaccess_token\napi_key\napikey\nauthorization\npassphrase\npasswd\npassword\nprivate_key\nsecret\ntoken\nkeyfile_dict\nservice_account\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e만약 변수 이름에 이 키워드 중 하나가 포함되어 있다면, Airflow는 해당 값을 적절히 처리할 것입니다. 이 기능이 예상대로 작동하는지 확인하기 위해 예제를 시도해 보겠습니다.\u003c/p\u003e\n\u003cp\u003e먼저, 위에 언급된 키워드 중 하나를 추가하지 않고 새 변수를 만들어 보겠습니다. 우리는 변수의 값이 사용자 인터페이스에서 보이는 것을 확인할 수 있습니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e다음 화면에서는 새로운 변수인 my_api_key를 생성하려고 시도합니다. 이전에 토론한 대로 변수 이름에 api_key 키워드가 포함되어 있기 때문에 Airflow는 민감한 정보를 보호하는 방식으로 해당 값을 처리해야 합니다.\u003c/p\u003e\n\u003cp\u003e실제로 지금 UI의 변수 목록으로 돌아가보면 새로 생성된 변수의 값을 숨겨진 것을 볼 수 있습니다.\u003c/p\u003e\n\u003cp\u003e기존 키워드 목록에 만족스럽지 않다면, 추가적인 키워드를 지정하여 변수 값 숨김 시 고려해야 하는 키워드 목록을 확장할 수도 있습니다. 이는 airflow.cfg( [core] 섹션 내)의 sensitive_var_conn_names를 통해 구성하거나 AIRFLOW__CORE__SENSITIVE_VAR_CONN_NAMES 환경 변수를 내보내는 것으로 설정할 수 있습니다.\u003c/p\u003e\n\u003ch1\u003e효율적인 변수 검색\u003c/h1\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e기본 설정으로 Airflow DAG는 30초마다 구문 분석됩니다. 스케줄러는 DAG 폴더를 스캔하여 DAG 파일에 대한 변경 사항을 식별합니다. 변수를 올바르게 가져오지 않으면 DAG 구문 분석 프로세스가 곧 병목 현상이 될 수 있습니다.\u003c/p\u003e\n\u003cp\u003e변수를 선언하는 방법에 따라 Airflow는 DAG 파일에서 선언된 각 변수에 대해 메타스토어 데이터베이스에 연결을 초기화해야 할 수 있습니다.\u003c/p\u003e\n\u003ch1\u003e요청으로 메타스토어 과부하 피하기\u003c/h1\u003e\n\u003cp\u003eDAG에서 변수를 검색하기 위해 두 가지 접근 방식을 취할 수 있습니다:\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cul\u003e\n\u003cli\u003eVariable.get() 함수 사용\u003c/li\u003e\n\u003cli\u003evar 템플릿 변수 사용\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e만약 첫 번째 옵션을 선택하신 경우, Variable.get()은 지정된 변수의 값을 추론하기 위해 메타스토어 데이터베이스와의 새로운 연결을 생성할 것입니다. 이제 DAG 파일에서 이 함수를 호출하는 위치는 성능에 큰 영향을 미칠 수 있습니다.\u003c/p\u003e\n\u003ch2\u003e잘못된 예시\u003c/h2\u003e\n\u003cp\u003e만약 이 함수가 태스크 외부에서 호출되거나 DAG Context Manager 내에서 호출된다면, 메타스토어와의 -의미 없는- 새로운 연결이 DAG가 파싱될 때마다 생성될 것입니다(즉, 30초마다).\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e datetime \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e datetime\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e DAG\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Variable\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.operators.python \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e PythonOperator\n\nmy_var = Variable.get(\u003cspan class=\"hljs-string\"\u003e'my_var'\u003c/span\u003e)\n\n\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e DAG(\u003cspan class=\"hljs-string\"\u003e'my_dag'\u003c/span\u003e, start_date=datetime(\u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e dag:\n    print_var = PythonOperator(\n        task_id=\u003cspan class=\"hljs-string\"\u003e'print_var'\u003c/span\u003e,\n        python_callable=\u003cspan class=\"hljs-keyword\"\u003elambda\u003c/span\u003e: \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(my_var),\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e만약 동일한 패턴이 많은 다른 DAG에서 사용된다면, 언젠가는 메타스토어 데이터베이스에 문제가 발생할 수 있습니다.\u003c/p\u003e\n\u003cp\u003e실제로 이 패턴을 피할 수 없는 몇 가지 예외적인 상황이 있습니다. 예를 들어 변수의 값에 따라 동적으로 작업을 생성하고 싶다고 가정해보겠습니다. 그 경우 해당 함수를 작업 외부에서 호출하거나 Context Manager 내에서 호출해야 할 수도 있습니다. 하지만 가능하면 이 접근 방식을 피하는 것이 중요합니다.\u003c/p\u003e\n\u003cp\u003e또한, 연산자의 인수에서 Variable.get() 함수를 호출하더라도 동일한 문제가 발생할 것임을 언급하는 것이 중요합니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e datetime \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e datetime\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e DAG\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Variable\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.operators.python \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e PythonOperator\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e_print_var\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003emy_var\u003c/span\u003e):\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(my_var)\n\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e DAG(\u003cspan class=\"hljs-string\"\u003e'my_dag'\u003c/span\u003e, start_date=datetime(\u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e dag:\n    print_var = PythonOperator(\n        task_id=\u003cspan class=\"hljs-string\"\u003e'print_var'\u003c/span\u003e,\n        python_callable=_print_var,\n        op_args=[Variable.get(\u003cspan class=\"hljs-string\"\u003e'my_var'\u003c/span\u003e)],\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e사실 템플릿 엔진을 사용하면 이런 문제를 쉽게 피할 수 있어요.\u003c/p\u003e\n\u003ch2\u003eBest Practices\u003c/h2\u003e\n\u003cp\u003e기본적으로 Variable.get()를 호출하는 대신에 템플릿 참조를 사용할 수 있어요. 이 기술을 사용하면 변수의 값은 런타임에만 가져와지게 돼요.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e아래의 코드 스니펫은 JSON 또는 JSON이 아닌 값에 대한 변수의 템플릿 참조를 사용하는 방법을 보여줍니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e datetime \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e datetime\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eDAG\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.\u003cspan class=\"hljs-property\"\u003emodels\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eVariable\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.\u003cspan class=\"hljs-property\"\u003eoperators\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epython\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePythonOperator\u003c/span\u003e\n\ndef \u003cspan class=\"hljs-title function_\"\u003e_print_var\u003c/span\u003e(val1, val2, val3, val4):\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(val1)\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(val2)\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(val3)\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(val4)\n\n\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eDAG\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'my_dag'\u003c/span\u003e, start_date=\u003cspan class=\"hljs-title function_\"\u003edatetime\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003edag\u003c/span\u003e:\n    print_var = \u003cspan class=\"hljs-title class_\"\u003ePythonOperator\u003c/span\u003e(\n        task_id=\u003cspan class=\"hljs-string\"\u003e'print_var'\u003c/span\u003e,\n        python_callable=_print_var,\n        op_args=[\n            \u003cspan class=\"hljs-string\"\u003e'{ var.value.my_var }'\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e'{ var.json.my_vars.key1 }'\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e'{ var.json.my_vars.key2 }'\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e'{ var.json.my_vars.key3 }'\u003c/span\u003e,\n        ],\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e그러나 템플릿 엔진 접근 방식은 템플릿 참조를 제공할 인수에 대해 오퍼레이터가 템플릿화된 필드를 지원하는 경우에만 적용됩니다.\u003c/p\u003e\n\u003cp\u003e템플릿 참조가 작동하지 않는 경우에는 여전히 Variable.get()이 작업 내에서 호출되도록하여 매번 DAG가 구문 분석될 때 메타스토어 데이터베이스로의 연결이 초기화되지 않도록 할 수 있습니다.\u003c/p\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e datetime \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e datetime\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e DAG\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Variable\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.operators.python \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e PythonOperator\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e_print_var\u003c/span\u003e():\n    my_var = Variable.get(\u003cspan class=\"hljs-string\"\u003e'my_var'\u003c/span\u003e)\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(my_var)\n\n\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e DAG(\u003cspan class=\"hljs-string\"\u003e'my_dag'\u003c/span\u003e, start_date=datetime(\u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e dag:\n    print_var = PythonOperator(\n        task_id=\u003cspan class=\"hljs-string\"\u003e'print_var'\u003c/span\u003e,\n        python_callable=_print_var,\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e단일 변수에 여러 값을 저장하기\u003c/h1\u003e\n\u003cp\u003e이제 특정 DAG가 세 가지 다른 값을 검색해야 한다고 가정해 봅시다. 이전 섹션에서 소개된 최선의 방법을 따르더라도 메타스토어 데이터베이스에 대해 세 개의 개별 연결을 시작해야 합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e datetime \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e datetime\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e DAG\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.models \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e Variable\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.operators.python \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e PythonOperator\n\n\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e_print_vars\u003c/span\u003e():\n    my_var = Variable.get(\u003cspan class=\"hljs-string\"\u003e'my_var'\u003c/span\u003e)\n    another_var = Variable.get(\u003cspan class=\"hljs-string\"\u003e'another_var'\u003c/span\u003e)\n    one_more_var = Variable.get(\u003cspan class=\"hljs-string\"\u003e'one_more_var'\u003c/span\u003e)\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(my_var)\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(another_var)\n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(one_more_var)\n\n\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e DAG(\u003cspan class=\"hljs-string\"\u003e'my_dag'\u003c/span\u003e, start_date=datetime(\u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e dag:\n    print_var = PythonOperator(\n        task_id=\u003cspan class=\"hljs-string\"\u003e'print_vars'\u003c/span\u003e,\n        python_callable=_print_vars,\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e대신, 세 개의 키-값 쌍으로 구성된 단일 JSON 변수를 생성할 수 있습니다. 당연히 이 작업은 세 값을 한 변수로 압축하는 데 논리적으로 의미가 있는 한 수행해야 합니다.\u003c/p\u003e\n\u003cp\u003e이제 메타스토어 데이터베이스로의 연결을 한 번만 수행하여 변수에서 지정된 모든 키의 값을 검색할 수 있습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e datetime \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e datetime\n\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eDAG\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.\u003cspan class=\"hljs-property\"\u003emodels\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eVariable\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e airflow.\u003cspan class=\"hljs-property\"\u003eoperators\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epython\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePythonOperator\u003c/span\u003e\n\ndef \u003cspan class=\"hljs-title function_\"\u003e_print_vars\u003c/span\u003e():\n    my_vars = \u003cspan class=\"hljs-title class_\"\u003eVariable\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'my_vars'\u003c/span\u003e, deserialize_json=\u003cspan class=\"hljs-title class_\"\u003eTrue\u003c/span\u003e)\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(my_vars[\u003cspan class=\"hljs-string\"\u003e'key1'\u003c/span\u003e])\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(my_vars[\u003cspan class=\"hljs-string\"\u003e'key2'\u003c/span\u003e])\n    \u003cspan class=\"hljs-title function_\"\u003eprint\u003c/span\u003e(my_vars[\u003cspan class=\"hljs-string\"\u003e'key3'\u003c/span\u003e])\n\n\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eDAG\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'my_dag'\u003c/span\u003e, start_date=\u003cspan class=\"hljs-title function_\"\u003edatetime\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003edag\u003c/span\u003e:\n    print_var = \u003cspan class=\"hljs-title class_\"\u003ePythonOperator\u003c/span\u003e(\n        task_id=\u003cspan class=\"hljs-string\"\u003e'print_vars'\u003c/span\u003e,\n        python_callable=_print_vars,\n    )\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e최종 생각..\u003c/h1\u003e\n\u003c!-- TIL 수평 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e에어플로우 변수 선언은 간단하지만, 가장 좋은 방법을 적용하지 않으면 메타스토어 데이터베이스에서 가져오는 과정이 악몽이 될 수 있습니다.\u003c/p\u003e\n\u003cp\u003e이 튜토리얼에서는 여섯 가지 다른 방법으로 에어플로우 변수를 생성하는 방법을 보여드렸습니다. 각 접근 방식에는 장단점이 있으며, 그에 맞춰 사용해야 합니다. 프로덕션 배포에서의 최상의 관례는 보안과 이식성을 제공하는 백엔드 시크릿을 사용하는 것입니다.\u003c/p\u003e\n\u003cp\u003e더 중요한 건, 에어플로우 데이터베이스를 과부하시키지 않기 위해 피해야 할 기술들과 변수 구조 활용의 최적화 방법에 대해 논의했습니다. 이제 변수는 템플릿 참조를 통해 유추하거나 작업 함수 정의 내에서 정의되어야 한다는 점이 분명해졌기를 바랍니다.\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-07-13-MasteringAirflowVariables"},"buildId":"Suu-uTE6tpVjS7rqQHkw3","assetPrefix":"/TIL","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4877378276818686","strategy":"lazyOnload","crossOrigin":"anonymous"}]}</script></body></html>