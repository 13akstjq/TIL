{"pageProps":{"post":{"title":"Anthropic Claude V3 함수 호출 방법","description":"","date":"2024-07-12 19:56","slug":"2024-07-12-AnthropicClaudeV3FunctionCalling","content":"\n\n이 기사에서는 Anthropics의 새로운 Claude V3 Opus 모델이 제시하는 질문에 대한 응답을 향상시키기 위해 함수 호출을 사용하는 방법을 보여드리겠습니다. 이를 위해서는 API 키를 받아와서 LLM의 API와 함께 사용해야 합니다.\n\nAPI 키를 받는 방법과 API를 사용하는 방법에 대해 이전 기사에서 이야기했었는데, 아래 링크를 통해 확인할 수 있습니다.\n\n이 기사를 더 효과적으로 활용하기 위해 먼저 그 기사를 읽는 것을 권장드립니다. API 키를 받는 세부사항에 대해서는 다시 다루지 않겠습니다. 왜냐하면 이 과정은 이미 상기한 기사에 자세히 안내되어 있기 때문입니다. 단, Claude에 대한 액세스를 업그레이드해야 하므로 해당 프로세스에는 비용이 발생한다는 점을 알아두셔야 합니다. Pay-As-You-Go 모델을 사용하면 상당히 저렴하게 이용할 수 있습니다. 저는 이미 꽤 사용해봤는데, 지금까지 약 $3 정도 비용이 들었습니다.\n\n## 함수 호출 사용 방법\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n최선의 방법으로 코딩 작업을 수행하기 위해 별도의 코딩 환경을 설정해야 합니다. 저는 conda를 사용하지만 여러분에게 적합한 방법을 사용하시면 됩니다.\n\n```bash\n# 테스트 환경 작성\nconda create -n opus_fc python=3.12 -y\n```\n\n환경이 생성되면 activate 명령을 사용하여 해당 환경으로 전환한 후 필요한 모든 라이브러리를 설치할 수 있습니다.\n\n```bash\n# 이제 활성화\nconda activate opus_fc\n```\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n# 필요한 라이브러리 설치\npip install anthropic\n```\n\n```js\n# 주피터 설치\nconda install jupyter -y\n```\n\n이제 명령 프롬프트에 'jupyter notebook'을 입력하세요. 브라우저에서 주피터 노트북이 열리는 것을 확인할 수 있습니다. 만약 자동으로 열리지 않는다면, 주피터 노트북 명령어 입력 후 정보가 화면에 표시될 것인데, 그 중간쯤에 브라우저에 복사하여 붙여넣어야 할 URL이 있을 것입니다. \n\n당신의 URL은 제 것과 다를 수 있지만, 다음과 같이 보일 것입니다:-  \n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\nhttp://127.0.0.1:8888/tree?token=3b9f7bd07b6966b41b68e2350721b2d0b6f388d248cc69da\r\n\n\r\n그럼, 코드 작업을 시작해봅시다. 섹션으로 나눠서 코드를 설명하는 주석을 추가할 거에요. \r\n\r\n우선, 함수 호출이 왜 필요한지 알아볼까요? 주요 이유 중 하나는 클로드가 최신 및/또는 실시간 정보에 액세스할 수 없기 때문이랍니다.\r\n\r\n아래 예시를 봐봅시다. 에든버러(영국)의 현재 온도가 몇 도인지 클로드에게 물어봤을 때요.\r\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n# 필수 라이브러리 가져오기\n#\nimport anthropic\nimport os\n\n# API 키 설정\n#\nos.environ[\"ANTHROPIC_API_KEY\"]=\"YOUR_ANTHROPIC_API_KEY\"\n\nimport anthropic\n\nclient = anthropic.Anthropic(\n    \n    api_key=os.environ.get(\"ANTHROPIC_API_KEY\")\n)\n\n내_질문= {\n    \"role\": \"user\", \n    \"content\": \"에든버러의 현재 온도를 알려주세요\"\n}\n\nmessage = client.messages.create(\n    model=\"claude-3-opus-20240229\",\n    max_tokens=1000,\n    temperature=0.0,\n    messages=[\n        내_질문\n    ]\n)\nprint(message.content[0].text)\n\n>>\n죄송합니다만, 저는 실시간 날씨 데이터에 접근할 수 없습니다. AI 언어 모델로써 \n특정 위치의 현재 날씨 정보를 검색할 수 있는 능력이 없습니다. 그러나 \n실시간 날씨 업데이트를 제공하는 날씨 앱이나 웹사이트를 사용하여 \n에든버러의 현재 온도를 쉽게 확인할 수 있습니다. 인기 있는 옵션으로는 \n메트 오피스, BBC 날씨, AcuWeather 등이 있습니다. 이 플랫폼에서 \n\"에든버러\"를 검색하면 도시의 현재 온도와 관련된 기타 날씨 정보를 \n찾을 수 있을 것입니다.\n```\n\nClaude가 특정 위치의 현재 온도를 모르는 것을 확인하실 수 있습니다. 이것이 함수 호출이 각자의 것으로 들어오는 곳입니다. 어떤 날씨 서버를 조사하고 특정 위치의 현재 온도를 얻을 수 있는 함수를 제공할 수 있다면 Claude가 그 함수를 호출하고 필요한 정보를 반환할 수 있습니다.\n\n어떻게 할 수 있는지 살펴보겠습니다. 다른 LLM들이 하는 방식과 약간 다르며 조금 복잡하지만 프로세스의 각 단계는 꽤 간단합니다.\n\nAnthropic은 용어인 도구(tool)와 함수를 서로 바꿔 사용하므로 먼저 특정 위치의 현재 온도를 가져오는 도구(함수)를 만들어야 합니다.\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n이를 위해, OpenWeatherMap의 API를 사용할 겁니다. 무료로 등록하여 API 키를 받을 수 있어요. 아래 링크를 클릭해주세요.\n\nAPI 키를 사용할 수 있는데는 몇 시간 정도 소요될 수 있습니다. 따라서 처음에 코드를 시도할 때 \"유효하지 않은 API 키\"라는 메시지를 받으면, 1시간에서 2시간 정도 기다린 후 다시 시도해보신 후 지원팀에 문의해보세요.\n\n```python\nimport requests\n\ndef get_temp(location):\n    # 여기에 API 키를 입력해주세요\n    API_KEY = \"YOUR_WEATHERMAP_API_KEY\"\n    \n    # url을 저장할 base_url 변수\n    base_url = \"http://api.openweathermap.org/data/2.5/weather?\"\n    \n    # 여기서 변수를 API_KEY에서 api_key로 수정했습니다\n    complete_url = base_url + \"appid=\" + API_KEY + \"&q=\" + location\n    \n    # requests 모듈의 get 메소드를 사용하여 응답 객체를 리턴합니다\n    response = requests.get(complete_url)\n    x = response.json()\n    \n    # \"cod\" 키의 값이 \"404\"와 같은 경우는 도시가 발견된 경우이며,\n    # 그렇지 않으면 도시가 발견되지 않은 것입니다\n    if x[\"cod\"] != \"404\":\n        y = x[\"main\"]\n        # 온도를 켈빈에서 섭씨로 변환하여 가독성을 높입니다\n        temp_celsius = y[\"temp\"] - 273.15\n        return temp_celsius\n    else:\n        return None\n```\n\n일반적으로 이를 호출하려면,\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\ntemp = get_temp(\"Edinburgh\")\nprint(f\"The current temperature in Edinburgh is {temp} degrees celcius\")\n\n>>\nThe current temperature in Edinburgh is 4.410000000000025 degrees celcius\n```\n\n다음 단계는 이 함수를 Claude에서 사용하는 방법을 설명하는 것입니다. 이를 위해 일반적으로 YAML이나 JSON을 사용하는 대신 XML을 사용합니다.\n\n```js\ntool = \"\"\"\n<tool_description>\n    <tool_name>get_temp</tool_name>\n    <description>\n        특정 위치의 현재 온도를 찾는 함수입니다.\n    </description>\n    <parameters>\n        <parameter>\n            <name>location</name>\n            <type>str</type>\n            <description>온도를 확인할 위치</description>\n        </parameter>\n    </parameters>\n</tool_description>\n\"\"\"\n```\n\n이제 우리의 시스템 프롬프트를 설정해야 합니다. 이 프롬프트는 Claude에게 이 추가 기능(함수 호출을 통해)이 사용 가능하다는 것을 알려줍니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\nsystem_prompt = f\"\"\"\n추가적인 하나 이상의 함수 세트에 액세스할 수 있습니다. 이 함수들을 사용하여 사용자의 질문에 답변할 수 있습니다.\n\n다음과 같이 호출할 수 있습니다:\n<function_calls>\n    <invoke>\n        <tool_name>$TOOL_NAME</tool_name>\n        <parameters>\n            <$PARAMETER_NAME>$PARAMETER_VALUE</$PARAMETER_NAME>\n            ...\n        </parameters>\n    </invoke>\n</function_calls>\n\n다음과 같은 도구들을 사용할 수 있습니다:\n<tools>{tool}</tools>\n최종 답변은 '현재 <location>의 온도는 <temp>도입니다' 형식이어야 합니다.\n\"\"\"\n```\n\n시스템 프롬프트가 정상적으로 작동하는지 Claude에게 전송하여 확인하세요. XML 형식의 함수 호출 세부 정보를 반환해야 합니다.\n\n```js\nclient = anthropic.Anthropic(\n    api_key=os.environ.get(\"ANTHROPIC_API_KEY\")\n)\n\n# 클라이언트 메시지 설정\n# 모델에 물어볼 내용 설정\nmessage = client.messages.create(\n    model=\"claude-3-opus-20240229\"\n    max_tokens=1024,\n    temperature=0.0,\n    system=system_prompt,\n    messages=[\n        {\"role\": \"user\", \"content\": \"에든버러의 현재 온도는 무엇입니까?\"}\n    system=system_prompt\n)\n\nprint(message)\n\n\n>>\n\n<function_calls>\n    <invoke>\n        <tool_name>get_temp</tool_name>\n        <parameters>\n            <location>Edinburgh</location>\n        </parameters>\n    </invoke>\n</function_calls>\n```\n\n잘 보입니다. 이제 우리는 get_temp 도구에 전달해야 하는 매개변수를 얻기 위해 도구 설명의 XML을 구문 분석하는 헬퍼 함수가 필요합니다.\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\r\nimport re\r\ndef extract_between_tags(tag: str, string: str, strip: bool = False) -> list[str]:\r\n    ext_list = re.findall(f\"<{tag}>(.+?)</{tag}>\", string, re.DOTALL)\r\n    if strip:\r\n        ext_list = [e.strip() for e in ext_list]\r\n    return ext_list\r\n\r\nextracted_location = extract_between_tags(\"location\", message, True)\r\nextracted_tool_name = extract_between_tags(\"tool_name\", message, True)\r\n\r\nif extracted_location:\r\n    first_param = extracted_location[0]\r\n    function_to_call = extracted_tool_name[0]\r\n    print(f\"Extracted location: {first_param}\")\r\n    print(f\"Extracted function to call: {function_to_call}\")\r\n    func = locals()[function_to_call]\r\n    result = func(first_param)\r\nelse:\r\n    print(\"No location found in the message.\")\r\n\r\n\r\n>>\r\n\r\n추출된 위치: Edinburgh\r\n호출할 함수: get_temp\r\n```\r\n\r\n다시 한 번, 그건 완벽해 보입니다. 이제 할 일은 최종 값으로 Claude에게 반환하는 것뿐입니다. 먼저, Claude가 예상하는 방식으로 형식을 지정하겠습니다. 즉, XML 형식으로.\r\n\r\n```js\r\ndef construct_successful_function_run_injection_prompt(invoke_results):\r\n    constructed_prompt = (\r\n        \"<function_results>\\n\"\r\n        + '\\n'.join(\r\n            f\"<result>\\n<tool_name>{res['tool_name']}</tool_name>\\n<stdout>\\n{res['tool_result']}\\n</stdout>\\n</result>\" \r\n            for res in invoke_results\r\n        ) + \"\\n</function_results>\"\r\n    )\r\n    \r\n    return constructed_prompt\r\n\r\nformatted_results = [{\r\n    'tool_name': 'get_temp',\r\n    'tool_result': result\r\n}]\r\n\r\nfunction_results = construct_successful_function_run_injection_prompt(formatted_results)\r\nprint(function_results)\r\n\r\n>>\r\n\r\n<function_results>\r\n<result>\r\n<tool_name>get_temp</tool_name>\r\n<stdout>\r\n4.81\r\n</stdout>\r\n</result>\r\n</function_results>\r\n```\r\n\r\n다음으로, 원본 메시지, Claude가 함수를 호출한 부분까지의 부분 반환, 그리고 함수 결과를 결합하여 Claude에게 최종 출력을 생성하기 위한 프롬프트를 얻겠습니다. 이 작업을 용이하게 하기 위해 Assistant 역할에서 미리 작성된 메시지를 사용합니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\npartial_assistant_message = message + \"</function_calls>\" + function_results\n\nfinal_message = client.messages.create(\n    model=\"claude-3-opus-20240229\",\n    max_tokens=1024,\n    messages=[\n        my_message,\n        {\n            \"role\": \"assistant\",\n            \"content\": partial_assistant_message\n        }\n    ],\n    system=system_prompt,\n    stop_sequences=[\"\\n\\nHuman:\", \"\\n\\nAssistant\", \"</function_calls>\"]\n).content[0].text\n\nprint(final_message)\n\n>>\n\n\nThe tool returned that the current temperature in Edinburgh is 4.81 degrees \nCelsius. \n\nTherefore, the final message is:\n\nThe current temperature in Edinburgh is 4.81 degrees Celsius.\n\n\n만약 이 내용이 마음에 드셨다면, 아래 관련 기사들도 흥미로울 수 있습니다.\n","ogImage":{"url":"/TIL/assets/no-image.jpg"},"coverImage":"/TIL/assets/no-image.jpg","tag":["Tech"],"readingTime":11},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p>이 기사에서는 Anthropics의 새로운 Claude V3 Opus 모델이 제시하는 질문에 대한 응답을 향상시키기 위해 함수 호출을 사용하는 방법을 보여드리겠습니다. 이를 위해서는 API 키를 받아와서 LLM의 API와 함께 사용해야 합니다.</p>\n<p>API 키를 받는 방법과 API를 사용하는 방법에 대해 이전 기사에서 이야기했었는데, 아래 링크를 통해 확인할 수 있습니다.</p>\n<p>이 기사를 더 효과적으로 활용하기 위해 먼저 그 기사를 읽는 것을 권장드립니다. API 키를 받는 세부사항에 대해서는 다시 다루지 않겠습니다. 왜냐하면 이 과정은 이미 상기한 기사에 자세히 안내되어 있기 때문입니다. 단, Claude에 대한 액세스를 업그레이드해야 하므로 해당 프로세스에는 비용이 발생한다는 점을 알아두셔야 합니다. Pay-As-You-Go 모델을 사용하면 상당히 저렴하게 이용할 수 있습니다. 저는 이미 꽤 사용해봤는데, 지금까지 약 $3 정도 비용이 들었습니다.</p>\n<h2>함수 호출 사용 방법</h2>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>최선의 방법으로 코딩 작업을 수행하기 위해 별도의 코딩 환경을 설정해야 합니다. 저는 conda를 사용하지만 여러분에게 적합한 방법을 사용하시면 됩니다.</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># 테스트 환경 작성</span>\nconda create -n opus_fc python=3.12 -y\n</code></pre>\n<p>환경이 생성되면 activate 명령을 사용하여 해당 환경으로 전환한 후 필요한 모든 라이브러리를 설치할 수 있습니다.</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># 이제 활성화</span>\nconda activate opus_fc\n</code></pre>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\"># 필요한 라이브러리 설치\npip install anthropic\n</code></pre>\n<pre><code class=\"hljs language-js\"># 주피터 설치\nconda install jupyter -y\n</code></pre>\n<p>이제 명령 프롬프트에 'jupyter notebook'을 입력하세요. 브라우저에서 주피터 노트북이 열리는 것을 확인할 수 있습니다. 만약 자동으로 열리지 않는다면, 주피터 노트북 명령어 입력 후 정보가 화면에 표시될 것인데, 그 중간쯤에 브라우저에 복사하여 붙여넣어야 할 URL이 있을 것입니다.</p>\n<p>당신의 URL은 제 것과 다를 수 있지만, 다음과 같이 보일 것입니다:-</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><a href=\"http://127.0.0.1:8888/tree?token=3b9f7bd07b6966b41b68e2350721b2d0b6f388d248cc69da\" rel=\"nofollow\" target=\"_blank\">http://127.0.0.1:8888/tree?token=3b9f7bd07b6966b41b68e2350721b2d0b6f388d248cc69da</a></p>\n<p>그럼, 코드 작업을 시작해봅시다. 섹션으로 나눠서 코드를 설명하는 주석을 추가할 거에요.</p>\n<p>우선, 함수 호출이 왜 필요한지 알아볼까요? 주요 이유 중 하나는 클로드가 최신 및/또는 실시간 정보에 액세스할 수 없기 때문이랍니다.</p>\n<p>아래 예시를 봐봅시다. 에든버러(영국)의 현재 온도가 몇 도인지 클로드에게 물어봤을 때요.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\"># 필수 라이브러리 가져오기\n#\n<span class=\"hljs-keyword\">import</span> anthropic\n<span class=\"hljs-keyword\">import</span> os\n\n# <span class=\"hljs-variable constant_\">API</span> 키 설정\n#\nos.<span class=\"hljs-property\">environ</span>[<span class=\"hljs-string\">\"ANTHROPIC_API_KEY\"</span>]=<span class=\"hljs-string\">\"YOUR_ANTHROPIC_API_KEY\"</span>\n\n<span class=\"hljs-keyword\">import</span> anthropic\n\nclient = anthropic.<span class=\"hljs-title class_\">Anthropic</span>(\n    \n    api_key=os.<span class=\"hljs-property\">environ</span>.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">\"ANTHROPIC_API_KEY\"</span>)\n)\n\n내_질문= {\n    <span class=\"hljs-string\">\"role\"</span>: <span class=\"hljs-string\">\"user\"</span>, \n    <span class=\"hljs-string\">\"content\"</span>: <span class=\"hljs-string\">\"에든버러의 현재 온도를 알려주세요\"</span>\n}\n\nmessage = client.<span class=\"hljs-property\">messages</span>.<span class=\"hljs-title function_\">create</span>(\n    model=<span class=\"hljs-string\">\"claude-3-opus-20240229\"</span>,\n    max_tokens=<span class=\"hljs-number\">1000</span>,\n    temperature=<span class=\"hljs-number\">0.0</span>,\n    messages=[\n        내_질문\n    ]\n)\n<span class=\"hljs-title function_\">print</span>(message.<span class=\"hljs-property\">content</span>[<span class=\"hljs-number\">0</span>].<span class=\"hljs-property\">text</span>)\n\n>>\n죄송합니다만, 저는 실시간 날씨 데이터에 접근할 수 없습니다. <span class=\"hljs-variable constant_\">AI</span> 언어 모델로써 \n특정 위치의 현재 날씨 정보를 검색할 수 있는 능력이 없습니다. 그러나 \n실시간 날씨 업데이트를 제공하는 날씨 앱이나 웹사이트를 사용하여 \n에든버러의 현재 온도를 쉽게 확인할 수 있습니다. 인기 있는 옵션으로는 \n메트 오피스, <span class=\"hljs-variable constant_\">BBC</span> 날씨, <span class=\"hljs-title class_\">AcuWeather</span> 등이 있습니다. 이 플랫폼에서 \n<span class=\"hljs-string\">\"에든버러\"</span>를 검색하면 도시의 현재 온도와 관련된 기타 날씨 정보를 \n찾을 수 있을 것입니다.\n</code></pre>\n<p>Claude가 특정 위치의 현재 온도를 모르는 것을 확인하실 수 있습니다. 이것이 함수 호출이 각자의 것으로 들어오는 곳입니다. 어떤 날씨 서버를 조사하고 특정 위치의 현재 온도를 얻을 수 있는 함수를 제공할 수 있다면 Claude가 그 함수를 호출하고 필요한 정보를 반환할 수 있습니다.</p>\n<p>어떻게 할 수 있는지 살펴보겠습니다. 다른 LLM들이 하는 방식과 약간 다르며 조금 복잡하지만 프로세스의 각 단계는 꽤 간단합니다.</p>\n<p>Anthropic은 용어인 도구(tool)와 함수를 서로 바꿔 사용하므로 먼저 특정 위치의 현재 온도를 가져오는 도구(함수)를 만들어야 합니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>이를 위해, OpenWeatherMap의 API를 사용할 겁니다. 무료로 등록하여 API 키를 받을 수 있어요. 아래 링크를 클릭해주세요.</p>\n<p>API 키를 사용할 수 있는데는 몇 시간 정도 소요될 수 있습니다. 따라서 처음에 코드를 시도할 때 \"유효하지 않은 API 키\"라는 메시지를 받으면, 1시간에서 2시간 정도 기다린 후 다시 시도해보신 후 지원팀에 문의해보세요.</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-keyword\">import</span> requests\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_temp</span>(<span class=\"hljs-params\">location</span>):\n    <span class=\"hljs-comment\"># 여기에 API 키를 입력해주세요</span>\n    API_KEY = <span class=\"hljs-string\">\"YOUR_WEATHERMAP_API_KEY\"</span>\n    \n    <span class=\"hljs-comment\"># url을 저장할 base_url 변수</span>\n    base_url = <span class=\"hljs-string\">\"http://api.openweathermap.org/data/2.5/weather?\"</span>\n    \n    <span class=\"hljs-comment\"># 여기서 변수를 API_KEY에서 api_key로 수정했습니다</span>\n    complete_url = base_url + <span class=\"hljs-string\">\"appid=\"</span> + API_KEY + <span class=\"hljs-string\">\"&#x26;q=\"</span> + location\n    \n    <span class=\"hljs-comment\"># requests 모듈의 get 메소드를 사용하여 응답 객체를 리턴합니다</span>\n    response = requests.get(complete_url)\n    x = response.json()\n    \n    <span class=\"hljs-comment\"># \"cod\" 키의 값이 \"404\"와 같은 경우는 도시가 발견된 경우이며,</span>\n    <span class=\"hljs-comment\"># 그렇지 않으면 도시가 발견되지 않은 것입니다</span>\n    <span class=\"hljs-keyword\">if</span> x[<span class=\"hljs-string\">\"cod\"</span>] != <span class=\"hljs-string\">\"404\"</span>:\n        y = x[<span class=\"hljs-string\">\"main\"</span>]\n        <span class=\"hljs-comment\"># 온도를 켈빈에서 섭씨로 변환하여 가독성을 높입니다</span>\n        temp_celsius = y[<span class=\"hljs-string\">\"temp\"</span>] - <span class=\"hljs-number\">273.15</span>\n        <span class=\"hljs-keyword\">return</span> temp_celsius\n    <span class=\"hljs-keyword\">else</span>:\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">None</span>\n</code></pre>\n<p>일반적으로 이를 호출하려면,</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">temp = <span class=\"hljs-title function_\">get_temp</span>(<span class=\"hljs-string\">\"Edinburgh\"</span>)\n<span class=\"hljs-title function_\">print</span>(f<span class=\"hljs-string\">\"The current temperature in Edinburgh is {temp} degrees celcius\"</span>)\n\n>>\n<span class=\"hljs-title class_\">The</span> current temperature <span class=\"hljs-keyword\">in</span> <span class=\"hljs-title class_\">Edinburgh</span> is <span class=\"hljs-number\">4.410000000000025</span> degrees celcius\n</code></pre>\n<p>다음 단계는 이 함수를 Claude에서 사용하는 방법을 설명하는 것입니다. 이를 위해 일반적으로 YAML이나 JSON을 사용하는 대신 XML을 사용합니다.</p>\n<pre><code class=\"hljs language-js\">tool = <span class=\"hljs-string\">\"\"</span><span class=\"hljs-string\">\"\n&#x3C;tool_description>\n    &#x3C;tool_name>get_temp&#x3C;/tool_name>\n    &#x3C;description>\n        특정 위치의 현재 온도를 찾는 함수입니다.\n    &#x3C;/description>\n    &#x3C;parameters>\n        &#x3C;parameter>\n            &#x3C;name>location&#x3C;/name>\n            &#x3C;type>str&#x3C;/type>\n            &#x3C;description>온도를 확인할 위치&#x3C;/description>\n        &#x3C;/parameter>\n    &#x3C;/parameters>\n&#x3C;/tool_description>\n\"</span><span class=\"hljs-string\">\"\"</span>\n</code></pre>\n<p>이제 우리의 시스템 프롬프트를 설정해야 합니다. 이 프롬프트는 Claude에게 이 추가 기능(함수 호출을 통해)이 사용 가능하다는 것을 알려줍니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">system_prompt = f<span class=\"hljs-string\">\"\"</span><span class=\"hljs-string\">\"\n추가적인 하나 이상의 함수 세트에 액세스할 수 있습니다. 이 함수들을 사용하여 사용자의 질문에 답변할 수 있습니다.\n\n다음과 같이 호출할 수 있습니다:\n&#x3C;function_calls>\n    &#x3C;invoke>\n        &#x3C;tool_name>$TOOL_NAME&#x3C;/tool_name>\n        &#x3C;parameters>\n            &#x3C;$PARAMETER_NAME>$PARAMETER_VALUE&#x3C;/$PARAMETER_NAME>\n            ...\n        &#x3C;/parameters>\n    &#x3C;/invoke>\n&#x3C;/function_calls>\n\n다음과 같은 도구들을 사용할 수 있습니다:\n&#x3C;tools>{tool}&#x3C;/tools>\n최종 답변은 '현재 &#x3C;location>의 온도는 &#x3C;temp>도입니다' 형식이어야 합니다.\n\"</span><span class=\"hljs-string\">\"\"</span>\n</code></pre>\n<p>시스템 프롬프트가 정상적으로 작동하는지 Claude에게 전송하여 확인하세요. XML 형식의 함수 호출 세부 정보를 반환해야 합니다.</p>\n<pre><code class=\"hljs language-js\">client = anthropic.<span class=\"hljs-title class_\">Anthropic</span>(\n    api_key=os.<span class=\"hljs-property\">environ</span>.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">\"ANTHROPIC_API_KEY\"</span>)\n)\n\n# 클라이언트 메시지 설정\n# 모델에 물어볼 내용 설정\nmessage = client.<span class=\"hljs-property\">messages</span>.<span class=\"hljs-title function_\">create</span>(\n    model=<span class=\"hljs-string\">\"claude-3-opus-20240229\"</span>\n    max_tokens=<span class=\"hljs-number\">1024</span>,\n    temperature=<span class=\"hljs-number\">0.0</span>,\n    system=system_prompt,\n    messages=[\n        {<span class=\"hljs-string\">\"role\"</span>: <span class=\"hljs-string\">\"user\"</span>, <span class=\"hljs-string\">\"content\"</span>: <span class=\"hljs-string\">\"에든버러의 현재 온도는 무엇입니까?\"</span>}\n    system=system_prompt\n)\n\n<span class=\"hljs-title function_\">print</span>(message)\n\n\n>>\n\n<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">function_calls</span>></span>\n    <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">invoke</span>></span>\n        <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">tool_name</span>></span>get_temp<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">tool_name</span>></span>\n        <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">parameters</span>></span>\n            <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">location</span>></span>Edinburgh<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">location</span>></span>\n        <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">parameters</span>></span>\n    <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">invoke</span>></span>\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">function_calls</span>></span></span>\n</code></pre>\n<p>잘 보입니다. 이제 우리는 get_temp 도구에 전달해야 하는 매개변수를 얻기 위해 도구 설명의 XML을 구문 분석하는 헬퍼 함수가 필요합니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">import</span> re\r\ndef <span class=\"hljs-title function_\">extract_between_tags</span>(<span class=\"hljs-attr\">tag</span>: str, <span class=\"hljs-attr\">string</span>: str, <span class=\"hljs-attr\">strip</span>: bool = <span class=\"hljs-title class_\">False</span>) -> list[str]:\r\n    ext_list = re.<span class=\"hljs-title function_\">findall</span>(f<span class=\"hljs-string\">\"&#x3C;{tag}>(.+?)&#x3C;/{tag}>\"</span>, string, re.<span class=\"hljs-property\">DOTALL</span>)\r\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-attr\">strip</span>:\r\n        ext_list = [e.<span class=\"hljs-title function_\">strip</span>() <span class=\"hljs-keyword\">for</span> e <span class=\"hljs-keyword\">in</span> ext_list]\r\n    <span class=\"hljs-keyword\">return</span> ext_list\r\n\r\nextracted_location = <span class=\"hljs-title function_\">extract_between_tags</span>(<span class=\"hljs-string\">\"location\"</span>, message, <span class=\"hljs-title class_\">True</span>)\r\nextracted_tool_name = <span class=\"hljs-title function_\">extract_between_tags</span>(<span class=\"hljs-string\">\"tool_name\"</span>, message, <span class=\"hljs-title class_\">True</span>)\r\n\r\n<span class=\"hljs-keyword\">if</span> <span class=\"hljs-attr\">extracted_location</span>:\r\n    first_param = extracted_location[<span class=\"hljs-number\">0</span>]\r\n    function_to_call = extracted_tool_name[<span class=\"hljs-number\">0</span>]\r\n    <span class=\"hljs-title function_\">print</span>(f<span class=\"hljs-string\">\"Extracted location: {first_param}\"</span>)\r\n    <span class=\"hljs-title function_\">print</span>(f<span class=\"hljs-string\">\"Extracted function to call: {function_to_call}\"</span>)\r\n    func = <span class=\"hljs-title function_\">locals</span>()[function_to_call]\r\n    result = <span class=\"hljs-title function_\">func</span>(first_param)\r\n<span class=\"hljs-attr\">else</span>:\r\n    <span class=\"hljs-title function_\">print</span>(<span class=\"hljs-string\">\"No location found in the message.\"</span>)\r\n\r\n\r\n>>\r\n\r\n추출된 위치: <span class=\"hljs-title class_\">Edinburgh</span>\r\n호출할 함수: get_temp\n</code></pre>\n<p>다시 한 번, 그건 완벽해 보입니다. 이제 할 일은 최종 값으로 Claude에게 반환하는 것뿐입니다. 먼저, Claude가 예상하는 방식으로 형식을 지정하겠습니다. 즉, XML 형식으로.</p>\n<pre><code class=\"hljs language-js\">def <span class=\"hljs-title function_\">construct_successful_function_run_injection_prompt</span>(invoke_results):\r\n    constructed_prompt = (\r\n        <span class=\"hljs-string\">\"&#x3C;function_results>\\n\"</span>\r\n        + <span class=\"hljs-string\">'\\n'</span>.<span class=\"hljs-title function_\">join</span>(\r\n            f<span class=\"hljs-string\">\"&#x3C;result>\\n&#x3C;tool_name>{res['tool_name']}&#x3C;/tool_name>\\n&#x3C;stdout>\\n{res['tool_result']}\\n&#x3C;/stdout>\\n&#x3C;/result>\"</span> \r\n            <span class=\"hljs-keyword\">for</span> res <span class=\"hljs-keyword\">in</span> invoke_results\r\n        ) + <span class=\"hljs-string\">\"\\n&#x3C;/function_results>\"</span>\r\n    )\r\n    \r\n    <span class=\"hljs-keyword\">return</span> constructed_prompt\r\n\r\nformatted_results = [{\r\n    <span class=\"hljs-string\">'tool_name'</span>: <span class=\"hljs-string\">'get_temp'</span>,\r\n    <span class=\"hljs-string\">'tool_result'</span>: result\r\n}]\r\n\r\nfunction_results = <span class=\"hljs-title function_\">construct_successful_function_run_injection_prompt</span>(formatted_results)\r\n<span class=\"hljs-title function_\">print</span>(function_results)\r\n\r\n>>\r\n\r\n<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">function_results</span>></span>\r\n<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">result</span>></span>\r\n<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">tool_name</span>></span>get_temp<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">tool_name</span>></span>\r\n<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">stdout</span>></span>\r\n4.81\r\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">stdout</span>></span>\r\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">result</span>></span>\r\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">function_results</span>></span></span>\n</code></pre>\n<p>다음으로, 원본 메시지, Claude가 함수를 호출한 부분까지의 부분 반환, 그리고 함수 결과를 결합하여 Claude에게 최종 출력을 생성하기 위한 프롬프트를 얻겠습니다. 이 작업을 용이하게 하기 위해 Assistant 역할에서 미리 작성된 메시지를 사용합니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>partial_assistant_message = message + \"&#x3C;/function_calls>\" + function_results</p>\n<p>final_message = client.messages.create(\nmodel=\"claude-3-opus-20240229\",\nmax_tokens=1024,\nmessages=[\nmy_message,\n{\n\"role\": \"assistant\",\n\"content\": partial_assistant_message\n}\n],\nsystem=system_prompt,\nstop_sequences=[\"\\n\\nHuman:\", \"\\n\\nAssistant\", \"&#x3C;/function_calls>\"]\n).content[0].text</p>\n<p>print(final_message)</p>\n<blockquote>\n<blockquote>\n</blockquote>\n</blockquote>\n<p>The tool returned that the current temperature in Edinburgh is 4.81 degrees\nCelsius.</p>\n<p>Therefore, the final message is:</p>\n<p>The current temperature in Edinburgh is 4.81 degrees Celsius.</p>\n<p>만약 이 내용이 마음에 드셨다면, 아래 관련 기사들도 흥미로울 수 있습니다.</p>\n</body>\n</html>\n"},"__N_SSG":true}