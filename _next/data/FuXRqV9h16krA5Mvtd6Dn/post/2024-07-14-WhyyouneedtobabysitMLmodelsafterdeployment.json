{"pageProps":{"post":{"title":"배포 후 머신러닝 모델을 관리해야 하는 이유","description":"","date":"2024-07-14 23:49","slug":"2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment","content":"\n\n![TIL](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_0.png)\n\n머신 러닝 모델을 배포한 후 모니터링을 중요시하는 이유가 궁금했던 적이 있나요? 매주 매출 예측을 통해 소매점에서 포스트-배포 모델 모니터링 개념을 탐구하는 흥미로운 이야기를 살펴보겠습니다.\n\n이 이야기를 따라가면 실제 월마트 매출 데이터 세트를 사용해볼 것입니다. 매출 예측 모델을 구축하고 이 머신 러닝 모델의 성능을 운영 중에 모니터링할 것입니다. Google Colab 노트북 내에서 운영 환경을 직접 모방하여 간단히 따라할 수 있을 것입니다.\n\n우리는 실제 세계의 변화로 인해 시간이 지남에 따라 머신 러닝 모델이 악화되는 방법과 모니터링 부족이 상당한 재정 손실로 이어질 수 있는 이유를 발견할 것입니다. 그리고 ML 모델의 성능 모니터링에 nannyML을 사용하는 방법과 nannyML에 의해 발명된 확률적 모델이 필요한 이유를 알아볼 것입니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# 댄니 씨의 소매점\n\n![댄니 씨의 소매점](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_1.png)\n\n댄니 씨가 대형 소매점을 열면서 월마트와 유사한 상점이 열립니다. 상점이 성장함에 따라 주간 매출을 예측하고자 합니다. 따라서 댄니 씨는 데이터 과학자를 고용하여 주간 매출을 예측할 수 있는 기계 학습 모델을 구현하고자 합니다. 이를 통해 미래의 트렌드와 매출을 예측하여 재고와 수요를 미리 계획할 수 있습니다.\n\n데이터 과학자는 댄니 씨의 주간 매출을 예측하는 인상적인 모델을 개발하여 테스트 데이터에서 97%의 정확도를 달성했습니다. 이 모델을 배포한 후, 데이터 과학자는 작별 인사를 남기고 갔습니다. :*)\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_2.png\" />\n\nMr. Danny initially used the model in production. However, after some time, he noticed the model began to fail and gave incorrect predictions. He incurred a financial loss. Can you guess why the model performance degraded⁉️\n\nMr. Danny, who had limited technical knowledge, hired an ML Engineer. He identified the cause of the previous model failure as data drift. Simply put, data drift happens when real-world data changes in ways the model wasn’t trained for, leading to a decline in model performance.\n\nThe ML Engineer provided two possible reasons for the decline in model performance:\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- 단변량 드리프트: 생산 중에 온도 패턴이 갑자기 변하여 쇼핑 패턴이 변경되었습니다. 예를 들어, 자외선 차단제와 탄산음료의 판매량이 증가했습니다.\n- 다변량 드리프트: 고용률, 경기 침체 및 온도 변화가 모두 판매 패턴과 소비자 행동에 영향을 미쳤습니다. 이러한 요인들 사이의 복잡한 관계가 변화함에 따라 다변량 드리프트가 발생했습니다.\n\n자세히 알아보려면 [Hypothesis Testing를 사용한 데이터 드리프트 감지 방법](https://nannyml.com)을 방문해보세요.\n\nML 엔지니어는 모니터링 솔루션의 중심에 데이터 드리프트를 두는 것을 주장했습니다. Danny씨는 이 아이디어를 수용하고 모델 성능 모니터링을 시작했습니다. 그 결과, 그는 매일 모델로부터 다수의 경고를 받았습니다. 이는 그에게 상당한 정신적 스트레스를 야기했습니다.\n\n그러나 Danny씨가 실제 '주간 매출'값 (해당 주의 실제 매장 판매액)을 받자, 대부분의 경고가 잘못되었음을 알게 되었습니다. 경고 중 90% 이상이 잘못되었고, 모델 성능 하락을 올바르게 표시한 경고는 10% 미만이었습니다. 결과적으로, 중앙 모니터링 전략으로 데이터 드리프트에 집중하는 것은 실패로 끝나게 되었습니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![이미지](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_3.png)\n\n마침내 Mr. Danny는 nannyML이라는 라이브러리를 발견했습니다. 이 도구는 그의 ML 모델을 간병하는 역할을 할 수 있어서 지속적으로 성능을 모니터링하고 거짓 경보를 생성하지 않습니다. 그는 정답 데이터에 액세스하지 않고 ML 모델의 성능을 추정하고 데이터 드리프트를 감지할 수 있도록 했습니다.\n\n![이미지](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_4.png)\n\n![이미지](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_5.png)\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음으로, 우리는 Kaggle에서 사용할 수 있는 인기 있는 Walmart 판매 데이터 세트를 사용할 것입니다. 댄니 씨가 그의 가게를 위한 유사한 데이터를 가지고 있다고 가정해 봅시다. 우리는 NannyML을 사용하여 모델 모니터링 및 모델 성능 평가 방법을 탐색할 것입니다.\n\n![이미지](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_6.png)\n\n이것은 2010년 2월 5일부터 2012년 11월 1일까지의 판매를 다루는 기록 데이터입니다. 미국 전역에 위치한 여러 Walmart 매장에서 얻은 데이터가 포함되어 있습니다.\n\n![이미지](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_7.png)\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## 🤖nannyML의 모델 배포 후 모니터링을 위한 사용\n\n우리가 할 일:\n\n- 이 데이터를 사용하여 매장 수요를 예측하여 주간 매출을 예측합니다.\n- 이 데이터에 nannyML 도구를 적용하여 모델 배포 후 모니터링을 결정합니다.\n- 왜 댄니씨의 경우 대부분의 알람이 잘못 트리거되었는지 조사합니다.\n\n# 주간 매출 데이터 소개\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![Image](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_8.png)\n\n우리는 캐글에서 접근 가능한 널리 사용되는 월마트 판매 데이터셋을 활용할 것입니다. 이 데이터셋은 미국 전역에 위치한 여러 월마트 매장의 과거 판매 데이터를 포함하고 있습니다. 우리의 목표는 소매 수요 예측을 수행하고 주간 판매를 예측하는 것입니다.\n\n![Image](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_9.png)\n\n이 데이터는 2010년 2월 5일부터 2012년 11월 1일까지의 판매를 다루는 과거 데이터입니다:\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## 기능 설명\n\n- Store - 상점 번호\n- Date - 판매 주\n- 주간 판매 - 해당 상점의 매출\n- 휴일 플래그 - 주가 특별한 휴일 주인지 여부 1 - 휴일 주 0 - 비휴일 주\n- 온도 - 판매 일의 온도\n- 연료 가격 - 지역의 연료 비용\n- 소비자 물가 지수 - 현행 소비자 물가 지수\n- 실업률 - 현행 실업률\n- 월, 년, 계절 - 시간 관련 특성\n\n# EDA 및 전처리\n\n일부 기본적인 탐색적 데이터 분석을 수행하고 일부 특성의 분포를 분석해보겠습니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![Image 1](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_10.png)\n\n- CPI와 Fuel_Price는 이중분포를 가지고 있으며, Temperature와 Unemployment는 정규분포를 가지고 있습니다.\n\n![Image 2](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_11.png)\n\n- Weekly_Sales 분포는 우측으로 치우쳐져 있으며, 이상치가 있습니다.\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![image](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_12.png)\n\n- 겨울 및 휴일에는 주간 매출이 특히 11월과 12월에 높음\n\n![image](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_13.png)\n\n- 모든 특성의 상관 관계 히트맵은 각 입력 특성 간의 흥미로운 관계를 보여줍니다.\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# 데이터 전처리 및 이상치 제거\n\n```js\n#이상치 제거\nnum_features = ['Temperature', 'Fuel_Price', 'CPI', 'Unemployment', 'Weekly_Sales']\nfor feature in num_features:\n    q1 = df[feature].quantile(0.25)\n    q3 = df[feature].quantile(0.75)\n    iqr = q3 - q1\n    lower = q1 - 1.5 * iqr\n    upper = q3 + 1.5 * iqr\n    df = df[(df[feature] >= lower) & (df[feature] <= upper)]\n\n# 숫자형 변수 정규화\nsc = StandardScaler()\ndf[num_features] = sc.fit_transform(df[num_features])\ncategoric_columns = ['Store', 'Season']\n# 범주형 특성 인코딩\ndf[categoric_columns] = df[categoric_columns].astype('category')\nencoder = BinaryEncoder(cols=categoric_columns)\ndf = encoder.fit_transform(df)\n```\n\n# 데이터를 nannyML에 맞게 분할 및 처리\n\n일반적으로 데이터는 학습, 검증 및 테스트 세트로 나누지만, nannyML에서는 데이터를 네 부분으로 나눕니다. 모델 모니터링 워크플로우는 제품 데이터를 모방하는 또 다른 세트를 필요로 합니다. 이는 시스템이 성능 하락을 올바르게 감지하고 올바른 알고리즘을 사용하여 어떤 문제가 발생했는지 보고하기 위함입니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![이미지](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_14.png)\n\n이 삽화는 데이터 분할에 관한 모든 것을 설명합니다. 깊이 이해하려면 코드를 읽어보세요.\n\n참조 세트는 모델 모니터링 문맥에서 사용되는 테스트 세트의 다른 이름입니다. NannyML은 테스트 세트에서 모델의 성능을 기준으로 생산 성능을 측정합니다.\n\n분석 세트는 모델에 의해 생성된 예측을 포함하는 생산 데이터이며 여기서는 실제 값(우리의 경우에는 미래 주의 소매점 매출)은 사용할 수 없습니다.\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n# 참고 - 여기서는 유효성 데이터를 생성하지 않습니다.\n# 코드 이해를 돕기 위해 위 이미지를 참고하세요.\n\n# 데이터 파티션 생성\ndf['partition'] = pd.cut(\n    df['Date'],\n    bins=[pd.to_datetime('2010-02-12'),\n          pd.to_datetime('2012-02-12'),\n          pd.to_datetime('2012-06-12'),\n          pd.to_datetime('2012-10-26')],\n    right=False,\n    labels=['train', 'test', 'prod']\n)\n# 타겟과 특성 설정\ntarget = 'Weekly_Sales'\nfeatures = [col for col in df.columns if col not in [target, 'Date', 'partition']]\n# 데이터 분할\nX_train = df.loc[df['partition'] == 'train', features]\ny_train = df.loc[df['partition'] == 'train', target]\nX_test = df.loc[df['partition'] == 'test', features]\ny_test = df.loc[df['partition'] == 'test', target]\nX_prod = df.loc[df['partition'] == 'prod', features]\ny_prod = df.loc[df['partition'] == 'prod', target]\r\n```\n\n따라서 최종 데이터 분포 분할은 다음과 같습니다: \n\n- X_train 및 y_train: 2010-02-12 이후 데이터 (4725개)\n- X_test 및 y_test: 2012-02-12 이후 데이터 (945개)\n- X_prod 및 y_prod: 2012-06-12 이후 데이터 (675개)\n\n# 기계 학습 모델 훈련하기\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n이제 LightGBM 회귀 모델을 훈련 데이터에 맞추어, 모델 예측과 기준 예측의 평균 절대 오차(MAE)를 계산하고 훈련 및 테스트 세트에 대한 예측을 수행할 것입니다.\n\n```js\n#모델 훈련\nmodel = LGBMRegressor(random_state=111)\nmodel.fit(X_train, y_train)\n\n# 예측 수행\ny_pred_train = model.predict(X_train)\ny_pred_test = model.predict(X_test)\n# 기준 예측 수행\ny_pred_train_baseline = np.ones_like(y_train) * y_train.mean()\ny_pred_test_baseline = np.ones_like(y_test) * y_train.mean()\n# 훈련, 테스트 및 기준 성능 측정\nmae_train = mean_absolute_error(y_train, y_pred_train).round(4)\nmae_test = mean_absolute_error(y_test, y_pred_test).round(4)\nmae_train_baseline = mean_absolute_error(y_train, y_pred_train_baseline).round(4)\nmae_test_baseline = mean_absolute_error(y_test, y_pred_test_baseline).round(4)\n```\n\n모델을 평가하기 위해, 모델의 훈련 및 테스트 MAE(Mean Absolute Error)를 주간_매출 열의 평균으로 지속적으로 예측하는 기준 모델과 비교할 것입니다.\n\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_15.png\" />\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![Training and Testing Data Scatter Plots](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_16.png)\n\n우리는 두 개의 산점도를 그렸습니다. 하나는 훈련용으로 실제와 예측값을, 또 다른 하나는 테스트 데이터에 대한 예측값을 표현한 것입니다. 두 경우 모두 평균 절대 오차가 비교적 낮은 수준으로 나타났습니다. 이는 모델이 이용 사례에 대해 충분히 잘 작동함을 의미합니다.\n\n![Feature Importance](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_17.png)\n\n또한 우리는 특성 중요도를 계산했는데, 그 결과로 위 세 가지 중요한 특성은 소비자 물가 지수 (CPI), 실업률, 그리고 연료 가격임을 알게 되었습니다.\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# nannyML에서 성능 측정 예측\n\nnannyML은 회귀 및 분류 모델의 성능을 추정하는 데 두 가지 주요 알고리즘을 제공합니다:\n\n우리는 회귀 작업에 대한 직접 손실 추정 알고리즘(DLE)을 사용할 것입니다. DLE는 생성 모델의 성능을 그라운드 트루스 없이 측정하고 RMSE, RMSLE, MAE 등과 같은 다양한 회귀 유사 메트릭을 보고할 수 있습니다.\n\n```js\ny_pred_prod = model.predict(X_prod) #생산 데이터에 대한 주간 매출 예측\n\nreference_df = X_test.copy() # 참조용 테스트 세트\nreference_df['y_pred'] = y_pred_test # 참조 예측\nreference_df['Weekly_Sales'] = y_test # 그라운드 트루스(올바른 타겟)\nreference_df = reference_df.join(df['Date']) # 날짜\nanalysis_df = X_prod.copy() # 특성\nanalysis_df['y_pred'] = y_pred_prod #생산 예측\nanalysis_df = analysis_df.join(df['Date']) # 날짜\n```\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nDLE를 사용하기 위해서는 먼저 기준 성능을 설정하기 위한 참조값을 맞춰야 합니다.\n\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_18.png\" />\n\n```js\ndle = nml.DLE(\n    metrics=['mae'],\n    y_true='Weekly_Sales',\n    y_pred='y_pred',\n    feature_column_names=features,\n    timestamp_column_name='Date',\n    chunk_period='w'\n)\n\ndle.fit(reference_df) # 참조(테스트) 데이터에 fit\nestimated_performance = dle.estimate(analysis_df) # 제품 데이터에 대한 추정값\n```\n\n성능 문제가 감지되지 않았으며, 추정된 성능이 임계값 내에 있음을 관찰했습니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n미스터 댄니는 미래 주간 판매액에 대한 실제 데이터를 가지고 있지 않지만, 거짓 경고 없이 철저한 모델 성능 보고서를 받고 있습니다.\n\n몇 일 후에 댄니씨가 Weekly_Sales(목표값이 사용 가능해지면) 실제 모델 성능을 계산할 수 있습니다. 이것을 제작 데이터의 실제 성능이라고도 합니다. 아래 셀에서는 실제 성능을 계산하고 이를 nannyML의 추정치와 비교합니다.\n\n```js\ncalculator = nml.PerformanceCalculator(\nproblem_type=\"regression\",\ny_true='Weekly_Sales',\ny_pred=\"y_pred\",\nmetrics=[\"mae\"],\ntimestamp_column_name='Date',\nchunk_period='w'\n)\ncalculator.fit(reference_df)\nrealized_performance = calculator.calculate(analysis_df.assign(Weekly_Sales = y_prod)\n```\n\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_19.png\" />\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- 위 그림에서 추정 성능이 실제 성능과 밀접하게 일치하여, DLE의 추정이 정확했음을 나타냅니다.\n\n# 왜 잘못된 경보가 발생하는 것일까요?\n\n이제 이 데이터에 대한 단변량 및 다변량 drift를 검토하고, 이것이 Danny씨의 경우에 실패한 이유를 설명하겠습니다.\n\n```js\ndrdc = nml.DataReconstructionDriftCalculator(\ncolumn_names=features,\ntimestamp_column_name='Date',\nchunk_period='d',\n)\n\ndrdc.fit(reference_df)\nmultivariate_data_drift = drdc.calculate(analysis_df)\nmultivariate_data_drift.plot()\n```  \n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n![Image](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_20.png)\n\n다변량 이동 방법을 통해 분석 데이터에 대한 경고를 받았습니다. 이는 모델 성능에 영향을 미치지 않았기 때문에 잘못된 경고입니다.\n\n```js\nudc = nml.UnivariateDriftCalculator(\ncolumn_names=features,\ntimestamp_column_name='Date',\nchunk_period='w',\n)\n\nudc.fit(reference_df)\nunivariate_data_drift = udc.calculate(analysis_df)\nunivariate_data_drift.filter(period='all', metrics='jensen_shannon', column_names=['Unemployment']).plot(kind='distribution')\n```\n\n![Image](/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_21.png)\n\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n비슷하게, 일변량 드리프트 방법은 우리에게 분석 데이터에 대한 경고를 주었습니다. 그것은 잘못된 경고였습니다. 왜냐하면 모델 성능에 영향을 미치지 않았기 때문입니다. 따라서 잘못된 경보가 발생했음을 보았습니다. 데이터 드리프트 방법이 모니터링 솔루션의 중심에 놓여 있었기 때문입니다.\n\n# 요약\n\n우리는 nannyML이 소매 판매 예측을 위해 실제 월마트 데이터에 적용되는 방법을 탐색했습니다. 소비자 행동과 시장 트렌드의 변화에 대한 도전을 극복했습니다.\n\n모델 모니터링의 중요성을 배웠지만, 효과적인 모니터링을 방해할 수있는 잘못된 경고 문제도 배웠습니다.\n\n<!-- TIL 수평 -->\n<ins class=\"adsbygoogle\"\n     style=\"display:block\"\n     data-ad-client=\"ca-pub-4877378276818686\"\n     data-ad-slot=\"1549334788\"\n     data-ad-format=\"auto\"\n     data-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n여기까지 오셨다면, NannyML의 문서를 살펴보시고 여러 사용 사례에서 어떻게 혜택을 받을 수 있는지 확인하는 것을 강력히 추천합니다. 더 많은 정보를 원하신다면 그들의 웹사이트도 방문해보세요.","ogImage":{"url":"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_0.png"},"coverImage":"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_0.png","tag":["Tech"],"readingTime":18},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_0.png\" alt=\"TIL\"></p>\n<p>머신 러닝 모델을 배포한 후 모니터링을 중요시하는 이유가 궁금했던 적이 있나요? 매주 매출 예측을 통해 소매점에서 포스트-배포 모델 모니터링 개념을 탐구하는 흥미로운 이야기를 살펴보겠습니다.</p>\n<p>이 이야기를 따라가면 실제 월마트 매출 데이터 세트를 사용해볼 것입니다. 매출 예측 모델을 구축하고 이 머신 러닝 모델의 성능을 운영 중에 모니터링할 것입니다. Google Colab 노트북 내에서 운영 환경을 직접 모방하여 간단히 따라할 수 있을 것입니다.</p>\n<p>우리는 실제 세계의 변화로 인해 시간이 지남에 따라 머신 러닝 모델이 악화되는 방법과 모니터링 부족이 상당한 재정 손실로 이어질 수 있는 이유를 발견할 것입니다. 그리고 ML 모델의 성능 모니터링에 nannyML을 사용하는 방법과 nannyML에 의해 발명된 확률적 모델이 필요한 이유를 알아볼 것입니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>댄니 씨의 소매점</h1>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_1.png\" alt=\"댄니 씨의 소매점\"></p>\n<p>댄니 씨가 대형 소매점을 열면서 월마트와 유사한 상점이 열립니다. 상점이 성장함에 따라 주간 매출을 예측하고자 합니다. 따라서 댄니 씨는 데이터 과학자를 고용하여 주간 매출을 예측할 수 있는 기계 학습 모델을 구현하고자 합니다. 이를 통해 미래의 트렌드와 매출을 예측하여 재고와 수요를 미리 계획할 수 있습니다.</p>\n<p>데이터 과학자는 댄니 씨의 주간 매출을 예측하는 인상적인 모델을 개발하여 테스트 데이터에서 97%의 정확도를 달성했습니다. 이 모델을 배포한 후, 데이터 과학자는 작별 인사를 남기고 갔습니다. :*)</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_2.png\">\n<p>Mr. Danny initially used the model in production. However, after some time, he noticed the model began to fail and gave incorrect predictions. He incurred a financial loss. Can you guess why the model performance degraded⁉️</p>\n<p>Mr. Danny, who had limited technical knowledge, hired an ML Engineer. He identified the cause of the previous model failure as data drift. Simply put, data drift happens when real-world data changes in ways the model wasn’t trained for, leading to a decline in model performance.</p>\n<p>The ML Engineer provided two possible reasons for the decline in model performance:</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>단변량 드리프트: 생산 중에 온도 패턴이 갑자기 변하여 쇼핑 패턴이 변경되었습니다. 예를 들어, 자외선 차단제와 탄산음료의 판매량이 증가했습니다.</li>\n<li>다변량 드리프트: 고용률, 경기 침체 및 온도 변화가 모두 판매 패턴과 소비자 행동에 영향을 미쳤습니다. 이러한 요인들 사이의 복잡한 관계가 변화함에 따라 다변량 드리프트가 발생했습니다.</li>\n</ul>\n<p>자세히 알아보려면 <a href=\"https://nannyml.com\" rel=\"nofollow\" target=\"_blank\">Hypothesis Testing를 사용한 데이터 드리프트 감지 방법</a>을 방문해보세요.</p>\n<p>ML 엔지니어는 모니터링 솔루션의 중심에 데이터 드리프트를 두는 것을 주장했습니다. Danny씨는 이 아이디어를 수용하고 모델 성능 모니터링을 시작했습니다. 그 결과, 그는 매일 모델로부터 다수의 경고를 받았습니다. 이는 그에게 상당한 정신적 스트레스를 야기했습니다.</p>\n<p>그러나 Danny씨가 실제 '주간 매출'값 (해당 주의 실제 매장 판매액)을 받자, 대부분의 경고가 잘못되었음을 알게 되었습니다. 경고 중 90% 이상이 잘못되었고, 모델 성능 하락을 올바르게 표시한 경고는 10% 미만이었습니다. 결과적으로, 중앙 모니터링 전략으로 데이터 드리프트에 집중하는 것은 실패로 끝나게 되었습니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_3.png\" alt=\"이미지\"></p>\n<p>마침내 Mr. Danny는 nannyML이라는 라이브러리를 발견했습니다. 이 도구는 그의 ML 모델을 간병하는 역할을 할 수 있어서 지속적으로 성능을 모니터링하고 거짓 경보를 생성하지 않습니다. 그는 정답 데이터에 액세스하지 않고 ML 모델의 성능을 추정하고 데이터 드리프트를 감지할 수 있도록 했습니다.</p>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_4.png\" alt=\"이미지\"></p>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_5.png\" alt=\"이미지\"></p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음으로, 우리는 Kaggle에서 사용할 수 있는 인기 있는 Walmart 판매 데이터 세트를 사용할 것입니다. 댄니 씨가 그의 가게를 위한 유사한 데이터를 가지고 있다고 가정해 봅시다. 우리는 NannyML을 사용하여 모델 모니터링 및 모델 성능 평가 방법을 탐색할 것입니다.</p>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_6.png\" alt=\"이미지\"></p>\n<p>이것은 2010년 2월 5일부터 2012년 11월 1일까지의 판매를 다루는 기록 데이터입니다. 미국 전역에 위치한 여러 Walmart 매장에서 얻은 데이터가 포함되어 있습니다.</p>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_7.png\" alt=\"이미지\"></p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h2>🤖nannyML의 모델 배포 후 모니터링을 위한 사용</h2>\n<p>우리가 할 일:</p>\n<ul>\n<li>이 데이터를 사용하여 매장 수요를 예측하여 주간 매출을 예측합니다.</li>\n<li>이 데이터에 nannyML 도구를 적용하여 모델 배포 후 모니터링을 결정합니다.</li>\n<li>왜 댄니씨의 경우 대부분의 알람이 잘못 트리거되었는지 조사합니다.</li>\n</ul>\n<h1>주간 매출 데이터 소개</h1>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_8.png\" alt=\"Image\"></p>\n<p>우리는 캐글에서 접근 가능한 널리 사용되는 월마트 판매 데이터셋을 활용할 것입니다. 이 데이터셋은 미국 전역에 위치한 여러 월마트 매장의 과거 판매 데이터를 포함하고 있습니다. 우리의 목표는 소매 수요 예측을 수행하고 주간 판매를 예측하는 것입니다.</p>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_9.png\" alt=\"Image\"></p>\n<p>이 데이터는 2010년 2월 5일부터 2012년 11월 1일까지의 판매를 다루는 과거 데이터입니다:</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h2>기능 설명</h2>\n<ul>\n<li>Store - 상점 번호</li>\n<li>Date - 판매 주</li>\n<li>주간 판매 - 해당 상점의 매출</li>\n<li>휴일 플래그 - 주가 특별한 휴일 주인지 여부 1 - 휴일 주 0 - 비휴일 주</li>\n<li>온도 - 판매 일의 온도</li>\n<li>연료 가격 - 지역의 연료 비용</li>\n<li>소비자 물가 지수 - 현행 소비자 물가 지수</li>\n<li>실업률 - 현행 실업률</li>\n<li>월, 년, 계절 - 시간 관련 특성</li>\n</ul>\n<h1>EDA 및 전처리</h1>\n<p>일부 기본적인 탐색적 데이터 분석을 수행하고 일부 특성의 분포를 분석해보겠습니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_10.png\" alt=\"Image 1\"></p>\n<ul>\n<li>CPI와 Fuel_Price는 이중분포를 가지고 있으며, Temperature와 Unemployment는 정규분포를 가지고 있습니다.</li>\n</ul>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_11.png\" alt=\"Image 2\"></p>\n<ul>\n<li>Weekly_Sales 분포는 우측으로 치우쳐져 있으며, 이상치가 있습니다.</li>\n</ul>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_12.png\" alt=\"image\"></p>\n<ul>\n<li>겨울 및 휴일에는 주간 매출이 특히 11월과 12월에 높음</li>\n</ul>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_13.png\" alt=\"image\"></p>\n<ul>\n<li>모든 특성의 상관 관계 히트맵은 각 입력 특성 간의 흥미로운 관계를 보여줍니다.</li>\n</ul>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>데이터 전처리 및 이상치 제거</h1>\n<pre><code class=\"hljs language-js\">#이상치 제거\nnum_features = [<span class=\"hljs-string\">'Temperature'</span>, <span class=\"hljs-string\">'Fuel_Price'</span>, <span class=\"hljs-string\">'CPI'</span>, <span class=\"hljs-string\">'Unemployment'</span>, <span class=\"hljs-string\">'Weekly_Sales'</span>]\n<span class=\"hljs-keyword\">for</span> feature <span class=\"hljs-keyword\">in</span> <span class=\"hljs-attr\">num_features</span>:\n    q1 = df[feature].<span class=\"hljs-title function_\">quantile</span>(<span class=\"hljs-number\">0.25</span>)\n    q3 = df[feature].<span class=\"hljs-title function_\">quantile</span>(<span class=\"hljs-number\">0.75</span>)\n    iqr = q3 - q1\n    lower = q1 - <span class=\"hljs-number\">1.5</span> * iqr\n    upper = q3 + <span class=\"hljs-number\">1.5</span> * iqr\n    df = df[(df[feature] >= lower) &#x26; (df[feature] &#x3C;= upper)]\n\n# 숫자형 변수 정규화\nsc = <span class=\"hljs-title class_\">StandardScaler</span>()\ndf[num_features] = sc.<span class=\"hljs-title function_\">fit_transform</span>(df[num_features])\ncategoric_columns = [<span class=\"hljs-string\">'Store'</span>, <span class=\"hljs-string\">'Season'</span>]\n# 범주형 특성 인코딩\ndf[categoric_columns] = df[categoric_columns].<span class=\"hljs-title function_\">astype</span>(<span class=\"hljs-string\">'category'</span>)\nencoder = <span class=\"hljs-title class_\">BinaryEncoder</span>(cols=categoric_columns)\ndf = encoder.<span class=\"hljs-title function_\">fit_transform</span>(df)\n</code></pre>\n<h1>데이터를 nannyML에 맞게 분할 및 처리</h1>\n<p>일반적으로 데이터는 학습, 검증 및 테스트 세트로 나누지만, nannyML에서는 데이터를 네 부분으로 나눕니다. 모델 모니터링 워크플로우는 제품 데이터를 모방하는 또 다른 세트를 필요로 합니다. 이는 시스템이 성능 하락을 올바르게 감지하고 올바른 알고리즘을 사용하여 어떤 문제가 발생했는지 보고하기 위함입니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_14.png\" alt=\"이미지\"></p>\n<p>이 삽화는 데이터 분할에 관한 모든 것을 설명합니다. 깊이 이해하려면 코드를 읽어보세요.</p>\n<p>참조 세트는 모델 모니터링 문맥에서 사용되는 테스트 세트의 다른 이름입니다. NannyML은 테스트 세트에서 모델의 성능을 기준으로 생산 성능을 측정합니다.</p>\n<p>분석 세트는 모델에 의해 생성된 예측을 포함하는 생산 데이터이며 여기서는 실제 값(우리의 경우에는 미래 주의 소매점 매출)은 사용할 수 없습니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\"># 참고 - 여기서는 유효성 데이터를 생성하지 않습니다.\n# 코드 이해를 돕기 위해 위 이미지를 참고하세요.\n\n# 데이터 파티션 생성\ndf[<span class=\"hljs-string\">'partition'</span>] = pd.<span class=\"hljs-title function_\">cut</span>(\n    df[<span class=\"hljs-string\">'Date'</span>],\n    bins=[pd.<span class=\"hljs-title function_\">to_datetime</span>(<span class=\"hljs-string\">'2010-02-12'</span>),\n          pd.<span class=\"hljs-title function_\">to_datetime</span>(<span class=\"hljs-string\">'2012-02-12'</span>),\n          pd.<span class=\"hljs-title function_\">to_datetime</span>(<span class=\"hljs-string\">'2012-06-12'</span>),\n          pd.<span class=\"hljs-title function_\">to_datetime</span>(<span class=\"hljs-string\">'2012-10-26'</span>)],\n    right=<span class=\"hljs-title class_\">False</span>,\n    labels=[<span class=\"hljs-string\">'train'</span>, <span class=\"hljs-string\">'test'</span>, <span class=\"hljs-string\">'prod'</span>]\n)\n# 타겟과 특성 설정\ntarget = <span class=\"hljs-string\">'Weekly_Sales'</span>\nfeatures = [col <span class=\"hljs-keyword\">for</span> col <span class=\"hljs-keyword\">in</span> df.<span class=\"hljs-property\">columns</span> <span class=\"hljs-keyword\">if</span> col not <span class=\"hljs-keyword\">in</span> [target, <span class=\"hljs-string\">'Date'</span>, <span class=\"hljs-string\">'partition'</span>]]\n# 데이터 분할\nX_train = df.<span class=\"hljs-property\">loc</span>[df[<span class=\"hljs-string\">'partition'</span>] == <span class=\"hljs-string\">'train'</span>, features]\ny_train = df.<span class=\"hljs-property\">loc</span>[df[<span class=\"hljs-string\">'partition'</span>] == <span class=\"hljs-string\">'train'</span>, target]\nX_test = df.<span class=\"hljs-property\">loc</span>[df[<span class=\"hljs-string\">'partition'</span>] == <span class=\"hljs-string\">'test'</span>, features]\ny_test = df.<span class=\"hljs-property\">loc</span>[df[<span class=\"hljs-string\">'partition'</span>] == <span class=\"hljs-string\">'test'</span>, target]\nX_prod = df.<span class=\"hljs-property\">loc</span>[df[<span class=\"hljs-string\">'partition'</span>] == <span class=\"hljs-string\">'prod'</span>, features]\ny_prod = df.<span class=\"hljs-property\">loc</span>[df[<span class=\"hljs-string\">'partition'</span>] == <span class=\"hljs-string\">'prod'</span>, target]\n</code></pre>\n<p>따라서 최종 데이터 분포 분할은 다음과 같습니다:</p>\n<ul>\n<li>X_train 및 y_train: 2010-02-12 이후 데이터 (4725개)</li>\n<li>X_test 및 y_test: 2012-02-12 이후 데이터 (945개)</li>\n<li>X_prod 및 y_prod: 2012-06-12 이후 데이터 (675개)</li>\n</ul>\n<h1>기계 학습 모델 훈련하기</h1>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>이제 LightGBM 회귀 모델을 훈련 데이터에 맞추어, 모델 예측과 기준 예측의 평균 절대 오차(MAE)를 계산하고 훈련 및 테스트 세트에 대한 예측을 수행할 것입니다.</p>\n<pre><code class=\"hljs language-js\">#모델 훈련\nmodel = <span class=\"hljs-title class_\">LGBMRegressor</span>(random_state=<span class=\"hljs-number\">111</span>)\nmodel.<span class=\"hljs-title function_\">fit</span>(X_train, y_train)\n\n# 예측 수행\ny_pred_train = model.<span class=\"hljs-title function_\">predict</span>(X_train)\ny_pred_test = model.<span class=\"hljs-title function_\">predict</span>(X_test)\n# 기준 예측 수행\ny_pred_train_baseline = np.<span class=\"hljs-title function_\">ones_like</span>(y_train) * y_train.<span class=\"hljs-title function_\">mean</span>()\ny_pred_test_baseline = np.<span class=\"hljs-title function_\">ones_like</span>(y_test) * y_train.<span class=\"hljs-title function_\">mean</span>()\n# 훈련, 테스트 및 기준 성능 측정\nmae_train = <span class=\"hljs-title function_\">mean_absolute_error</span>(y_train, y_pred_train).<span class=\"hljs-title function_\">round</span>(<span class=\"hljs-number\">4</span>)\nmae_test = <span class=\"hljs-title function_\">mean_absolute_error</span>(y_test, y_pred_test).<span class=\"hljs-title function_\">round</span>(<span class=\"hljs-number\">4</span>)\nmae_train_baseline = <span class=\"hljs-title function_\">mean_absolute_error</span>(y_train, y_pred_train_baseline).<span class=\"hljs-title function_\">round</span>(<span class=\"hljs-number\">4</span>)\nmae_test_baseline = <span class=\"hljs-title function_\">mean_absolute_error</span>(y_test, y_pred_test_baseline).<span class=\"hljs-title function_\">round</span>(<span class=\"hljs-number\">4</span>)\n</code></pre>\n<p>모델을 평가하기 위해, 모델의 훈련 및 테스트 MAE(Mean Absolute Error)를 주간_매출 열의 평균으로 지속적으로 예측하는 기준 모델과 비교할 것입니다.</p>\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_15.png\">\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_16.png\" alt=\"Training and Testing Data Scatter Plots\"></p>\n<p>우리는 두 개의 산점도를 그렸습니다. 하나는 훈련용으로 실제와 예측값을, 또 다른 하나는 테스트 데이터에 대한 예측값을 표현한 것입니다. 두 경우 모두 평균 절대 오차가 비교적 낮은 수준으로 나타났습니다. 이는 모델이 이용 사례에 대해 충분히 잘 작동함을 의미합니다.</p>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_17.png\" alt=\"Feature Importance\"></p>\n<p>또한 우리는 특성 중요도를 계산했는데, 그 결과로 위 세 가지 중요한 특성은 소비자 물가 지수 (CPI), 실업률, 그리고 연료 가격임을 알게 되었습니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>nannyML에서 성능 측정 예측</h1>\n<p>nannyML은 회귀 및 분류 모델의 성능을 추정하는 데 두 가지 주요 알고리즘을 제공합니다:</p>\n<p>우리는 회귀 작업에 대한 직접 손실 추정 알고리즘(DLE)을 사용할 것입니다. DLE는 생성 모델의 성능을 그라운드 트루스 없이 측정하고 RMSE, RMSLE, MAE 등과 같은 다양한 회귀 유사 메트릭을 보고할 수 있습니다.</p>\n<pre><code class=\"hljs language-js\">y_pred_prod = model.<span class=\"hljs-title function_\">predict</span>(X_prod) #생산 데이터에 대한 주간 매출 예측\n\nreference_df = X_test.<span class=\"hljs-title function_\">copy</span>() # 참조용 테스트 세트\nreference_df[<span class=\"hljs-string\">'y_pred'</span>] = y_pred_test # 참조 예측\nreference_df[<span class=\"hljs-string\">'Weekly_Sales'</span>] = y_test # 그라운드 트루스(올바른 타겟)\nreference_df = reference_df.<span class=\"hljs-title function_\">join</span>(df[<span class=\"hljs-string\">'Date'</span>]) # 날짜\nanalysis_df = X_prod.<span class=\"hljs-title function_\">copy</span>() # 특성\nanalysis_df[<span class=\"hljs-string\">'y_pred'</span>] = y_pred_prod #생산 예측\nanalysis_df = analysis_df.<span class=\"hljs-title function_\">join</span>(df[<span class=\"hljs-string\">'Date'</span>]) # 날짜\n</code></pre>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>DLE를 사용하기 위해서는 먼저 기준 성능을 설정하기 위한 참조값을 맞춰야 합니다.</p>\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_18.png\">\n<pre><code class=\"hljs language-js\">dle = nml.<span class=\"hljs-title function_\">DLE</span>(\n    metrics=[<span class=\"hljs-string\">'mae'</span>],\n    y_true=<span class=\"hljs-string\">'Weekly_Sales'</span>,\n    y_pred=<span class=\"hljs-string\">'y_pred'</span>,\n    feature_column_names=features,\n    timestamp_column_name=<span class=\"hljs-string\">'Date'</span>,\n    chunk_period=<span class=\"hljs-string\">'w'</span>\n)\n\ndle.<span class=\"hljs-title function_\">fit</span>(reference_df) # 참조(테스트) 데이터에 fit\nestimated_performance = dle.<span class=\"hljs-title function_\">estimate</span>(analysis_df) # 제품 데이터에 대한 추정값\n</code></pre>\n<p>성능 문제가 감지되지 않았으며, 추정된 성능이 임계값 내에 있음을 관찰했습니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>미스터 댄니는 미래 주간 판매액에 대한 실제 데이터를 가지고 있지 않지만, 거짓 경고 없이 철저한 모델 성능 보고서를 받고 있습니다.</p>\n<p>몇 일 후에 댄니씨가 Weekly_Sales(목표값이 사용 가능해지면) 실제 모델 성능을 계산할 수 있습니다. 이것을 제작 데이터의 실제 성능이라고도 합니다. 아래 셀에서는 실제 성능을 계산하고 이를 nannyML의 추정치와 비교합니다.</p>\n<pre><code class=\"hljs language-js\">calculator = nml.<span class=\"hljs-title class_\">PerformanceCalculator</span>(\nproblem_type=<span class=\"hljs-string\">\"regression\"</span>,\ny_true=<span class=\"hljs-string\">'Weekly_Sales'</span>,\ny_pred=<span class=\"hljs-string\">\"y_pred\"</span>,\nmetrics=[<span class=\"hljs-string\">\"mae\"</span>],\ntimestamp_column_name=<span class=\"hljs-string\">'Date'</span>,\nchunk_period=<span class=\"hljs-string\">'w'</span>\n)\ncalculator.<span class=\"hljs-title function_\">fit</span>(reference_df)\nrealized_performance = calculator.<span class=\"hljs-title function_\">calculate</span>(analysis_df.<span class=\"hljs-title function_\">assign</span>(<span class=\"hljs-title class_\">Weekly</span>_Sales = y_prod)\n</code></pre>\n<img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_19.png\">\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>위 그림에서 추정 성능이 실제 성능과 밀접하게 일치하여, DLE의 추정이 정확했음을 나타냅니다.</li>\n</ul>\n<h1>왜 잘못된 경보가 발생하는 것일까요?</h1>\n<p>이제 이 데이터에 대한 단변량 및 다변량 drift를 검토하고, 이것이 Danny씨의 경우에 실패한 이유를 설명하겠습니다.</p>\n<pre><code class=\"hljs language-js\">drdc = nml.<span class=\"hljs-title class_\">DataReconstructionDriftCalculator</span>(\ncolumn_names=features,\ntimestamp_column_name=<span class=\"hljs-string\">'Date'</span>,\nchunk_period=<span class=\"hljs-string\">'d'</span>,\n)\n\ndrdc.<span class=\"hljs-title function_\">fit</span>(reference_df)\nmultivariate_data_drift = drdc.<span class=\"hljs-title function_\">calculate</span>(analysis_df)\nmultivariate_data_drift.<span class=\"hljs-title function_\">plot</span>()\n</code></pre>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_20.png\" alt=\"Image\"></p>\n<p>다변량 이동 방법을 통해 분석 데이터에 대한 경고를 받았습니다. 이는 모델 성능에 영향을 미치지 않았기 때문에 잘못된 경고입니다.</p>\n<pre><code class=\"hljs language-js\">udc = nml.<span class=\"hljs-title class_\">UnivariateDriftCalculator</span>(\ncolumn_names=features,\ntimestamp_column_name=<span class=\"hljs-string\">'Date'</span>,\nchunk_period=<span class=\"hljs-string\">'w'</span>,\n)\n\nudc.<span class=\"hljs-title function_\">fit</span>(reference_df)\nunivariate_data_drift = udc.<span class=\"hljs-title function_\">calculate</span>(analysis_df)\nunivariate_data_drift.<span class=\"hljs-title function_\">filter</span>(period=<span class=\"hljs-string\">'all'</span>, metrics=<span class=\"hljs-string\">'jensen_shannon'</span>, column_names=[<span class=\"hljs-string\">'Unemployment'</span>]).<span class=\"hljs-title function_\">plot</span>(kind=<span class=\"hljs-string\">'distribution'</span>)\n</code></pre>\n<p><img src=\"/TIL/assets/img/2024-07-14-WhyyouneedtobabysitMLmodelsafterdeployment_21.png\" alt=\"Image\"></p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>비슷하게, 일변량 드리프트 방법은 우리에게 분석 데이터에 대한 경고를 주었습니다. 그것은 잘못된 경고였습니다. 왜냐하면 모델 성능에 영향을 미치지 않았기 때문입니다. 따라서 잘못된 경보가 발생했음을 보았습니다. 데이터 드리프트 방법이 모니터링 솔루션의 중심에 놓여 있었기 때문입니다.</p>\n<h1>요약</h1>\n<p>우리는 nannyML이 소매 판매 예측을 위해 실제 월마트 데이터에 적용되는 방법을 탐색했습니다. 소비자 행동과 시장 트렌드의 변화에 대한 도전을 극복했습니다.</p>\n<p>모델 모니터링의 중요성을 배웠지만, 효과적인 모니터링을 방해할 수있는 잘못된 경고 문제도 배웠습니다.</p>\n<!-- TIL 수평 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"1549334788\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>여기까지 오셨다면, NannyML의 문서를 살펴보시고 여러 사용 사례에서 어떻게 혜택을 받을 수 있는지 확인하는 것을 강력히 추천합니다. 더 많은 정보를 원하신다면 그들의 웹사이트도 방문해보세요.</p>\n</body>\n</html>\n"},"__N_SSG":true}